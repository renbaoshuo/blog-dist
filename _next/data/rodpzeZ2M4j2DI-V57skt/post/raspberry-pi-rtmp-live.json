{"pageProps":{"title":"使用树莓派+Nginx搭建 Rtmp 直播服务 - 宝硕博客","post":{"title":"使用树莓派+Nginx搭建 Rtmp 直播服务","excerpt":"国庆在家闲着没啥事，把一直在角落里吃灰的树莓派 4B 拿出来捣鼓了几下。","content":[["$","p",{},["国庆在家闲着没啥事，把一直在角落里吃灰的树莓派 4B 拿出来捣鼓了几下。"]],["$","span",{"id":"more"},[]],["$","p",{},["使用 nginx 模块：",["$","a",{"href":"https://github.com/arut/nginx-rtmp-module","rel":"external nofollow noreferrer"},[["$","code",{},["nginx-rtmp-module"]]]]]],["$","h2",{"id":"安装-nginx-nginx-rtmp-module"},["安装 nginx & nginx-rtmp-module"]],["$","p",{},["apt, yes!"]],["$","pre",{},[["$","code",{"class":"hljs bash"},["apt update\napt upgrade -y\napt install nginx libnginx-mod-rtmp -y"]]]],["$","p",{},["访问服务器 IP ，出现如下图所示网页即代表安装成功。"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/BdKOhDuxIaYks6q.png","alt":"","loading":"lazy"},[]]]],["$","h2",{"id":"修改-nginx-配置"},["修改 nginx 配置"]],["$","p",{},["打开 ",["$","code",{},["/etc/nginx/nginx.conf"]]," ，在末尾处插入下面的配置"]],["$","pre",{},[["$","code",{"class":"hljs nginx"},[["$","span",{"class":"hljs-section"},["rtmp"]]," {\n    ",["$","span",{"class":"hljs-section"},["server"]]," {\n        ",["$","span",{"class":"hljs-attribute"},["listen"]],"     ",["$","span",{"class":"hljs-number"},["1935"]],";              ",["$","span",{"class":"hljs-comment"},["# 服务端口"]],"\n        ",["$","span",{"class":"hljs-attribute"},["chunk_size"]]," ",["$","span",{"class":"hljs-number"},["4096"]],";              ",["$","span",{"class":"hljs-comment"},["# 数据传输块的大小"]],"\n\n        ",["$","span",{"class":"hljs-attribute"},["application"]]," vod {\n            ",["$","span",{"class":"hljs-attribute"},["play"]]," /opt/video;          ",["$","span",{"class":"hljs-comment"},["# 视频文件存放位置。"]],"\n        }\n\n        ",["$","span",{"class":"hljs-attribute"},["application"]]," rtmplive {\n            ",["$","span",{"class":"hljs-attribute"},["live"]],"            ",["$","span",{"class":"hljs-literal"},["on"]],";        ",["$","span",{"class":"hljs-comment"},["# 开启直播"]],"\n            ",["$","span",{"class":"hljs-attribute"},["max_connections"]]," ",["$","span",{"class":"hljs-number"},["64"]],";        ",["$","span",{"class":"hljs-comment"},["# 为 rtmp 引擎设置最大连接数。默认为 off"]],"\n        }\n\n        ",["$","span",{"class":"hljs-attribute"},["application"]]," live {\n            ",["$","span",{"class":"hljs-attribute"},["live"]],"                ",["$","span",{"class":"hljs-literal"},["on"]],";              ",["$","span",{"class":"hljs-comment"},["# 开启直播"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls"]],"                 ",["$","span",{"class":"hljs-literal"},["on"]],";              ",["$","span",{"class":"hljs-comment"},["# 这个参数把直播服务器改造成实时回放服务器。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["wait_key"]],"            ",["$","span",{"class":"hljs-literal"},["on"]],";              ",["$","span",{"class":"hljs-comment"},["# 对视频切片进行保护，这样就不会产生马赛克了。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_path"]],"            /opt/video/hls;  ",["$","span",{"class":"hljs-comment"},["# 切片视频文件存放位置。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_fragment"]],"        ",["$","span",{"class":"hljs-number"},["10s"]],";             ",["$","span",{"class":"hljs-comment"},["# 设置HLS片段长度。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_max_fragment"]],"    ",["$","span",{"class":"hljs-number"},["10s"]],";             ",["$","span",{"class":"hljs-comment"},["# 设置HLS片段最大长度。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_playlist_length"]]," ",["$","span",{"class":"hljs-number"},["30s"]],";             ",["$","span",{"class":"hljs-comment"},["# 设置HLS播放列表长度。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_continuous"]],"      ",["$","span",{"class":"hljs-literal"},["on"]],";              ",["$","span",{"class":"hljs-comment"},["# 连续模式。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_cleanup"]],"         ",["$","span",{"class":"hljs-literal"},["on"]],";              ",["$","span",{"class":"hljs-comment"},["# 对多余的切片进行删除。"]],"\n            ",["$","span",{"class":"hljs-attribute"},["hls_nested"]],"          ",["$","span",{"class":"hljs-literal"},["on"]],";              ",["$","span",{"class":"hljs-comment"},["# 嵌套模式。"]],"\n        }\n    }\n}"]]]],["$","p",{},["打开默认站点配置文件 ",["$","code",{},["/etc/nginx/sites-available/default"]]," ，在 ",["$","code",{},["server"]]," 部分的末尾添加以下内容"]],["$","pre",{},[["$","code",{"class":"hljs nginx"},[["$","span",{"class":"hljs-section"},["location"]]," /live {\n    ",["$","span",{"class":"hljs-section"},["types"]]," {\n        application/vnd.apple.",["$","span",{"class":"hljs-attribute"},["mpegurl"]]," m3u8;\n        video/",["$","span",{"class":"hljs-attribute"},["mp2t"]],"                    ts;\n    }\n\n    ",["$","span",{"class":"hljs-attribute"},["autoindex"]]," ",["$","span",{"class":"hljs-literal"},["on"]],";\n    ",["$","span",{"class":"hljs-attribute"},["alias"]],"     /opt/video/hls;\n\n    ",["$","span",{"class":"hljs-attribute"},["expires"]]," -",["$","span",{"class":"hljs-number"},["1"]],";\n\n    ",["$","span",{"class":"hljs-attribute"},["add_header"]]," ",["$","span",{"class":"hljs-string"},["'Cache-Control'"]],"                    ",["$","span",{"class":"hljs-string"},["'no-cache'"]],";\n    ",["$","span",{"class":"hljs-attribute"},["add_header"]]," ",["$","span",{"class":"hljs-string"},["'Access-Control-Allow-Origin'"]],"      ",["$","span",{"class":"hljs-string"},["'*'"]],";\n    ",["$","span",{"class":"hljs-attribute"},["add_header"]]," ",["$","span",{"class":"hljs-string"},["'Access-Control-Allow-Credentials'"]]," ",["$","span",{"class":"hljs-string"},["'true'"]],";\n    ",["$","span",{"class":"hljs-attribute"},["add_header"]]," ",["$","span",{"class":"hljs-string"},["'Access-Control-Allow-Methods'"]],"     ",["$","span",{"class":"hljs-string"},["'GET, POST, OPTIONS'"]],";\n    ",["$","span",{"class":"hljs-attribute"},["add_header"]]," ",["$","span",{"class":"hljs-string"},["'Access-Control-Allow-Headers'"]],"     ",["$","span",{"class":"hljs-string"},["'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'"]],";\n}\n",["$","span",{"class":"hljs-section"},["location"]]," /stat {\n    ",["$","span",{"class":"hljs-attribute"},["rtmp_stat"]]," all;\n    ",["$","span",{"class":"hljs-comment"},["# rtmp_stat_stylesheet stat.xsl;"]],"\n}"]]]],["$","p",{},["插入完以后配置文件会变成下面的样子"]],["$","pre",{},[["$","code",{"class":"hljs diff"},[["$","span",{"class":"hljs-comment"},["--- /etc/nginx/sites-available/default"]],"\n",["$","span",{"class":"hljs-comment"},["+++ /etc/nginx/sites-available/default"]],"\n",["$","span",{"class":"hljs-meta"},["@@ -1,14 +1,36 @@"]],"\n server {\n     listen 80 default_server;\n     listen [::]:80 default_server;\n\n     root /var/www/html;\n\n     index index.html index.htm index.nginx-debian.html;\n\n     server_name _;\n\n     location / {\n         try_files $uri $uri/ =404;\n     }\n",["$","span",{"class":"hljs-addition"},["+"]],"\n",["$","span",{"class":"hljs-addition"},["+    location /live {"]],"\n",["$","span",{"class":"hljs-addition"},["+        types {"]],"\n",["$","span",{"class":"hljs-addition"},["+            application/vnd.apple.mpegurl m3u8;"]],"\n",["$","span",{"class":"hljs-addition"},["+            video/mp2t                    ts;"]],"\n",["$","span",{"class":"hljs-addition"},["+        }"]],"\n",["$","span",{"class":"hljs-addition"},["+"]],"\n",["$","span",{"class":"hljs-addition"},["+        autoindex on;"]],"\n",["$","span",{"class":"hljs-addition"},["+        alias     /opt/video/hls;"]],"\n",["$","span",{"class":"hljs-addition"},["+"]],"\n",["$","span",{"class":"hljs-addition"},["+        expires -1;"]],"\n",["$","span",{"class":"hljs-addition"},["+"]],"\n",["$","span",{"class":"hljs-addition"},["+        add_header 'Cache-Control'                    'no-cache';"]],"\n",["$","span",{"class":"hljs-addition"},["+        add_header 'Access-Control-Allow-Origin'      '*';"]],"\n",["$","span",{"class":"hljs-addition"},["+        add_header 'Access-Control-Allow-Credentials' 'true';"]],"\n",["$","span",{"class":"hljs-addition"},["+        add_header 'Access-Control-Allow-Methods'     'GET, POST, OPTIONS';"]],"\n",["$","span",{"class":"hljs-addition"},["+        add_header 'Access-Control-Allow-Headers'     'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';"]],"\n",["$","span",{"class":"hljs-addition"},["+    }"]],"\n",["$","span",{"class":"hljs-addition"},["+    location /stat {"]],"\n",["$","span",{"class":"hljs-addition"},["+        rtmp_stat all;"]],"\n",["$","span",{"class":"hljs-addition"},["+        # rtmp_stat_stylesheet stat.xsl;"]],"\n",["$","span",{"class":"hljs-addition"},["+    }"]],"\n }"]]]],["$","p",{},["修改完成后使用 ",["$","code",{},["nginx -t"]]," 测试配置文件是否正确"]],["$","pre",{},[["$","code",{"class":"hljs vim"},["nginx: the configuration ",["$","span",{"class":"hljs-keyword"},["file"]]," /etc/nginx/nginx.",["$","span",{"class":"hljs-keyword"},["conf"]]," ",["$","span",{"class":"hljs-keyword"},["syntax"]]," ",["$","span",{"class":"hljs-keyword"},["is"]]," ok\nnginx: configuration ",["$","span",{"class":"hljs-keyword"},["file"]]," /etc/nginx/nginx.",["$","span",{"class":"hljs-keyword"},["conf"]]," test ",["$","span",{"class":"hljs-keyword"},["is"]]," successful"]]]],["$","p",{},["当出现成功提示时，使用 ",["$","code",{},["nginx -s reload"]]," 平滑重启 nginx。"]],["$","p",{},["重启成功后使用 ",["$","code",{},["netstat -lnp"]]," 查看 ",["$","code",{},["tcp/1935"]]," 端口是否开启。"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/Xy3Nq5WZaogLIvR.png","alt":"","loading":"lazy"},[]]]],["$","h2",{"id":"使用-obs-连接直播服务器"},["使用 OBS 连接直播服务器"]],["$","p",{},["打开 OBS ，在 设置 -> 推流 中配置以下内容"]],["$","table",{},[["$","thead",{},[["$","tr",{},[["$","th",{},["项目"]],["$","th",{},["值"]]]]]],["$","tbody",{},[["$","tr",{},[["$","td",{},["服务"]],["$","td",{},[["$","code",{},["自定义..."]]]]]],["$","tr",{},[["$","td",{},["服务器"]],["$","td",{},[["$","code",{},["rtmp://${ip}/live"]]]]]],["$","tr",{},[["$","td",{},["串流密钥"]],["$","td",{},[["$","code",{},["${key}"]]]]]]]]]],["$","p",{},["其中，",["$","code",{},["${ip}"]]," 和 ",["$","code",{},["${key}"]]," 设置为你需要的值即可。"]],["$","p",{},["回到主界面，点击 ",["$","strong",{},["开始推流"]]," 进行推流。"]],["$","h2",{"id":"使用客户端拉取直播流"},["使用客户端拉取直播流"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/jpqVTAgXSW6oyEP.png","alt":"","loading":"lazy"},[]]]],["$","p",{},["在 ",["$","code",{},["PotPlayer"]]," ",["$","code",{},["QQ影音"]]," 等播放器中选择 ",["$","code",{},["打开->打开URL"]]," 。"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/rzBNukVTntf5xUR.png","alt":"","loading":"lazy"},[]]]],["$","p",{},["输入 ",["$","code",{},["http://${ip}/live/${key}/index.m3u8"]]," ，点击确定。"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/crbEBQNC3qH8uOl.jpg","alt":"","loading":"lazy"},[]]]],["$","p",{},["此时可以就看到直播画面了。"]],["$","h2",{"id":"网页端播放"},["网页端播放"]],["$","p",{},["页面中只有一个播放器，其他功能请自行实现。"]],["$","pre",{},[["$","code",{"class":"hljs xml"},[["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["html"]],">"]],"\n\n",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["head"]],">"]],"\n    ",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["title"]],">"]],"Live Player",["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["title"]],">"]],"\n    ",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["meta"]]," ",["$","span",{"class":"hljs-attr"},["charset"]],"=",["$","span",{"class":"hljs-string"},["\"UTF-8\""]],">"]],"\n",["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["head"]],">"]],"\n\n",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["body"]],">"]],"\n    ",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["div"]]," ",["$","span",{"class":"hljs-attr"},["id"]],"=",["$","span",{"class":"hljs-string"},["\"dplayer\""]],">"]],["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["div"]],">"]],"\n    ",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["script"]]," ",["$","span",{"class":"hljs-attr"},["src"]],"=",["$","span",{"class":"hljs-string"},["\"https://cdn.jsdelivr.net/npm/hls.js@0.14.13/dist/hls.min.js\""]],">"]],["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["script"]],">"]],"\n    ",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["script"]]," ",["$","span",{"class":"hljs-attr"},["src"]],"=",["$","span",{"class":"hljs-string"},["\"https://cdn.jsdelivr.net/npm/dplayer@1.26.0/dist/DPlayer.min.js\""]],">"]],["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["script"]],">"]],"\n    ",["$","span",{"class":"hljs-tag"},["<",["$","span",{"class":"hljs-name"},["script"]],">"]],["$","span",{"class":"language-javascript"},[]],"\n",["$","span",{"class":"language-javascript"},["        ",["$","span",{"class":"hljs-keyword"},["const"]]," dp = ",["$","span",{"class":"hljs-keyword"},["new"]]," ",["$","span",{"class":"hljs-title class_"},["DPlayer"]],"({"]],"\n",["$","span",{"class":"language-javascript"},["            ",["$","span",{"class":"hljs-attr"},["container"]],": ",["$","span",{"class":"hljs-variable language_"},["document"]],".",["$","span",{"class":"hljs-title function_"},["getElementById"]],"(",["$","span",{"class":"hljs-string"},["'dplayer'"]],"),"]],"\n",["$","span",{"class":"language-javascript"},["            ",["$","span",{"class":"hljs-attr"},["live"]],": ",["$","span",{"class":"hljs-literal"},["true"]],","]],"\n",["$","span",{"class":"language-javascript"},["            ",["$","span",{"class":"hljs-attr"},["video"]],": {"]],"\n",["$","span",{"class":"language-javascript"},["                ",["$","span",{"class":"hljs-attr"},["url"]],": ",["$","span",{"class":"hljs-string"},["'http://${ip}/live/${key}/index.m3u8'"]],","]],"\n",["$","span",{"class":"language-javascript"},["                ",["$","span",{"class":"hljs-attr"},["type"]],": ",["$","span",{"class":"hljs-string"},["'hls'"]],","]],"\n",["$","span",{"class":"language-javascript"},["            },"]],"\n",["$","span",{"class":"language-javascript"},["        });"]],"\n",["$","span",{"class":"language-javascript"},["    "]],["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["script"]],">"]],"\n",["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["body"]],">"]],"\n\n",["$","span",{"class":"hljs-tag"},["</",["$","span",{"class":"hljs-name"},["html"]],">"]]]]]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/9X6mUtF4fLzdaYn.jpg","alt":"","loading":"lazy"},[]]]],["$","h2",{"id":"后记"},["后记"]],["$","p",{},["如果没有在外直播的需求，不要将 rtmp 端口映射至公网，这可能会带来一些不必要的麻烦。"]],["$","h2",{"id":"参考资料"},["参考资料"]],["$","ol",{},[["$","li",{},[["$","a",{"href":"https://github.com/arut/nginx-rtmp-module","rel":"external nofollow noreferrer"},["NGINX-based Media Streaming Server"]]]]]]],"thumb":null,"date":"2020-10-05","updated":"2020-10-05","isoDate":"2020-10-05T13:35:32.000Z","isoUpdate":"2020-10-05T13:35:32.000Z","categories":[{"name":"技术向","url":"/categories/%E6%8A%80%E6%9C%AF%E5%90%91/"}],"tags":[{"name":"nginx","url":"/tags/nginx/"},{"name":"树莓派","url":"/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/"},{"name":"直播","url":"/tags/%E7%9B%B4%E6%92%AD/"}],"license":null,"permalink":"https://blog.baoshuo.ren/post/raspberry-pi-rtmp-live/","url":"/post/raspberry-pi-rtmp-live/","prev":{"title":"Bilibili 1024 节 CTF Write Up","url":"/post/bilibili-1024-ctf-write-up/"},"next":{"title":"给腾讯云服务器免费增加第二个 IP","url":"/post/tencent-cloud-cvm-dual-ip/"},"toc":{"0":{"text":"安装 nginx &amp; nginx-rtmp-module","id":"安装-nginx-nginx-rtmp-module"},"1":{"text":"修改 nginx 配置","id":"修改-nginx-配置"},"2":{"text":"使用 OBS 连接直播服务器","id":"使用-obs-连接直播服务器"},"3":{"text":"使用客户端拉取直播流","id":"使用客户端拉取直播流"},"4":{"text":"网页端播放","id":"网页端播放"},"5":{"text":"后记","id":"后记"},"6":{"text":"参考资料","id":"参考资料"}},"hasToc":true,"comments":true,"wordCount":"992 字"}},"__N_SSG":true}