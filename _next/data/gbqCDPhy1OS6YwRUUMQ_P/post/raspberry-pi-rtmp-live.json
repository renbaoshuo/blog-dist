{"pageProps":{"title":"使用树莓派+nginx搭建 rtmp 直播服务 - 宝硕博客","post":{"title":"使用树莓派+nginx搭建 rtmp 直播服务","date":"2020-10-05T21:35:32.000Z","updated":"2020-10-05T21:35:32.000Z","type":"post","excerpt":"国庆在家闲着没啥事，把一直在角落里吃灰的树莓派 4B 拿出来捣鼓了几下。\n","thumb":null,"tags":["折腾"],"categories":["技术向"],"content":"<p>国庆在家闲着没啥事，把一直在角落里吃灰的树莓派 4B 拿出来捣鼓了几下。</p>\n\n<p>使用 nginx 模块：<a href=https://github.com/arut/nginx-rtmp-module target=_blank><code>nginx-rtmp-module</code></a></p>\n<h2 id=安装-nginx-nginx-rtmp-module><a class=anchor href=#安装-nginx-nginx-rtmp-module target=_blank></a>安装 nginx &amp; nginx-rtmp-module</h2>\n<p>apt, yes!</p>\n<pre><code class=\"hljs language-bash\">apt update\napt upgrade -y\napt install nginx libnginx-mod-rtmp -y\n</code></pre>\n<p>访问服务器 IP ，出现如下图所示网页即代表安装成功。</p>\n<p><img src=https://s1.baoshuo.ren/2020/11/26/BdKOhDuxIaYks6q.png alt=\"\"></p>\n<h2 id=修改-nginx-配置><a class=anchor href=#修改-nginx-配置 target=_blank></a>修改 nginx 配置</h2>\n<p>打开 <code>/etc/nginx/nginx.conf</code> ，在末尾处插入下面的配置</p>\n<pre><code class=\"hljs language-nginx\"><span class=hljs-section>rtmp</span> {\n    <span class=hljs-section>server</span> {\n        <span class=hljs-attribute>listen</span>     <span class=hljs-number>1935</span>;              <span class=hljs-comment># 服务端口</span>\n        <span class=hljs-attribute>chunk_size</span> <span class=hljs-number>4096</span>;              <span class=hljs-comment># 数据传输块的大小</span>\n\n        <span class=hljs-attribute>application</span> vod {\n            <span class=hljs-attribute>play</span> /opt/video;          <span class=hljs-comment># 视频文件存放位置。</span>\n        }\n\n        <span class=hljs-attribute>application</span> rtmplive {\n            <span class=hljs-attribute>live</span>            <span class=hljs-literal>on</span>;        <span class=hljs-comment># 开启直播</span>\n            <span class=hljs-attribute>max_connections</span> <span class=hljs-number>64</span>;        <span class=hljs-comment># 为 rtmp 引擎设置最大连接数。默认为 off</span>\n        }\n\n        <span class=hljs-attribute>application</span> live {\n            <span class=hljs-attribute>live</span>                <span class=hljs-literal>on</span>;              <span class=hljs-comment># 开启直播</span>\n            <span class=hljs-attribute>hls</span>                 <span class=hljs-literal>on</span>;              <span class=hljs-comment># 这个参数把直播服务器改造成实时回放服务器。</span>\n            <span class=hljs-attribute>wait_key</span>            <span class=hljs-literal>on</span>;              <span class=hljs-comment># 对视频切片进行保护，这样就不会产生马赛克了。</span>\n            <span class=hljs-attribute>hls_path</span>            /opt/video/hls;  <span class=hljs-comment># 切片视频文件存放位置。</span>\n            <span class=hljs-attribute>hls_fragment</span>        <span class=hljs-number>10s</span>;             <span class=hljs-comment># 设置HLS片段长度。</span>\n            <span class=hljs-attribute>hls_max_fragment</span>    <span class=hljs-number>10s</span>;             <span class=hljs-comment># 设置HLS片段最大长度。</span>\n            <span class=hljs-attribute>hls_playlist_length</span> <span class=hljs-number>30s</span>;             <span class=hljs-comment># 设置HLS播放列表长度。</span>\n            <span class=hljs-attribute>hls_continuous</span>      <span class=hljs-literal>on</span>;              <span class=hljs-comment># 连续模式。</span>\n            <span class=hljs-attribute>hls_cleanup</span>         <span class=hljs-literal>on</span>;              <span class=hljs-comment># 对多余的切片进行删除。</span>\n            <span class=hljs-attribute>hls_nested</span>          <span class=hljs-literal>on</span>;              <span class=hljs-comment># 嵌套模式。</span>\n        }\n    }\n}\n</code></pre>\n<p>打开默认站点配置文件 <code>/etc/nginx/sites-available/default</code> ，在 <code>server</code> 部分的末尾添加以下内容</p>\n<pre><code class=\"hljs language-nginx\"><span class=hljs-section>location</span> /live {\n    <span class=hljs-section>types</span> {\n        application/vnd.apple.<span class=hljs-attribute>mpegurl</span> m3u8;\n        video/<span class=hljs-attribute>mp2t</span>                    ts;\n    }\n\n    <span class=hljs-attribute>autoindex</span> <span class=hljs-literal>on</span>;\n    <span class=hljs-attribute>alias</span>     /opt/video/hls;\n\n    <span class=hljs-attribute>expires</span> -<span class=hljs-number>1</span>;\n\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Cache-Control&#x27;</span>                    <span class=hljs-string>&#x27;no-cache&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Origin&#x27;</span>      <span class=hljs-string>&#x27;*&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class=hljs-string>&#x27;true&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Methods&#x27;</span>     <span class=hljs-string>&#x27;GET, POST, OPTIONS&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Headers&#x27;</span>     <span class=hljs-string>&#x27;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;</span>;\n}\n<span class=hljs-section>location</span> /stat {\n    <span class=hljs-attribute>rtmp_stat</span> all;\n    <span class=hljs-comment># rtmp_stat_stylesheet stat.xsl;</span>\n}\n</code></pre>\n<p>插入完以后配置文件会变成下面的样子</p>\n<pre><code class=\"hljs language-diff\"><span class=hljs-comment>--- /etc/nginx/sites-available/default</span>\n<span class=hljs-comment>+++ /etc/nginx/sites-available/default</span>\n<span class=hljs-meta>@@ -1,14 +1,36 @@</span>\n server {\n     listen 80 default_server;\n     listen [::]:80 default_server;\n\n     root /var/www/html;\n\n     index index.html index.htm index.nginx-debian.html;\n\n     server_name _;\n\n     location / {\n         try_files $uri $uri/ =404;\n     }\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+    location /live {</span>\n<span class=hljs-addition>+        types {</span>\n<span class=hljs-addition>+            application/vnd.apple.mpegurl m3u8;</span>\n<span class=hljs-addition>+            video/mp2t                    ts;</span>\n<span class=hljs-addition>+        }</span>\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+        autoindex on;</span>\n<span class=hljs-addition>+        alias     /opt/video/hls;</span>\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+        expires -1;</span>\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+        add_header &#x27;Cache-Control&#x27;                    &#x27;no-cache&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Origin&#x27;      &#x27;*&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Methods&#x27;     &#x27;GET, POST, OPTIONS&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Headers&#x27;     &#x27;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;;</span>\n<span class=hljs-addition>+    }</span>\n<span class=hljs-addition>+    location /stat {</span>\n<span class=hljs-addition>+        rtmp_stat all;</span>\n<span class=hljs-addition>+        # rtmp_stat_stylesheet stat.xsl;</span>\n<span class=hljs-addition>+    }</span>\n }\n</code></pre>\n<p>修改完成后使用 <code>nginx -t</code> 测试配置文件是否正确</p>\n<pre><code class=hljs>nginx: the configuration <span class=hljs-keyword>file</span> /etc/nginx/nginx.<span class=hljs-keyword>conf</span> <span class=hljs-keyword>syntax</span> <span class=hljs-keyword>is</span> ok\nnginx: configuration <span class=hljs-keyword>file</span> /etc/nginx/nginx.<span class=hljs-keyword>conf</span> test <span class=hljs-keyword>is</span> successful\n</code></pre>\n<p>当出现成功提示时，使用 <code>nginx -s reload</code> 平滑重启 nginx。</p>\n<p>重启成功后使用 <code>netstat -lnp</code> 查看 <code>tcp/1935</code> 端口是否开启。</p>\n<p><img src=https://s1.baoshuo.ren/2020/11/26/Xy3Nq5WZaogLIvR.png alt=\"\"></p>\n<h2 id=使用-obs-连接直播服务器><a class=anchor href=#使用-obs-连接直播服务器 target=_blank></a>使用 OBS 连接直播服务器</h2>\n<p>打开 OBS ，在 设置 -&gt; 推流 中配置以下内容</p>\n<table>\n<thead>\n<tr>\n<th>项目</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>服务</td>\n<td><code>自定义...</code></td>\n</tr>\n<tr>\n<td>服务器</td>\n<td><code>rtmp://${ip}/live</code></td>\n</tr>\n<tr>\n<td>串流密钥</td>\n<td><code>${key}</code></td>\n</tr>\n</tbody>\n</table>\n<p>其中，<code>${ip}</code> 和 <code>${key}</code> 设置为你需要的值即可。</p>\n<p>回到主界面，点击 <strong>开始推流</strong> 进行推流。</p>\n<h2 id=使用客户端拉取直播流><a class=anchor href=#使用客户端拉取直播流 target=_blank></a>使用客户端拉取直播流</h2>\n<p><img src=https://s1.baoshuo.ren/2020/11/26/jpqVTAgXSW6oyEP.png alt=\"\"></p>\n<p>在 <code>PotPlayer</code> <code>QQ影音</code> 等播放器中选择 <code>打开-&gt;打开URL</code> 。</p>\n<p><img src=https://s1.baoshuo.ren/2020/11/26/rzBNukVTntf5xUR.png alt=\"\"></p>\n<p>输入 <code>http://${ip}/live/${key}/index.m3u8</code> ，点击确定。</p>\n<p><img src=https://s1.baoshuo.ren/2020/11/26/crbEBQNC3qH8uOl.jpg alt=\"\"></p>\n<p>此时可以就看到直播画面了。</p>\n<h2 id=网页端播放><a class=anchor href=#网页端播放 target=_blank></a>网页端播放</h2>\n<p>页面中只有一个播放器，其他功能请自行实现。</p>\n<pre><code class=hljs><span class=hljs-tag>&lt;<span class=hljs-name>html</span>&gt;</span>\n\n<span class=hljs-tag>&lt;<span class=hljs-name>head</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>title</span>&gt;</span>Live Player<span class=hljs-tag>&lt;/<span class=hljs-name>title</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>meta</span> <span class=hljs-attr>charset</span>=<span class=hljs-string>&quot;UTF-8&quot;</span>&gt;</span>\n<span class=hljs-tag>&lt;/<span class=hljs-name>head</span>&gt;</span>\n\n<span class=hljs-tag>&lt;<span class=hljs-name>body</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>div</span> <span class=hljs-attr>id</span>=<span class=hljs-string>&quot;dplayer&quot;</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>div</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>src</span>=<span class=hljs-string>&quot;https://cdn.jsdelivr.net/npm/hls.js@0.14.13/dist/hls.min.js&quot;</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>src</span>=<span class=hljs-string>&quot;https://cdn.jsdelivr.net/npm/dplayer@1.26.0/dist/DPlayer.min.js&quot;</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>script</span>&gt;</span><span class=language-javascript>\n        <span class=hljs-keyword>const</span> dp = <span class=hljs-keyword>new</span> <span class=\"hljs-title class_\">DPlayer</span>({\n            <span class=hljs-attr>container</span>: <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=hljs-string>&#x27;dplayer&#x27;</span>),\n            <span class=hljs-attr>live</span>: <span class=hljs-literal>true</span>,\n            <span class=hljs-attr>video</span>: {\n                <span class=hljs-attr>url</span>: <span class=hljs-string>&#x27;http://${ip}/live/${key}/index.m3u8&#x27;</span>,\n                <span class=hljs-attr>type</span>: <span class=hljs-string>&#x27;hls&#x27;</span>,\n            },\n        });\n    </span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span>\n<span class=hljs-tag>&lt;/<span class=hljs-name>body</span>&gt;</span>\n\n<span class=hljs-tag>&lt;/<span class=hljs-name>html</span>&gt;</span>\n</code></pre>\n<p><img src=https://s1.baoshuo.ren/2020/11/26/9X6mUtF4fLzdaYn.jpg alt=\"\"></p>\n<h2 id=后记><a class=anchor href=#后记 target=_blank></a>后记</h2>\n<p>如果没有在外直播的需求，不要将 rtmp 端口映射至公网，这可能会带来一些不必要的麻烦。</p>\n<h2 id=参考资料><a class=anchor href=#参考资料 target=_blank></a>参考资料</h2>\n<ol>\n<li><a href=https://github.com/arut/nginx-rtmp-module target=_blank>NGINX-based Media Streaming Server</a></li>\n</ol>\n","katex":false,"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-nginx-nginx-rtmp-module\"><span class=\"toc-text\">安装 nginx &amp; nginx-rtmp-module</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BF%AE%E6%94%B9-nginx-%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">修改 nginx 配置</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-obs-%E8%BF%9E%E6%8E%A5%E7%9B%B4%E6%92%AD%E6%9C%8D%E5%8A%A1%E5%99%A8\"><span class=\"toc-text\">使用 OBS 连接直播服务器</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8B%89%E5%8F%96%E7%9B%B4%E6%92%AD%E6%B5%81\"><span class=\"toc-text\">使用客户端拉取直播流</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BD%91%E9%A1%B5%E7%AB%AF%E6%92%AD%E6%94%BE\"><span class=\"toc-text\">网页端播放</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%90%8E%E8%AE%B0\"><span class=\"toc-text\">后记</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\"><span class=\"toc-text\">参考资料</span></a></li></ol>","comment":true,"path":"/post/raspberry-pi-rtmp-live/","url":"https://blog.baoshuo.ren/post/raspberry-pi-rtmp-live/"},"__post":true},"__N_SSG":true}