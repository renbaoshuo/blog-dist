{"pageProps":{"title":"搭建 BIRD Looking Glass 速成指北 - 宝硕博客","post":{"title":"搭建 BIRD Looking Glass 速成指北","date":"2021-05-03T12:23:00.000Z","updated":"2021-05-03T12:23:00.000Z","type":"post","excerpt":"BIRD 是 Linux 上常用的一款 BGP 路由软件。bird-lg-go 是 蓝天 使用 Go 语言编写的 Looking Glass 程序，内存占用比原版 bird-lg 更低。它提供了一个网页面板，可以显示各个服务器上的 BIRD 路由软件的状态，以及查询到指定 IP 的路由。\n","thumb":null,"tags":["BIRD","BGP","DN42"],"categories":["技术向"],"content":"<p>BIRD 是 Linux 上常用的一款 BGP 路由软件。bird-lg-go 是 <a href=https://lantian.pub target=_blank>蓝天</a> 使用 Go 语言编写的 Looking Glass 程序，内存占用比原版 bird-lg 更低。它提供了一个网页面板，可以显示各个服务器上的 BIRD 路由软件的状态，以及查询到指定 IP 的路由。</p>\n\n<ul>\n<li>项目地址：<a href=https://github.com/xddxdd/bird-lg-go target=_blank>https://github.com/xddxdd/bird-lg-go</a></li>\n<li>成品： <a href=https://lg.dn42.as141776.net target=_blank>https://lg.dn42.as141776.net</a></li>\n</ul>\n<h2 id=安装-docker-和-docker-compose><a class=anchor href=#安装-docker-和-docker-compose target=_blank></a>安装 Docker 和 Docker Compose</h2>\n<p>虽然这个程序可以直接运行，但我还是比较喜欢套个 Docker 防止污染环境。</p>\n<pre><code class=\"hljs language-bash\">curl -sSL https://get.docker.com | sh\npip install docker-compose\n</code></pre>\n<h2 id=编排-docker-compose-服务><a class=anchor href=#编排-docker-compose-服务 target=_blank></a>编排 Docker Compose 服务</h2>\n<p>在运行 web 的服务器上找个地方（如 <code>/var/bird-lg/</code>），将下面的内容修改后写入 <code>docker-compose.yml</code> 中：</p>\n<pre><code class=\"hljs language-yml\"><span class=hljs-attr>version:</span> <span class=hljs-string>&#x27;3&#x27;</span>\n\n<span class=hljs-attr>services:</span>\n  <span class=hljs-attr>bird-lg:</span>\n    <span class=hljs-attr>image:</span> <span class=hljs-string>xddxdd/bird-lg-go</span>\n    <span class=hljs-attr>container_name:</span> <span class=hljs-string>bird-lg</span>\n    <span class=hljs-attr>restart:</span> <span class=hljs-string>always</span>\n    <span class=hljs-attr>environment:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>BIRDLG_SERVERS=cn1,eu1</span> <span class=hljs-comment># 节点列表，以逗号分隔</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>BIRDLG_DOMAIN=dn42.as141776.net</span> <span class=hljs-comment># 节点 endpiont 后缀</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>BIRDLG_TITLE_BRAND=Looking</span> <span class=hljs-string>Glass</span> <span class=hljs-comment># 标签栏上显示的名称</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>BIRDLG_NAVBAR_BRAND=Looking</span> <span class=hljs-string>Glass</span> <span class=hljs-comment># 页面上显示的名称</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>BIRDLG_WHOIS=whois.lantian.dn42</span> <span class=hljs-comment># Whois 服务器地址</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>BIRDLG_DNS_INTERFACE=asn.dn42</span>\n    <span class=hljs-attr>ports:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>&#x27;5000:5000&#x27;</span>\n  <span class=hljs-attr>bird-lgproxy:</span>\n    <span class=hljs-attr>image:</span> <span class=hljs-string>xddxdd/bird-lgproxy-go</span>\n    <span class=hljs-attr>container_name:</span> <span class=hljs-string>bird-lgproxy</span>\n    <span class=hljs-attr>restart:</span> <span class=hljs-string>always</span>\n    <span class=hljs-attr>volumes:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>&#x27;/var/run/bird/bird.ctl:/var/run/bird/bird.ctl&#x27;</span>\n    <span class=hljs-attr>ports:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>&#x27;8000:8000&#x27;</span>\n</code></pre>\n<p>在各个节点上只需要写入下面内容即可：</p>\n<pre><code class=\"hljs language-yml\"><span class=hljs-attr>version:</span> <span class=hljs-string>&#x27;3&#x27;</span>\n\n<span class=hljs-attr>services:</span>\n  <span class=hljs-attr>bird-lgproxy:</span>\n    <span class=hljs-attr>image:</span> <span class=hljs-string>xddxdd/bird-lgproxy-go</span>\n    <span class=hljs-attr>container_name:</span> <span class=hljs-string>bird-lgproxy</span>\n    <span class=hljs-attr>restart:</span> <span class=hljs-string>always</span>\n    <span class=hljs-attr>volumes:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>&#x27;/var/run/bird/bird.ctl:/var/run/bird/bird.ctl&#x27;</span>\n    <span class=hljs-attr>ports:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-string>&#x27;8000:8000&#x27;</span>\n</code></pre>\n<p>之后启动 Docker 容器：</p>\n<pre><code class=\"hljs language-bash\">docker-compose up -d\n</code></pre>\n<h2 id=使用-nginx-反代页面><a class=anchor href=#使用-nginx-反代页面 target=_blank></a>使用 nginx 反代页面</h2>\n<p>使用下方的配置启动反向代理即可。</p>\n<pre><code class=\"hljs language-nginx\"><span class=hljs-section>server</span> {\n    <span class=hljs-attribute>listen</span>      *:<span class=hljs-number>80</span>;\n    <span class=hljs-attribute>listen</span>      [::]:<span class=hljs-number>80</span>;\n    <span class=hljs-attribute>server_name</span> lg.dn42.as141776.net;\n\n    <span class=hljs-comment># reverse proxy</span>\n    <span class=hljs-section>location</span> / {\n        <span class=hljs-attribute>proxy_pass</span>                         http://127.0.0.1:5000;\n        <span class=hljs-attribute>proxy_http_version</span>                 <span class=hljs-number>1</span>.<span class=hljs-number>1</span>;\n        <span class=hljs-attribute>proxy_cache_bypass</span>                 <span class=hljs-variable>$http_upgrade</span>;\n\n        <span class=hljs-comment># Proxy headers</span>\n        <span class=hljs-attribute>proxy_set_header</span> Upgrade           <span class=hljs-variable>$http_upgrade</span>;\n        <span class=hljs-attribute>proxy_set_header</span> Host              <span class=hljs-variable>$host</span>;\n        <span class=hljs-attribute>proxy_set_header</span> X-Real-IP         <span class=hljs-variable>$remote_addr</span>;\n        <span class=hljs-attribute>proxy_set_header</span> X-Forwarded-For   <span class=hljs-variable>$proxy_add_x_forwarded_for</span>;\n        <span class=hljs-attribute>proxy_set_header</span> X-Forwarded-Proto <span class=hljs-variable>$scheme</span>;\n        <span class=hljs-attribute>proxy_set_header</span> X-Forwarded-Host  <span class=hljs-variable>$host</span>;\n        <span class=hljs-attribute>proxy_set_header</span> X-Forwarded-Port  <span class=hljs-variable>$server_port</span>;\n\n        <span class=hljs-comment># Proxy timeouts</span>\n        <span class=hljs-attribute>proxy_connect_timeout</span>              <span class=hljs-number>60s</span>;\n        <span class=hljs-attribute>proxy_send_timeout</span>                 <span class=hljs-number>60s</span>;\n        <span class=hljs-attribute>proxy_read_timeout</span>                 <span class=hljs-number>60s</span>;\n    }\n}\n</code></pre>\n<h2 id=配置-dns-解析><a class=anchor href=#配置-dns-解析 target=_blank></a>配置 DNS 解析</h2>\n<p>bird-lg-go 的节点 endpiont 生成逻辑是 <code>http://[节点].[endpoint后缀]:8000</code> ，如 <code>http://eu1.dn42.as141776.net:8000</code> ，所以只需要去配置对应的解析。</p>\n<blockquote>\n<p><strong>警告</strong></p>\n<p>建议解析到节点的公网 IP 上，以免 DN42 炸掉时 Looking Glass 也一并炸掉。</p>\n</blockquote>\n<p>配置示例：</p>\n<pre><code class=hljs>eu1<span class=hljs-selector-class>.dn42</span><span class=hljs-selector-class>.as141776</span><span class=hljs-selector-class>.net</span>.  <span class=hljs-number>3600</span>    IN      A       <span class=hljs-number>136.243</span>.<span class=hljs-number>221.96</span>\ncn1<span class=hljs-selector-class>.dn42</span><span class=hljs-selector-class>.as141776</span><span class=hljs-selector-class>.net</span>.  <span class=hljs-number>3600</span>    IN      CNAME   home<span class=hljs-selector-class>.baoshuo</span><span class=hljs-selector-class>.ren</span>.\n</code></pre>\n<h2 id=成果><a class=anchor href=#成果 target=_blank></a>成果</h2>\n<p><img src=https://s1.baoshuo.ren/2021/05/03/iaFfTWAhpdZGJ9t.png alt=\"\"></p>\n","katex":false,"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-docker-%E5%92%8C-docker-compose\"><span class=\"toc-text\">安装 Docker 和 Docker Compose</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%96%E6%8E%92-docker-compose-%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">编排 Docker Compose 服务</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-nginx-%E5%8F%8D%E4%BB%A3%E9%A1%B5%E9%9D%A2\"><span class=\"toc-text\">使用 nginx 反代页面</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE-dns-%E8%A7%A3%E6%9E%90\"><span class=\"toc-text\">配置 DNS 解析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%88%90%E6%9E%9C\"><span class=\"toc-text\">成果</span></a></li></ol>","comment":true,"path":"/post/bird-looking-glass/","url":"https://blog.baoshuo.ren/post/bird-looking-glass/"},"__post":true},"__N_SSG":true}