{"pageProps":{"title":"你好，2021 —— 博客迁移记录 - 宝硕博客","post":{"title":"你好，2021 —— 博客迁移记录","date":"2021-01-01T00:00:00.000Z","updated":"2021-01-01T00:00:00.000Z","type":"post","excerpt":"再见，2020。\n","thumb":null,"tags":["折腾"],"categories":["技术向"],"content":"<p>再见，2020。</p>\n\n<p>最近总是觉得博客太慢了，于是乎，我把博客迁移到自己的服务器上面了。</p>\n<h2 id=服务器端操作><a class=anchor href=#服务器端操作 target=_blank></a>服务器端操作</h2>\n<h3 id=安装-nginx><a class=anchor href=#安装-nginx target=_blank></a>安装 nginx</h3>\n<p>apt 一把梭，省时又省力。</p>\n<pre><code class=\"hljs language-shell\">apt install nginx -y\n</code></pre>\n<h3 id=配置-nginx><a class=anchor href=#配置-nginx target=_blank></a>配置 nginx</h3>\n<p>简简单单配置了一下，没有什么过于复杂的东西。</p>\n<p>在申请 SSL 证书之前，不要写 HTTPS 的配置。</p>\n<pre><code class=\"hljs language-nginx\"><span class=hljs-section>server</span> {\n    <span class=hljs-attribute>listen</span>      <span class=hljs-number>80</span>;\n    <span class=hljs-attribute>listen</span>      [::]:<span class=hljs-number>80</span>;\n    <span class=hljs-attribute>server_name</span> blog.baoshuo.ren;\n\n    <span class=hljs-comment># ACME-challenge</span>\n    <span class=hljs-section>location</span><span class=hljs-regexp> ^~</span> /.well-known/acme-challenge/ {\n        <span class=hljs-attribute>allow</span> all;\n        <span class=hljs-attribute>root</span> /var/www/_letsencrypt;\n    }\n\n    <span class=hljs-section>location</span> / {\n        <span class=hljs-attribute>return</span> <span class=hljs-number>301</span> https://blog.baoshuo.ren<span class=hljs-variable>$request_uri</span>;\n    }\n}\n</code></pre>\n<h3 id=申请-ssl-证书><a class=anchor href=#申请-ssl-证书 target=_blank></a>申请 SSL 证书</h3>\n<p>由于笔者懒得每年换证书，所以就用了 <a href=https://letsencrypt.org/ target=_blank>Let's Encrypt</a> + <a href=https://acme.sh target=_blank>acme.sh</a> 的组合套装来配置 SSL 。\n当然，ECC 证书也是少不了的。</p>\n<pre><code class=\"hljs language-bash\">acme.sh --issue -d baoshuo.ren -d www.baoshuo.ren -d blog.baoshuo.ren \\\n    -w /var/www/_letsencrypt/ \\\n    --renew-hook <span class=hljs-string>&quot;acme.sh --install-cert -d baoshuo.ren \\\n    --key-file /***/baoshuo.ren.key \\\n    --fullchain-file /***/baoshuo.ren.cer \\\n    --reloadcmd \\&quot;service nginx force-reload\\&quot;&quot;</span>\nacme.sh --issue --keylength ec-256 \\\n    -d baoshuo.ren -d www.baoshuo.ren -d blog.baoshuo.ren \\\n    -w /var/www/_letsencrypt/ \\\n    --renew-hook <span class=hljs-string>&quot;acme.sh --install-cert -d baoshuo.ren --ecc \\\n    --key-file /***/baoshuo.ren.ecc.key \\\n    --fullchain-file /***/baoshuo.ren.ecc.cer \\\n    --reloadcmd \\&quot;service nginx force-reload\\&quot;&quot;</span>\n</code></pre>\n<p>申请完成后，将 RSA 和 ECC 证书添加到 nginx 配置中，在配置文件中写入以下内容：</p>\n<pre><code class=\"hljs language-nginx\"><span class=hljs-section>server</span> {\n    <span class=hljs-attribute>listen</span>                               <span class=hljs-number>443</span> ssl http2;\n    <span class=hljs-attribute>listen</span>                               [::]:<span class=hljs-number>443</span> ssl http2;\n    <span class=hljs-attribute>server_name</span>                          blog.baoshuo.ren;\n    <span class=hljs-attribute>root</span>                                 /var/www/blog/;\n\n    <span class=hljs-comment># SSL</span>\n    <span class=hljs-attribute>ssl_certificate</span>                      /***/baoshuo.ren.cer;\n    <span class=hljs-attribute>ssl_certificate_key</span>                  /***/baoshuo.ren.key;\n    <span class=hljs-attribute>ssl_certificate</span>                      /***/baoshuo.ren.ecc.cer;\n    <span class=hljs-attribute>ssl_certificate_key</span>                  /***/baoshuo.ren.ecc.key;\n    <span class=hljs-attribute>ssl_protocols</span>                        TLSv1.<span class=hljs-number>2</span> TLSv1.<span class=hljs-number>3</span>;\n    <span class=hljs-attribute>ssl_ciphers</span>                          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n    <span class=hljs-attribute>ssl_prefer_server_ciphers</span> <span class=hljs-literal>off</span>;\n\n    <span class=hljs-comment># HSTS</span>\n    <span class=hljs-attribute>add_header</span> Strict-Transport-Security <span class=hljs-string>&#x27;max-age=31536000&#x27;</span>;\n\n    <span class=hljs-comment># logging</span>\n    <span class=hljs-attribute>error_log</span>                            /var/log/nginx/blog.baoshuo.ren.<span class=hljs-literal>error</span>.log <span class=hljs-literal>warn</span>;\n\n    <span class=hljs-comment># 404 page</span>\n    <span class=hljs-attribute>error_page</span>                           <span class=hljs-number>404</span> /<span class=hljs-number>404</span>.html;\n}\n</code></pre>\n<p>上方使用的 SSL 配置是 Mozilla 推荐的现代化配置 ，如果需要更好的兼容性，可以使用 Mozilla 提供的中等安全性配置 ：</p>\n<pre><code class=hljs><span class=hljs-attribute>ssl_protocols</span> TLSv1 TLSv1.<span class=hljs-number>1</span> TLSv1.<span class=hljs-number>2</span> TLSv1.<span class=hljs-number>3</span>;\n<span class=hljs-attribute>ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA;\n<span class=hljs-attribute>ssl_prefer_server_ciphers</span> <span class=hljs-literal>on</span>;\n</code></pre>\n<h2 id=将博客文件同步到服务器上><a class=anchor href=#将博客文件同步到服务器上 target=_blank></a>将博客文件同步到服务器上</h2>\n<p>在 <code>.github/workflows</code> 目录下创建一个 <code>server.yml</code> 文件，写入以下内容：</p>\n<pre><code class=\"hljs language-yaml\"><span class=hljs-attr>name:</span> <span class=hljs-string>Deploy</span> <span class=hljs-string>blog</span> <span class=hljs-string>to</span> <span class=hljs-string>Server</span>\n\n<span class=hljs-attr>on:</span>\n  <span class=hljs-attr>push:</span>\n    <span class=hljs-attr>branches:</span> [ <span class=hljs-string>master</span> ]\n  <span class=hljs-attr>workflow_dispatch:</span>\n\n<span class=hljs-attr>jobs:</span>\n  <span class=hljs-attr>deploy:</span>\n    <span class=hljs-attr>runs-on:</span> <span class=hljs-string>ubuntu-latest</span>\n    <span class=hljs-attr>steps:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>Checkout</span>\n        <span class=hljs-attr>uses:</span> <span class=hljs-string>actions/checkout@v2</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>Deploy</span>\n        <span class=hljs-attr>uses:</span> <span class=hljs-string>easingthemes/ssh-deploy@v2.1.5</span>\n        <span class=hljs-attr>env:</span>\n          <span class=hljs-attr>SSH_PRIVATE_KEY:</span> <span class=hljs-string>${{</span> <span class=hljs-string>secrets.SSH_PRIVATE_KEY</span> <span class=hljs-string>}}</span>\n          <span class=hljs-attr>ARGS:</span> <span class=hljs-string>&quot;-avz --delete  --exclude &#x27;.git/*&#x27; --exclude &#x27;.github/*&#x27; --exclude &#x27;.gitlab-ci.yml&#x27; --exclude &#x27;.nojekyll&#x27;&quot;</span>\n          <span class=hljs-attr>REMOTE_HOST:</span> <span class=hljs-string>${{</span> <span class=hljs-string>secrets.REMOTE_HOST</span> <span class=hljs-string>}}</span>\n          <span class=hljs-attr>REMOTE_USER:</span> <span class=hljs-string>${{</span> <span class=hljs-string>secrets.REMOTE_USER</span> <span class=hljs-string>}}</span>\n          <span class=hljs-attr>TARGET:</span> <span class=hljs-string>${{</span> <span class=hljs-string>secrets.TARGET</span> <span class=hljs-string>}}</span>\n</code></pre>\n<p>之后在 <code>https://github.com/{username}/{repo}/settings/secrets/actions</code> 中添加四个 Secrets 。</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>REMOTE_HOST</td>\n<td>服务器 IP 地址</td>\n</tr>\n<tr>\n<td>REMOTE_USER</td>\n<td>服务器用户名</td>\n</tr>\n<tr>\n<td>SSH_PRIVATE_KEY</td>\n<td>连接到服务器的 SSH 私钥</td>\n</tr>\n<tr>\n<td>TARGET</td>\n<td>存放文件的路径</td>\n</tr>\n</tbody>\n</table>\n<p>将博客文件 push 到仓库中，就能在服务器上查看到文件了。</p>\n<h2 id=参考资料><a class=anchor href=#参考资料 target=_blank></a>参考资料</h2>\n<ol>\n<li><a href=\"https://ssl-config.mozilla.org/#server=nginx&amp;version=1.18.0&amp;config=modern&amp;openssl=1.1.1f&amp;ocsp=false&amp;guideline=5.6\" target=_blank>nginx 1.18.0, modern config, OpenSSL 1.1.1f - Mozilla SSL Configuration Generator</a></li>\n<li><a href=\"https://ssl-config.mozilla.org/#server=nginx&amp;version=1.18.0&amp;config=intermediate&amp;openssl=1.1.1f&amp;ocsp=false&amp;guideline=5.6\" target=_blank>nginx 1.18.0, intermediate config, OpenSSL 1.1.1f - Mozilla SSL Configuration Generator</a></li>\n</ol>\n","katex":false,"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">服务器端操作</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85-nginx\"><span class=\"toc-text\">安装 nginx</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE-nginx\"><span class=\"toc-text\">配置 nginx</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%94%B3%E8%AF%B7-ssl-%E8%AF%81%E4%B9%A6\"><span class=\"toc-text\">申请 SSL 证书</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%B0%86%E5%8D%9A%E5%AE%A2%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A\"><span class=\"toc-text\">将博客文件同步到服务器上</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\"><span class=\"toc-text\">参考资料</span></a></li></ol>","comment":true,"path":"/post/hello-2021/","url":"https://blog.baoshuo.ren/post/hello-2021/"},"__post":true},"__N_SSG":true}