{"pageProps":{"title":"你好，2021 —— 博客迁移记录 - 宝硕博客","post":{"title":"你好，2021 —— 博客迁移记录","excerpt":"再见，2020。","content":"<p>再见，2020。</p><span id=more></span><p>最近总是觉得博客太慢了，于是乎，我把博客迁移到自己的服务器上面了。</p><h2 id=服务器端操作>服务器端操作</h2><h3 id=安装-nginx>安装 nginx</h3><p>apt 一把梭，省时又省力。</p><pre><code class=\"hljs shell\">apt install nginx -y</code></pre><h3 id=配置-nginx>配置 nginx</h3><p>简简单单配置了一下，没有什么过于复杂的东西。</p><p>在申请 SSL 证书之前，不要写 HTTPS 的配置。</p><pre><code class=\"hljs nginx\"><span class=hljs-section>server</span> &#123;\n    <span class=hljs-attribute>listen</span>      <span class=hljs-number>80</span>;\n    <span class=hljs-attribute>listen</span>      [::]:<span class=hljs-number>80</span>;\n    <span class=hljs-attribute>server_name</span> blog.baoshuo.ren;\n\n    <span class=hljs-comment># ACME-challenge</span>\n    <span class=hljs-section>location</span><span class=hljs-regexp> ^~</span> /.well-known/acme-challenge/ &#123;\n        <span class=hljs-attribute>allow</span> all;\n        <span class=hljs-attribute>root</span> /var/www/_letsencrypt;\n    &#125;\n\n    <span class=hljs-section>location</span> / &#123;\n        <span class=hljs-attribute>return</span> <span class=hljs-number>301</span> https://blog.baoshuo.ren<span class=hljs-variable>$request_uri</span>;\n    &#125;\n&#125;</code></pre><h3 id=申请-ssl-证书>申请 SSL 证书</h3><p>由于笔者懒得每年换证书，所以就用了 <a href=https://letsencrypt.org/ rel=\"external nofollow noreferrer\">Let’s Encrypt</a> + <a href=https://acme.sh rel=\"external nofollow noreferrer\">acme.sh</a> 的组合套装来配置 SSL 。 当然，ECC 证书也是少不了的。</p><pre><code class=\"hljs bash\">acme.sh --issue -d baoshuo.ren -d www.baoshuo.ren -d blog.baoshuo.ren \\\n    -w /var/www/_letsencrypt/ \\\n    --renew-hook <span class=hljs-string>&quot;acme.sh --install-cert -d baoshuo.ren \\</span>\n<span class=hljs-string>    --key-file /***/baoshuo.ren.key \\</span>\n<span class=hljs-string>    --fullchain-file /***/baoshuo.ren.cer \\</span>\n<span class=hljs-string>    --reloadcmd \\&quot;service nginx force-reload\\&quot;&quot;</span>\nacme.sh --issue --keylength ec-256 \\\n    -d baoshuo.ren -d www.baoshuo.ren -d blog.baoshuo.ren \\\n    -w /var/www/_letsencrypt/ \\\n    --renew-hook <span class=hljs-string>&quot;acme.sh --install-cert -d baoshuo.ren --ecc \\</span>\n<span class=hljs-string>    --key-file /***/baoshuo.ren.ecc.key \\</span>\n<span class=hljs-string>    --fullchain-file /***/baoshuo.ren.ecc.cer \\</span>\n<span class=hljs-string>    --reloadcmd \\&quot;service nginx force-reload\\&quot;&quot;</span></code></pre><p>申请完成后，将 RSA 和 ECC 证书添加到 nginx 配置中，在配置文件中写入以下内容：</p><pre><code class=\"hljs nginx\"><span class=hljs-section>server</span> &#123;\n    <span class=hljs-attribute>listen</span>                               <span class=hljs-number>443</span> ssl http2;\n    <span class=hljs-attribute>listen</span>                               [::]:<span class=hljs-number>443</span> ssl http2;\n    <span class=hljs-attribute>server_name</span>                          blog.baoshuo.ren;\n    <span class=hljs-attribute>root</span>                                 /var/www/blog/;\n\n    <span class=hljs-comment># SSL</span>\n    <span class=hljs-attribute>ssl_certificate</span>                      /***/baoshuo.ren.cer;\n    <span class=hljs-attribute>ssl_certificate_key</span>                  /***/baoshuo.ren.key;\n    <span class=hljs-attribute>ssl_certificate</span>                      /***/baoshuo.ren.ecc.cer;\n    <span class=hljs-attribute>ssl_certificate_key</span>                  /***/baoshuo.ren.ecc.key;\n    <span class=hljs-attribute>ssl_protocols</span>                        TLSv1.<span class=hljs-number>2</span> TLSv1.<span class=hljs-number>3</span>;\n    <span class=hljs-attribute>ssl_ciphers</span>                          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n    <span class=hljs-attribute>ssl_prefer_server_ciphers</span> <span class=hljs-literal>off</span>;\n\n    <span class=hljs-comment># HSTS</span>\n    <span class=hljs-attribute>add_header</span> Strict-Transport-Security <span class=hljs-string>&#x27;max-age=31536000&#x27;</span>;\n\n    <span class=hljs-comment># logging</span>\n    <span class=hljs-attribute>error_log</span>                            /var/log/nginx/blog.baoshuo.ren.<span class=hljs-literal>error</span>.log <span class=hljs-literal>warn</span>;\n\n    <span class=hljs-comment># 404 page</span>\n    <span class=hljs-attribute>error_page</span>                           <span class=hljs-number>404</span> /<span class=hljs-number>404</span>.html;\n&#125;</code></pre><p>上方使用的 SSL 配置是 Mozilla 推荐的现代化配置 ，如果需要更好的兼容性，可以使用 Mozilla 提供的中等安全性配置 ：</p><pre><code class=\"hljs apache\"><span class=hljs-attribute>ssl_protocols</span> TLSv1 TLSv1.<span class=hljs-number>1</span> TLSv1.<span class=hljs-number>2</span> TLSv1.<span class=hljs-number>3</span>;\n<span class=hljs-attribute>ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA;\n<span class=hljs-attribute>ssl_prefer_server_ciphers</span> <span class=hljs-literal>on</span>;</code></pre><h2 id=将博客文件同步到服务器上>将博客文件同步到服务器上</h2><p>在 <code>.github/workflows</code> 目录下创建一个 <code>server.yml</code> 文件，写入以下内容：</p><pre><code class=\"hljs yaml\"><span class=hljs-attr>name:</span> <span class=hljs-string>Deploy</span> <span class=hljs-string>blog</span> <span class=hljs-string>to</span> <span class=hljs-string>Server</span>\n\n<span class=hljs-attr>on:</span>\n  <span class=hljs-attr>push:</span>\n    <span class=hljs-attr>branches:</span> [ <span class=hljs-string>master</span> ]\n  <span class=hljs-attr>workflow_dispatch:</span>\n\n<span class=hljs-attr>jobs:</span>\n  <span class=hljs-attr>deploy:</span>\n    <span class=hljs-attr>runs-on:</span> <span class=hljs-string>ubuntu-latest</span>\n    <span class=hljs-attr>steps:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>Checkout</span>\n        <span class=hljs-attr>uses:</span> <span class=hljs-string>actions/checkout@v2</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>Deploy</span>\n        <span class=hljs-attr>uses:</span> <span class=hljs-string>easingthemes/ssh-deploy@v2.1.5</span>\n        <span class=hljs-attr>env:</span>\n          <span class=hljs-attr>SSH_PRIVATE_KEY:</span> <span class=hljs-string>$&#123;&#123;</span> <span class=hljs-string>secrets.SSH_PRIVATE_KEY</span> <span class=hljs-string>&#125;&#125;</span>\n          <span class=hljs-attr>ARGS:</span> <span class=hljs-string>&quot;-avz --delete  --exclude &#x27;.git/*&#x27; --exclude &#x27;.github/*&#x27; --exclude &#x27;.gitlab-ci.yml&#x27; --exclude &#x27;.nojekyll&#x27;&quot;</span>\n          <span class=hljs-attr>REMOTE_HOST:</span> <span class=hljs-string>$&#123;&#123;</span> <span class=hljs-string>secrets.REMOTE_HOST</span> <span class=hljs-string>&#125;&#125;</span>\n          <span class=hljs-attr>REMOTE_USER:</span> <span class=hljs-string>$&#123;&#123;</span> <span class=hljs-string>secrets.REMOTE_USER</span> <span class=hljs-string>&#125;&#125;</span>\n          <span class=hljs-attr>TARGET:</span> <span class=hljs-string>$&#123;&#123;</span> <span class=hljs-string>secrets.TARGET</span> <span class=hljs-string>&#125;&#125;</span></code></pre><p>之后在 <code>https://github.com/&#123;username&#125;/&#123;repo&#125;/settings/secrets/actions</code> 中添加四个 Secrets 。</p><table><thead><tr><th>名称</th><th>内容</th></tr></thead><tbody><tr><td>REMOTE_HOST</td><td>服务器 IP 地址</td></tr><tr><td>REMOTE_USER</td><td>服务器用户名</td></tr><tr><td>SSH_PRIVATE_KEY</td><td>连接到服务器的 SSH 私钥</td></tr><tr><td>TARGET</td><td>存放文件的路径</td></tr></tbody></table><p>将博客文件 push 到仓库中，就能在服务器上查看到文件了。</p><h2 id=参考资料-5>参考资料</h2><ol><li><a href=\"https://ssl-config.mozilla.org/#server=nginx&amp;version=1.18.0&amp;config=modern&amp;openssl=1.1.1f&amp;ocsp=false&amp;guideline=5.6\" rel=\"external nofollow noreferrer\">nginx 1.18.0, modern config, OpenSSL 1.1.1f - Mozilla SSL Configuration Generator</a></li><li><a href=\"https://ssl-config.mozilla.org/#server=nginx&amp;version=1.18.0&amp;config=intermediate&amp;openssl=1.1.1f&amp;ocsp=false&amp;guideline=5.6\" rel=\"external nofollow noreferrer\">nginx 1.18.0, intermediate config, OpenSSL 1.1.1f - Mozilla SSL Configuration Generator</a></li></ol>","thumb":null,"date":"2020-12-31","updated":"2020-12-31","isoDate":"2020-12-31T16:00:00.000Z","isoUpdate":"2020-12-31T16:00:00.000Z","categories":[{"name":"技术向","url":"/categories/%E6%8A%80%E6%9C%AF%E5%90%91/"}],"tags":[{"name":"折腾","url":"/tags/%E6%8A%98%E8%85%BE/"}],"license":null,"permalink":"https://blog.baoshuo.ren/post/hello-2021/","url":"/post/hello-2021/","prev":{"title":"Linux Systemd 入门","url":"/post/linux-systemd/"},"next":{"title":"NOIP 2020 游记","url":"/post/noip-2020/"},"toc":{"1":{"1":{"text":"安装 nginx","id":"安装-nginx"},"2":{"text":"配置 nginx","id":"配置-nginx"},"3":{"text":"申请 SSL 证书","id":"申请-ssl-证书"},"text":"服务器端操作","id":"服务器端操作"},"2":{"text":"将博客文件同步到服务器上","id":"将博客文件同步到服务器上"},"3":{"text":"参考资料","id":"参考资料-5"}},"hasToc":true,"comments":true,"wordCount":"793 字"},"__post":true},"__N_SSG":true}