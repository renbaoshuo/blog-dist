{"pageProps":{"title":"使用树莓派+Nginx搭建 Rtmp 直播服务 - 宝硕博客","post":{"title":"使用树莓派+Nginx搭建 Rtmp 直播服务","excerpt":"国庆在家闲着没啥事，把一直在角落里吃灰的树莓派 4B 拿出来捣鼓了几下。","content":"<p>国庆在家闲着没啥事，把一直在角落里吃灰的树莓派 4B 拿出来捣鼓了几下。</p><span id=more></span><p>使用 nginx 模块：<a href=https://github.com/arut/nginx-rtmp-module><code>nginx-rtmp-module</code></a></p><h2 id=安装-nginx-nginx-rtmp-module>安装 nginx &amp; nginx-rtmp-module</h2><p>apt, yes!</p><pre><code class=\"hljs bash\">apt update\napt upgrade -y\napt install nginx libnginx-mod-rtmp -y</code></pre><p>访问服务器 IP ，出现如下图所示网页即代表安装成功。</p><p><img src=https://s1.baoshuo.ren/2020/11/26/BdKOhDuxIaYks6q.png alt=\"\" loading=lazy></p><h2 id=修改-nginx-配置>修改 nginx 配置</h2><p>打开 <code>/etc/nginx/nginx.conf</code> ，在末尾处插入下面的配置</p><pre><code class=\"hljs nginx\"><span class=hljs-section>rtmp</span> &#123;\n    <span class=hljs-section>server</span> &#123;\n        <span class=hljs-attribute>listen</span>     <span class=hljs-number>1935</span>;              <span class=hljs-comment># 服务端口</span>\n        <span class=hljs-attribute>chunk_size</span> <span class=hljs-number>4096</span>;              <span class=hljs-comment># 数据传输块的大小</span>\n\n        <span class=hljs-attribute>application</span> vod &#123;\n            <span class=hljs-attribute>play</span> /opt/video;          <span class=hljs-comment># 视频文件存放位置。</span>\n        &#125;\n\n        <span class=hljs-attribute>application</span> rtmplive &#123;\n            <span class=hljs-attribute>live</span>            <span class=hljs-literal>on</span>;        <span class=hljs-comment># 开启直播</span>\n            <span class=hljs-attribute>max_connections</span> <span class=hljs-number>64</span>;        <span class=hljs-comment># 为 rtmp 引擎设置最大连接数。默认为 off</span>\n        &#125;\n\n        <span class=hljs-attribute>application</span> live &#123;\n            <span class=hljs-attribute>live</span>                <span class=hljs-literal>on</span>;              <span class=hljs-comment># 开启直播</span>\n            <span class=hljs-attribute>hls</span>                 <span class=hljs-literal>on</span>;              <span class=hljs-comment># 这个参数把直播服务器改造成实时回放服务器。</span>\n            <span class=hljs-attribute>wait_key</span>            <span class=hljs-literal>on</span>;              <span class=hljs-comment># 对视频切片进行保护，这样就不会产生马赛克了。</span>\n            <span class=hljs-attribute>hls_path</span>            /opt/video/hls;  <span class=hljs-comment># 切片视频文件存放位置。</span>\n            <span class=hljs-attribute>hls_fragment</span>        <span class=hljs-number>10s</span>;             <span class=hljs-comment># 设置HLS片段长度。</span>\n            <span class=hljs-attribute>hls_max_fragment</span>    <span class=hljs-number>10s</span>;             <span class=hljs-comment># 设置HLS片段最大长度。</span>\n            <span class=hljs-attribute>hls_playlist_length</span> <span class=hljs-number>30s</span>;             <span class=hljs-comment># 设置HLS播放列表长度。</span>\n            <span class=hljs-attribute>hls_continuous</span>      <span class=hljs-literal>on</span>;              <span class=hljs-comment># 连续模式。</span>\n            <span class=hljs-attribute>hls_cleanup</span>         <span class=hljs-literal>on</span>;              <span class=hljs-comment># 对多余的切片进行删除。</span>\n            <span class=hljs-attribute>hls_nested</span>          <span class=hljs-literal>on</span>;              <span class=hljs-comment># 嵌套模式。</span>\n        &#125;\n    &#125;\n&#125;</code></pre><p>打开默认站点配置文件 <code>/etc/nginx/sites-available/default</code> ，在 <code>server</code> 部分的末尾添加以下内容</p><pre><code class=\"hljs nginx\"><span class=hljs-section>location</span> /live &#123;\n    <span class=hljs-section>types</span> &#123;\n        application/vnd.apple.<span class=hljs-attribute>mpegurl</span> m3u8;\n        video/<span class=hljs-attribute>mp2t</span>                    ts;\n    &#125;\n\n    <span class=hljs-attribute>autoindex</span> <span class=hljs-literal>on</span>;\n    <span class=hljs-attribute>alias</span>     /opt/video/hls;\n\n    <span class=hljs-attribute>expires</span> -<span class=hljs-number>1</span>;\n\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Cache-Control&#x27;</span>                    <span class=hljs-string>&#x27;no-cache&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Origin&#x27;</span>      <span class=hljs-string>&#x27;*&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class=hljs-string>&#x27;true&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Methods&#x27;</span>     <span class=hljs-string>&#x27;GET, POST, OPTIONS&#x27;</span>;\n    <span class=hljs-attribute>add_header</span> <span class=hljs-string>&#x27;Access-Control-Allow-Headers&#x27;</span>     <span class=hljs-string>&#x27;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;</span>;\n&#125;\n<span class=hljs-section>location</span> /stat &#123;\n    <span class=hljs-attribute>rtmp_stat</span> all;\n    <span class=hljs-comment># rtmp_stat_stylesheet stat.xsl;</span>\n&#125;</code></pre><p>插入完以后配置文件会变成下面的样子</p><pre><code class=\"hljs diff\"><span class=hljs-comment>--- /etc/nginx/sites-available/default</span>\n<span class=hljs-comment>+++ /etc/nginx/sites-available/default</span>\n<span class=hljs-meta>@@ -1,14 +1,36 @@</span>\n server &#123;\n     listen 80 default_server;\n     listen [::]:80 default_server;\n\n     root /var/www/html;\n\n     index index.html index.htm index.nginx-debian.html;\n\n     server_name _;\n\n     location / &#123;\n         try_files $uri $uri/ =404;\n     &#125;\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+    location /live &#123;</span>\n<span class=hljs-addition>+        types &#123;</span>\n<span class=hljs-addition>+            application/vnd.apple.mpegurl m3u8;</span>\n<span class=hljs-addition>+            video/mp2t                    ts;</span>\n<span class=hljs-addition>+        &#125;</span>\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+        autoindex on;</span>\n<span class=hljs-addition>+        alias     /opt/video/hls;</span>\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+        expires -1;</span>\n<span class=hljs-addition>+</span>\n<span class=hljs-addition>+        add_header &#x27;Cache-Control&#x27;                    &#x27;no-cache&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Origin&#x27;      &#x27;*&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Methods&#x27;     &#x27;GET, POST, OPTIONS&#x27;;</span>\n<span class=hljs-addition>+        add_header &#x27;Access-Control-Allow-Headers&#x27;     &#x27;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;;</span>\n<span class=hljs-addition>+    &#125;</span>\n<span class=hljs-addition>+    location /stat &#123;</span>\n<span class=hljs-addition>+        rtmp_stat all;</span>\n<span class=hljs-addition>+        # rtmp_stat_stylesheet stat.xsl;</span>\n<span class=hljs-addition>+    &#125;</span>\n &#125;</code></pre><p>修改完成后使用 <code>nginx -t</code> 测试配置文件是否正确</p><pre><code class=\"hljs vim\">nginx: the configuration <span class=hljs-keyword>file</span> /etc/nginx/nginx.<span class=hljs-keyword>conf</span> <span class=hljs-keyword>syntax</span> <span class=hljs-keyword>is</span> ok\nnginx: configuration <span class=hljs-keyword>file</span> /etc/nginx/nginx.<span class=hljs-keyword>conf</span> test <span class=hljs-keyword>is</span> successful</code></pre><p>当出现成功提示时，使用 <code>nginx -s reload</code> 平滑重启 nginx。</p><p>重启成功后使用 <code>netstat -lnp</code> 查看 <code>tcp/1935</code> 端口是否开启。</p><p><img src=https://s1.baoshuo.ren/2020/11/26/Xy3Nq5WZaogLIvR.png alt=\"\" loading=lazy></p><h2 id=使用-obs-连接直播服务器>使用 OBS 连接直播服务器</h2><p>打开 OBS ，在 设置 -&gt; 推流 中配置以下内容</p><table><thead><tr><th>项目</th><th>值</th></tr></thead><tbody><tr><td>服务</td><td><code>自定义...</code></td></tr><tr><td>服务器</td><td><code>rtmp://$&#123;ip&#125;/live</code></td></tr><tr><td>串流密钥</td><td><code>$&#123;key&#125;</code></td></tr></tbody></table><p>其中，<code>$&#123;ip&#125;</code> 和 <code>$&#123;key&#125;</code> 设置为你需要的值即可。</p><p>回到主界面，点击 <strong>开始推流</strong> 进行推流。</p><h2 id=使用客户端拉取直播流>使用客户端拉取直播流</h2><p><img src=https://s1.baoshuo.ren/2020/11/26/jpqVTAgXSW6oyEP.png alt=\"\" loading=lazy></p><p>在 <code>PotPlayer</code> <code>QQ影音</code> 等播放器中选择 <code>打开-&gt;打开URL</code> 。</p><p><img src=https://s1.baoshuo.ren/2020/11/26/rzBNukVTntf5xUR.png alt=\"\" loading=lazy></p><p>输入 <code>http://$&#123;ip&#125;/live/$&#123;key&#125;/index.m3u8</code> ，点击确定。</p><p><img src=https://s1.baoshuo.ren/2020/11/26/crbEBQNC3qH8uOl.jpg alt=\"\" loading=lazy></p><p>此时可以就看到直播画面了。</p><h2 id=网页端播放>网页端播放</h2><p>页面中只有一个播放器，其他功能请自行实现。</p><pre><code class=\"hljs xml\"><span class=hljs-tag>&lt;<span class=hljs-name>html</span>&gt;</span>\n\n<span class=hljs-tag>&lt;<span class=hljs-name>head</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>title</span>&gt;</span>Live Player<span class=hljs-tag>&lt;/<span class=hljs-name>title</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>meta</span> <span class=hljs-attr>charset</span>=<span class=hljs-string>&quot;UTF-8&quot;</span>&gt;</span>\n<span class=hljs-tag>&lt;/<span class=hljs-name>head</span>&gt;</span>\n\n<span class=hljs-tag>&lt;<span class=hljs-name>body</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>div</span> <span class=hljs-attr>id</span>=<span class=hljs-string>&quot;dplayer&quot;</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>div</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>src</span>=<span class=hljs-string>&quot;https://cdn.jsdelivr.net/npm/hls.js@0.14.13/dist/hls.min.js&quot;</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>src</span>=<span class=hljs-string>&quot;https://cdn.jsdelivr.net/npm/dplayer@1.26.0/dist/DPlayer.min.js&quot;</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span>\n    <span class=hljs-tag>&lt;<span class=hljs-name>script</span>&gt;</span><span class=language-javascript></span>\n<span class=language-javascript>        <span class=hljs-keyword>const</span> dp = <span class=hljs-keyword>new</span> <span class=\"hljs-title class_\">DPlayer</span>(&#123;</span>\n<span class=language-javascript>            <span class=hljs-attr>container</span>: <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=hljs-string>&#x27;dplayer&#x27;</span>),</span>\n<span class=language-javascript>            <span class=hljs-attr>live</span>: <span class=hljs-literal>true</span>,</span>\n<span class=language-javascript>            <span class=hljs-attr>video</span>: &#123;</span>\n<span class=language-javascript>                <span class=hljs-attr>url</span>: <span class=hljs-string>&#x27;http://$&#123;ip&#125;/live/$&#123;key&#125;/index.m3u8&#x27;</span>,</span>\n<span class=language-javascript>                <span class=hljs-attr>type</span>: <span class=hljs-string>&#x27;hls&#x27;</span>,</span>\n<span class=language-javascript>            &#125;,</span>\n<span class=language-javascript>        &#125;);</span>\n<span class=language-javascript>    </span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span>\n<span class=hljs-tag>&lt;/<span class=hljs-name>body</span>&gt;</span>\n\n<span class=hljs-tag>&lt;/<span class=hljs-name>html</span>&gt;</span></code></pre><p><img src=https://s1.baoshuo.ren/2020/11/26/9X6mUtF4fLzdaYn.jpg alt=\"\" loading=lazy></p><h2 id=后记-5>后记</h2><p>如果没有在外直播的需求，不要将 rtmp 端口映射至公网，这可能会带来一些不必要的麻烦。</p><h2 id=参考资料-10>参考资料</h2><ol><li><a href=https://github.com/arut/nginx-rtmp-module>NGINX-based Media Streaming Server</a></li></ol>","thumb":null,"date":"2020-10-05","updated":"2020-10-05","isoDate":"2020-10-05T13:35:32.000Z","isoUpdate":"2020-10-05T13:35:32.000Z","categories":[{"name":"技术向","url":"/categories/%E6%8A%80%E6%9C%AF%E5%90%91/"}],"tags":[{"name":"折腾","url":"/tags/%E6%8A%98%E8%85%BE/"}],"license":null,"permalink":"https://blog.baoshuo.ren/post/raspberry-pi-rtmp-live/","url":"/post/raspberry-pi-rtmp-live/","prev":{"title":"Bilibili 1024 节 CTF Write Up","url":"/post/bilibili-1024-ctf-write-up/"},"next":{"title":"给腾讯云服务器免费增加第二个 IP","url":"/post/tencent-cloud-cvm-dual-ip/"},"toc":{"1":{"text":"安装 nginx &amp; nginx-rtmp-module","id":"安装-nginx-nginx-rtmp-module"},"2":{"text":"修改 nginx 配置","id":"修改-nginx-配置"},"3":{"text":"使用 OBS 连接直播服务器","id":"使用-obs-连接直播服务器"},"4":{"text":"使用客户端拉取直播流","id":"使用客户端拉取直播流"},"5":{"text":"网页端播放","id":"网页端播放"},"6":{"text":"后记","id":"后记-5"},"7":{"text":"参考资料","id":"参考资料-10"}},"hasToc":true,"comments":true,"wordCount":"992 字"},"__post":true},"__N_SSG":true}