{"pageProps":{"title":"洛谷爬虫 - 宝硕博客","post":{"title":"洛谷爬虫","excerpt":"截至目前，洛谷已经有了近两万道题目和四十余万名用户。本代码爬取了一些样本，以供后续（可能）的数据分析。","content":[["$","p",{},["截至目前，洛谷已经有了近两万道题目和四十余万名用户。本代码爬取了一些样本，以供后续（可能）的数据分析。"]],["$","span",{"id":"more"},[]],["$","p",{},["本次爬取遵守洛谷的 ",["$","code",{},["robots.txt"]]," 中的要求，不爬取提交记录页面。为了避免影响洛谷的正常运行，脚本只采用单线程进行爬取。"]],["$","pre",{},[["$","code",{"class":"hljs http"},[["$","span",{"class":"hljs-attribute"},["User-Agent"]],["$","span",{"class":"hljs-punctuation"},[": "]],"*\n",["$","span",{"class":"hljs-attribute"},["Disallow"]],["$","span",{"class":"hljs-punctuation"},[": "]],"/record\n",["$","span",{"class":"hljs-attribute"},["Disallow"]],["$","span",{"class":"hljs-punctuation"},[": "]],"/recordnew"]]]],["$","h2",{"id":"爬取题目信息"},["爬取题目信息"]],["$","h3",{"id":"题目数据获取"},["题目数据获取"]],["$","p",{},["先使用 ",["$","code",{},["curl"]]," 获取洛谷的题目页面："]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/JageUdcpXTthIjM.png","alt":"","loading":"lazy"},[]]]],["$","p",{},["可以看出我们需要的数据都在传入给 ",["$","code",{},["decodeURIComponent()"]]," 函数的字符串中，正则匹配取出即可。"]],["$","p",{},["下面是代码实现："]],["$","pre",{},[["$","code",{"class":"hljs python"},[["$","span",{"class":"hljs-comment"},["#!/usr/bin/python3"]],"\n",["$","span",{"class":"hljs-comment"},["# coding: utf-8"]],"\n\n",["$","span",{"class":"hljs-keyword"},["import"]]," requests\n",["$","span",{"class":"hljs-keyword"},["import"]]," re\n",["$","span",{"class":"hljs-keyword"},["import"]]," json\n",["$","span",{"class":"hljs-keyword"},["from"]]," urllib.parse ",["$","span",{"class":"hljs-keyword"},["import"]]," unquote\n\n",["$","span",{"class":"hljs-comment"},["# 设置请求头"]],"\nheaders = {\n    ",["$","span",{"class":"hljs-string"},["\"User-Agent\""]],": ",["$","span",{"class":"hljs-string"},["\"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36 Spider/0.1\""]],"\n}\n\n",["$","span",{"class":"hljs-keyword"},["def"]]," ",["$","span",{"class":"hljs-title function_"},["getProblemJSON"]],"(",["$","span",{"class":"hljs-params"},["pid"]],"):\n    ",["$","span",{"class":"hljs-keyword"},["return"]]," json.loads(unquote(",["$","span",{"class":"hljs-built_in"},["str"]],"(re.findall(",["$","span",{"class":"hljs-string"},["r'decodeURIComponent\\(\"(.*)\"\\)'"]],", requests.get(url=",["$","span",{"class":"hljs-string"},["\"https://www.luogu.com.cn/problem/P1000\""]],", headers=headers).text)[",["$","span",{"class":"hljs-number"},["0"]],"])))\n\ndata = getProblemJSON(",["$","span",{"class":"hljs-string"},["\"P1000\""]],")\n",["$","span",{"class":"hljs-built_in"},["print"]],"(json.dumps(data[",["$","span",{"class":"hljs-string"},["'currentData'"]],"], sort_keys=",["$","span",{"class":"hljs-literal"},["True"]],", indent=",["$","span",{"class":"hljs-number"},["4"]],"))"]]]],["$","p",{},["Update at 2021/02/05:"]],["$","p",{},["添加参数 ",["$","code",{},["_contentOnly=1"]]," 可以直接获取 JSON 格式的信息，无需再正则匹配。"]],["$","pre",{},[["$","code",{"class":"hljs diff"},[["$","span",{"class":"hljs-comment"},["--- a/tools/spider.py"]],"\n",["$","span",{"class":"hljs-comment"},["+++ b/tools/spider.py"]],"\n",["$","span",{"class":"hljs-meta"},["@@ -19,8 +19,7 @@"]],"\n def getProblem(pid):\n",["$","span",{"class":"hljs-deletion"},["-    url = f\"https://www.luogu.com.cn/problem/{pid}\""]],"\n",["$","span",{"class":"hljs-deletion"},["-    redata = re.findall(r'decodeURIComponent\\(\"(.*)\"\\)',"]],"\n",["$","span",{"class":"hljs-deletion"},["-                        requests.get(url, headers=headers).text)"]],"\n",["$","span",{"class":"hljs-addition"},["+    url = f\"https://www.luogu.com.cn/problem/{pid}?_contentOnly=1\""]],"\n",["$","span",{"class":"hljs-addition"},["+    redata = requests.get(url, headers=headers).text"]],"\n     if len(redata) == 0:\n         return { \"code\": 403 }\n     else:\n",["$","span",{"class":"hljs-deletion"},["-        return json.loads(unquote(redata[0]))"]],"\n",["$","span",{"class":"hljs-addition"},["+        return json.loads(redata)"]]]]]],["$","h3",{"id":"处理题目数据"},["处理题目数据"]],["$","p",{},["这里只留下 ",["$","code",{},["currentData.problem"]]," 字段里面的内容即可。"]],["$","pre",{},[["$","code",{"class":"hljs python"},[["$","span",{"class":"hljs-comment"},["#!/usr/bin/python3"]],"\n",["$","span",{"class":"hljs-comment"},["# coding: utf-8"]],"\n\n",["$","span",{"class":"hljs-keyword"},["import"]]," requests\n",["$","span",{"class":"hljs-keyword"},["import"]]," re\n",["$","span",{"class":"hljs-keyword"},["import"]]," json\n",["$","span",{"class":"hljs-keyword"},["from"]]," urllib.parse ",["$","span",{"class":"hljs-keyword"},["import"]]," unquote\n\nf = ",["$","span",{"class":"hljs-built_in"},["open"]],"(",["$","span",{"class":"hljs-string"},["'problems.json'"]],", ",["$","span",{"class":"hljs-string"},["'w'"]],")\nres = []\n\nheaders = {\n    ",["$","span",{"class":"hljs-string"},["\"user-agent\""]],": ",["$","span",{"class":"hljs-string"},["\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4331.0 Safari/537.36 spider/0.1\""]],",\n}\n\n\n",["$","span",{"class":"hljs-keyword"},["def"]]," ",["$","span",{"class":"hljs-title function_"},["getProblem"]],"(",["$","span",{"class":"hljs-params"},["pid"]],"):\n    ",["$","span",{"class":"hljs-keyword"},["return"]]," json.loads(requests.get(",["$","span",{"class":"hljs-string"},["f\"https://www.luogu.com.cn/problem/",["$","span",{"class":"hljs-subst"},["{pid}"]],"?_contentOnly=1\""]],", headers=headers).text)[",["$","span",{"class":"hljs-string"},["'currentData'"]],"]\n\n\n",["$","span",{"class":"hljs-keyword"},["for"]]," i ",["$","span",{"class":"hljs-keyword"},["in"]]," ",["$","span",{"class":"hljs-built_in"},["range"]],"(",["$","span",{"class":"hljs-number"},["1000"]],", ",["$","span",{"class":"hljs-number"},["1010"]],"):\n    tmpdict = {}\n    tmpdict[",["$","span",{"class":"hljs-string"},["\"pid\""]],"] = ",["$","span",{"class":"hljs-string"},["f\"P",["$","span",{"class":"hljs-subst"},["{i}"]],"\""]],"\n    tmpdict[",["$","span",{"class":"hljs-string"},["\"data\""]],"] = getProblem(",["$","span",{"class":"hljs-string"},["f\"P",["$","span",{"class":"hljs-subst"},["{i}"]],"\""]],")[",["$","span",{"class":"hljs-string"},["\"problem\""]],"]\n    res.append(tmpdict)\n\n",["$","span",{"class":"hljs-comment"},["# print(res)"]],"\nf.write(json.dumps(res, indent=",["$","span",{"class":"hljs-number"},["4"]],").replace(",["$","span",{"class":"hljs-string"},["\"\\\\t\""]],", ",["$","span",{"class":"hljs-string"},["\"    \""]],"))"]]]],["$","h3",{"id":"最终代码"},["最终代码"]],["$","pre",{},[["$","code",{"class":"hljs python"},[["$","span",{"class":"hljs-comment"},["#!/usr/bin/python3"]],"\n",["$","span",{"class":"hljs-comment"},["# coding: utf-8"]],"\n\n",["$","span",{"class":"hljs-keyword"},["import"]]," requests\n",["$","span",{"class":"hljs-keyword"},["import"]]," json\n",["$","span",{"class":"hljs-keyword"},["import"]]," time\n",["$","span",{"class":"hljs-keyword"},["import"]]," pymongo\n\ndbclient = pymongo.MongoClient(",["$","span",{"class":"hljs-string"},["\"mongodb://127.0.0.1:27017/\""]],")\nluogudb = dbclient[",["$","span",{"class":"hljs-string"},["\"luogu\""]],"]\ndbcol = luogudb[",["$","span",{"class":"hljs-string"},["\"problem\""]],"]\n\nheaders = {\n    ",["$","span",{"class":"hljs-string"},["\"user-agent\""]],": ",["$","span",{"class":"hljs-string"},["\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4331.0 Safari/537.36 spider/0.1\""]],",\n}\n\n\n",["$","span",{"class":"hljs-keyword"},["def"]]," ",["$","span",{"class":"hljs-title function_"},["getProblem"]],"(",["$","span",{"class":"hljs-params"},["pid"]],"):\n    url = ",["$","span",{"class":"hljs-string"},["f\"https://www.luogu.com.cn/problem/",["$","span",{"class":"hljs-subst"},["{pid}"]],"?_contentOnly=1\""]],"\n    redata = requests.get(url, headers=headers).text\n    ",["$","span",{"class":"hljs-keyword"},["return"]]," json.loads(redata)\n\n",["$","span",{"class":"hljs-keyword"},["for"]]," i ",["$","span",{"class":"hljs-keyword"},["in"]]," ",["$","span",{"class":"hljs-built_in"},["range"]],"(",["$","span",{"class":"hljs-number"},["1000"]],", ",["$","span",{"class":"hljs-number"},["7103"]],"):\n    pid = ",["$","span",{"class":"hljs-string"},["f\"P",["$","span",{"class":"hljs-subst"},["{i}"]],"\""]],"\n    ",["$","span",{"class":"hljs-keyword"},["if"]]," ",["$","span",{"class":"hljs-built_in"},["list"]],"(dbcol.find({",["$","span",{"class":"hljs-string"},["'pid'"]],": pid})) == []:\n        tmpdict = {}\n        tmpdict[",["$","span",{"class":"hljs-string"},["\"pid\""]],"] = pid\n        tmpdata = getProblem(pid)\n        ",["$","span",{"class":"hljs-keyword"},["if"]]," tmpdata[",["$","span",{"class":"hljs-string"},["\"code\""]],"] == ",["$","span",{"class":"hljs-number"},["200"]],":\n            tmpdict[",["$","span",{"class":"hljs-string"},["\"data\""]],"] = getProblem(pid)[",["$","span",{"class":"hljs-string"},["\"currentData\""]],"][",["$","span",{"class":"hljs-string"},["\"problem\""]],"]\n            dbcol.insert_one(tmpdict)\n            ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["f\"Successfully get problem ",["$","span",{"class":"hljs-subst"},["{pid}"]],".\""]],")\n            time.sleep(",["$","span",{"class":"hljs-number"},["1"]],")\n        ",["$","span",{"class":"hljs-keyword"},["else"]],":\n            ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["f\"Fail to get problem ",["$","span",{"class":"hljs-subst"},["{pid}"]],".\""]],")\n    ",["$","span",{"class":"hljs-keyword"},["else"]],":\n        ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["f\"Problem ",["$","span",{"class":"hljs-subst"},["{pid}"]]," is already exists.\""]],")"]]]],["$","p",{},["有关于数据库读写的部分请参考下文的 ",["$","a",{"href":"#%E6%95%B0%E6%8D%AE%E5%BA%93"},["数据库"]]," 部分。"]],["$","h2",{"id":"爬取用户信息"},["爬取用户信息"]],["$","p",{},["结构与题目爬虫类似，故不再作代码说明。"]],["$","pre",{},[["$","code",{"class":"hljs python"},[["$","span",{"class":"hljs-keyword"},["import"]]," json\n",["$","span",{"class":"hljs-keyword"},["import"]]," time\n",["$","span",{"class":"hljs-keyword"},["import"]]," pymongo\n",["$","span",{"class":"hljs-keyword"},["import"]]," requests\n\ndbclient = pymongo.MongoClient(",["$","span",{"class":"hljs-string"},["\"mongodb://127.0.0.1:27017/\""]],")\nluogudb = dbclient[",["$","span",{"class":"hljs-string"},["\"luogu\""]],"]\ndbcol = luogudb[",["$","span",{"class":"hljs-string"},["\"user\""]],"]\n\nheaders = { ",["$","span",{"class":"hljs-string"},["\"User-Agent\""]],": ",["$","span",{"class":"hljs-string"},["\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4331.0 Safari/537.36\""]],", }\n\n",["$","span",{"class":"hljs-keyword"},["def"]]," ",["$","span",{"class":"hljs-title function_"},["getUser"]],"(",["$","span",{"class":"hljs-params"},["uid"]],"):\n    url = ",["$","span",{"class":"hljs-string"},["f\"https://www.luogu.com.cn/user/",["$","span",{"class":"hljs-subst"},["{uid}"]],"?_contentOnly=1\""]],"\n    redata = requests.get(url, headers=headers).text\n    ",["$","span",{"class":"hljs-keyword"},["return"]]," json.loads(redata)\n\n",["$","span",{"class":"hljs-keyword"},["for"]]," uid ",["$","span",{"class":"hljs-keyword"},["in"]]," ",["$","span",{"class":"hljs-built_in"},["range"]],"(",["$","span",{"class":"hljs-number"},["1"]],", ",["$","span",{"class":"hljs-number"},["2"]],"):\n    ",["$","span",{"class":"hljs-keyword"},["if"]]," ",["$","span",{"class":"hljs-built_in"},["list"]],"(dbcol.find({",["$","span",{"class":"hljs-string"},["'uid'"]],": uid})) == []:\n        tmpdict = {}\n        tmpdict[",["$","span",{"class":"hljs-string"},["\"_id\""]],"] = uid\n        tmpdict[",["$","span",{"class":"hljs-string"},["\"uid\""]],"] = uid\n        tmpdata = getUser(uid)\n        ",["$","span",{"class":"hljs-keyword"},["if"]]," tmpdata[",["$","span",{"class":"hljs-string"},["\"code\""]],"] == ",["$","span",{"class":"hljs-number"},["200"]],":\n            tmpdict[",["$","span",{"class":"hljs-string"},["\"data\""]],"] = tmpdata[",["$","span",{"class":"hljs-string"},["\"currentData\""]],"][",["$","span",{"class":"hljs-string"},["\"user\""]],"]\n            dbcol.insert_one(tmpdict)\n            ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["f\"Successfully get user ",["$","span",{"class":"hljs-subst"},["{uid}"]],".\""]],")\n            time.sleep(",["$","span",{"class":"hljs-number"},["0.5"]],")\n        ",["$","span",{"class":"hljs-keyword"},["else"]],":\n            ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["f\"Fail to get user ",["$","span",{"class":"hljs-subst"},["{uid}"]],".\""]],")\n            time.sleep(",["$","span",{"class":"hljs-number"},["0.5"]],")\n    ",["$","span",{"class":"hljs-keyword"},["else"]],":\n        ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["f\"User ",["$","span",{"class":"hljs-subst"},["{uid}"]]," is already exists.\""]],")"]]]],["$","h2",{"id":"数据库"},["数据库"]],["$","h3",{"id":"搭建数据库"},["搭建数据库"]],["$","p",{},["搭建 MongoDB 数据库只需要在 docker 里面跑一个容器，非常简便。"]],["$","pre",{},[["$","code",{"class":"hljs bash"},["docker run -v /root/data/mongo:/data/db -itd --name mongo -p 27017:27017 mongo"]]]],["$","h3",{"id":"连接数据库"},["连接数据库"]],["$","pre",{},[["$","code",{"class":"hljs python"},["client = pymongo.MongoClient(",["$","span",{"class":"hljs-string"},["\"mongodb://127.0.0.1:27017/\""]],")\nluogudb = dbclient[",["$","span",{"class":"hljs-string"},["\"luogu\""]],"]\ncol = luogudb[",["$","span",{"class":"hljs-string"},["\"problem\""]],"]"]]]],["$","h3",{"id":"存储数据"},["存储数据"]],["$","pre",{},[["$","code",{"class":"hljs python"},[["$","span",{"class":"hljs-keyword"},["if"]]," ",["$","span",{"class":"hljs-built_in"},["list"]],"(col.find({",["$","span",{"class":"hljs-string"},["'pid'"]]," : pid})) == []:\n    col.insert_one(data)\n    ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["\"Success.\""]],")\n",["$","span",{"class":"hljs-keyword"},["else"]],":\n    ",["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-string"},["\"Already exists.\""]],")"]]]],["$","h3",{"id":"读取数据"},["读取数据"]],["$","pre",{},[["$","code",{"class":"hljs python"},[["$","span",{"class":"hljs-built_in"},["print"]],"(",["$","span",{"class":"hljs-built_in"},["list"]],"(col.find()))"]]]],["$","h2",{"id":"web-管理数据库"},["web 管理数据库"]],["$","p",{},["再跑一个 ",["$","code",{},["mongo-express"]]," 就行了。"]],["$","pre",{},[["$","code",{"class":"hljs bash"},["docker run -d --name mongo-express -e ME_CONFIG_MONGODB_SERVER=host.docker.internal -p 8081:8081 mongo-express"]]]],["$","p",{},["访问 ",["$","code",{},["ip:8081"]]," 就能看到管理界面了。"]],["$","h2",{"id":"导出数据库"},["导出数据库"]],["$","p",{},["直接运行下方命令导出为 JSON 格式即可。"]],["$","pre",{},[["$","code",{"class":"hljs bash"},["mongoexport -d luogu -c problem -o /data/db/problem.json"]]]],["$","p",{},["或者点击对应数据库管理界面中的 ",["$","code",{},["[JSON]"]]," 按钮导出。"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/hXtVAynYGcb8B71.png","alt":"","loading":"lazy"},[]]]],["$","h2",{"id":"成果"},["成果"]],["$","p",{},["断断续续爬了一个多星期，终于爬完了。"]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2020/11/26/7muojQZM125gWXL.png","alt":"","loading":"lazy"},[]]]]],"thumb":null,"date":"2020-11-26","updated":"2020-11-26","isoDate":"2020-11-26T06:55:02.000Z","isoUpdate":"2020-11-26T06:55:02.000Z","categories":[{"name":"技术向","url":"/categories/%E6%8A%80%E6%9C%AF%E5%90%91/"}],"tags":[],"license":null,"permalink":"https://blog.baoshuo.ren/post/luogu-spider/","url":"/post/luogu-spider/","prev":{"title":"下载自己在 SM.MS 图床上的所有图片","url":"/post/download-smms-image/"},"next":{"title":"批量修改 Git 仓库的提交邮箱","url":"/post/change-git-submission-email/"},"toc":{"0":{"0":{"text":"题目数据获取","id":"题目数据获取"},"1":{"text":"处理题目数据","id":"处理题目数据"},"2":{"text":"最终代码","id":"最终代码"},"text":"爬取题目信息","id":"爬取题目信息"},"1":{"text":"爬取用户信息","id":"爬取用户信息"},"2":{"0":{"text":"搭建数据库","id":"搭建数据库"},"1":{"text":"连接数据库","id":"连接数据库"},"2":{"text":"存储数据","id":"存储数据"},"3":{"text":"读取数据","id":"读取数据"},"text":"数据库","id":"数据库"},"3":{"text":"web 管理数据库","id":"web-管理数据库"},"4":{"text":"导出数据库","id":"导出数据库"},"5":{"text":"成果","id":"成果"}},"hasToc":true,"comments":true,"wordCount":"约 1.2 千字"}},"__N_SSG":true}