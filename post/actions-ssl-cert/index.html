<!DOCTYPE html><html lang="zh-CN"><head><meta name="viewport" content="width=device-width"><meta charset="utf-8"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="宝硕博客"><meta property="og:site_name" content="宝硕博客"><meta name="twitter:site" content="@renbaoshuo"><meta name="twitter:creator" content="@renbaoshuo"><title>使用 GitHub Actions 自动申请与部署 SSL 证书 - 宝硕博客</title><meta name="description" content="对于一个有很多服务器的人来说，在不同服务器上同步 SSL 证书是一件麻烦事。笔者尝试过很多种方式，最后在 Menci 的推荐下选定了使用 GitHub Actions 来自动申请、续期 SSL 证书，并自动推送到各个服务器上。"><meta property="og:description" content="对于一个有很多服务器的人来说，在不同服务器上同步 SSL 证书是一件麻烦事。笔者尝试过很多种方式，最后在 Menci 的推荐下选定了使用 GitHub Actions 来自动申请、续期 SSL 证书，并自动推送到各个服务器上。"><meta name="keywords" content="[object Object],[object Object],[object Object],[object Object]"><meta property="og:type" content="article"><meta property="og:title" content="使用 GitHub Actions 自动申请与部署 SSL 证书 - 宝硕博客"><meta property="og:url" content="/post/actions-ssl-cert/"><meta property="og:image" content="https://s1.baoshuo.ren/2022/05/13/lj2cs5QNP3rWkeq.png"><link rel="canonical" href="/post/actions-ssl-cert/"><meta name="twitter:card" content="summary_large_image"><meta name="next-head-count" content="16"><meta name="darkreader" content="disabled"><meta name="generator" content="Hexo 6.2.0"><script defer="" src="https://cdnjs.baoshuo.ren/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin=""></script><script defer="" src="https://cdnjs.baoshuo.ren/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin=""></script><script defer="" nomodule="" src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/webpack-d03dec103c5ee603.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/framework-c179c9a670c47eb6.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/main-d001dfc4b5cb68c2.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/pages/_app-8df0f06cff2cbf6b.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/6-edd26cc39383d1b0.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/chunks/pages/post/%5Bslug%5D-8e6125cf83ab44ce.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/k90Ni_4Pr-FWD9VknAbFR/_buildManifest.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/k90Ni_4Pr-FWD9VknAbFR/_ssgManifest.js" defer=""></script><script src="https://static.cdn.baoshuo.ren/blog/_next/static/k90Ni_4Pr-FWD9VknAbFR/_middlewareManifest.js" defer=""></script><style>.eDssNQ{pointer-events:none}.gZmUMJ{height:2px}.hJfaYF{z-index:200}.dJcTkO{box-shadow:0 0 10px var(--c-a),0 0 10px var(--c-a)}.gOeSjL{opacity:1}.fxkyut{transition:all .25s ease-in-out}.kaWzRu{transform:rotate(3deg) translateY(-4px)}.ktTKqx{width:5%}.cdfZWI:before{box-shadow:inset 0 0 32px}.zJreD:before{height:3px}.iSSyDr:before{left:1.5px}.jORRks:before{top:14px}.beaHbQ:before{width:3px}.haKUHj:after{box-sizing:border-box}.feNfPp:after{transform:translate(-50%,-50%)}.qMJeO:after{box-shadow:inset 0 0 0 2px,0 0 0 2px}.dUAgBC:after{height:27.5px}.hVfwnH:after{left:0}.jtnuen:after{top:100%}.iibzBM:after{width:27.5px}.bLLutt:before{height:.8em}.kUNXjX:before{transform:translate(0) rotate(45deg)}.kBZpXt:before{width:.8em}.kCTVgr:after{top:80%}.cDbGzW:after{left:80%}.eHPmEw:after{transform:translate(-50%,-50%) rotate(45deg)}.dmfenB:after{width:.5em}.kAVdUc{font-size:16px}.jLmWnd:before{height:100%}.jYPXoJ:before{top:0}.kKTZiz:before{left:0}.elJZFC:after{height:14px}.eLXBUo:after{width:7px}.ebtDcN:after{top:1px}.caItCN{height:2rem}.jYEAGD{align-items:stretch}.gKQCBv:after{content:"·"}.jbBqfU:before{transform:translate(-50%,-25%) rotate(45deg)}.dhOkuk:before{box-sizing:border-box}.jFCJJY:before{box-shadow:0 -.35em,0 .35em}.iqzSxf:before{transform:translate(-50%,-50%)}.bQvqKh:before{width:100%}.sKExc{right:1rem}.bjOGUo{bottom:1rem}.eSaSrN{contain:layout}.egGyMq{line-height:1}.IVbXa{justify-content:center}.bcjLCN{flex-grow:0}.WhAZY{top:0}.gdPTUr{height:100%}.dYbGIK{flex-grow:0}.bOjOhu{left:0}.ipEZTh{width:95%}.eRVtDl{max-width:var(--w)}.kKplrA{contain:content}.gifdxR{font-size:1.25rem}.laXLGQ{color:var(--c)}.kooHYa{text-align:center}.moyUB{color:#fff}.eAOGpx{user-select:none}.bLHLvQ{text-indent:-9999px}.jXmXEB{height:1em}.hHGIsI{width:1em}.jbzBdl:before{transform:translate(-25%,-50%) rotate(-45deg)}.fIXfpL:before{width:.65em}.ergVCo:before{height:.65em}.cqyuit:before{top:50%}.hCTuXM:before{left:50%}.gvwkfp{font-size:.9em}.bRNbBj{font-weight:500}.fPWmiY{justify-content:flex-start}.hmKFEM{text-align:left}.dQPgRK{flex-grow:1}.fXzCvR{justify-content:flex-end}.klEWBS{text-align:right}.foGVKH{align-items:center}.fygwnR{box-sizing:border-box}.kQBRAp{display:block}.iMyxuR:after{display:block}.bbRNPO:after{left:1px}.imhmwA{position:fixed}.dPAasc{box-shadow:var(--s)}.jqaXfP{z-index:100}.iVncgA::-webkit-scrollbar{height:var(--s-x)}.fQhDyl::-webkit-scrollbar{width:var(--s-y)}.bBVwIW{letter-spacing:1px}.jsvbrX{cursor:pointer}.kroOag{font-size:.9rem}.bEvNbr{position:absolute}.eLDTYY{vertical-align:middle}.iRjWhb{font-size:.925rem}.QcCvg{height:12.25em}.jdKAzd{width:12.25em}.krZeLX{right:-30px}.gjJDYK{top:-40px}.dZDNG{opacity:.1}.julXB:before{content:""}.kvHVCE:before{position:absolute}.fQfkux:before{height:3.75em}.dPenaT:before{width:3.75em}.NpaJd:before{left:1.5625em}.jgAayQ:before{top:3em}.fqXcHQ:after{content:""}.dyMCpl:after{position:absolute}.chpxwD:after{height:3.75em}.beuMzX:after{width:3.75em}.dbtvqd:after{right:1.5625em}.jPcnDC:after{top:3em}.bpQkXn{font-weight:700}.gcQrEv{font-size:.9em}.iMkoWi{flex-direction:column}.chVqDG{font-size:.8em}.fyuAJJ{color:inherit}.jYagCu{max-height:400px}.gWinOH{object-fit:cover}.cypeLb{font-size:1.75rem}.VFfNK{letter-spacing:.75px}.dgIPcR{color:var(--c-m)}.cjScYX{position:relative}.cRUUAa{width:100%}.gSBWlu{display:flex}.kJzccJ{justify-content:space-between}.cpOcAb{display:inline-block}.kpaoc{color:var(--c-s)}.kOZsAO{word-break:keep-all}.jBtqwC{background-color:var(--c-a)}.cTiRpf:after{border-top-left-radius:100px}.kLOwRz:after{border-top-right-radius:100px}.fEOdlm:after{border-bottom-right-radius:100px}.iiCJgG:after{border-bottom-left-radius:100px}.gbJvTx:before{border-top-left-radius:100px}.eqcbDJ:before{border-top-right-radius:100px}.efWRhG:before{border-bottom-right-radius:100px}.ciQIPM:before{border-bottom-left-radius:100px}.jVKJhP:before{border-top-left-radius:1000px}.qOQRo:before{border-top-right-radius:1000px}.ftrJDm:before{border-bottom-right-radius:1000px}.dnkCBy:before{border-bottom-left-radius:1000px}.eCTYLu:after{overflow-x:hidden}.fPEpYf:after{overflow-y:hidden}.fSuxSX:after{border-top-left-radius:1000px}.diZuuN:after{border-bottom-left-radius:1000px}.ihNVbP{flex-basis:0}.KqcXP{background-color:transparent}.eIJBjz{padding-right:.7rem}.hcJOFn{padding-left:.7rem}.iawFZL{margin-right:.4rem}.kswRdL{margin-left:.4rem}.eGElBa{padding-top:2.5rem}.eBrwtd{padding-bottom:4rem}.edKxdA{padding-top:.9rem}.osxXp{padding-right:.9rem}.foquGP{padding-bottom:.9rem}.lhTVEC{padding-left:.9rem}.eQmaZO{padding-top:.6rem}.dZrGlq{padding-bottom:.6rem}.gCwvuy{background-color:var(--g-m)}.dvivnl{overflow-x:auto}.jSOKOm{text-decoration-line:inherit}.bKjKUN{padding-top:.75rem}.jdraHW{margin-right:auto}.eqrBPF{margin-left:auto}.lexxaO{background-color:#946ce6}.ebVilo{border-top-left-radius:.25rem}.kyhYEz{border-top-right-radius:.25rem}.jIkFRm{border-bottom-right-radius:.25rem}.gpptow{border-bottom-left-radius:.25rem}.kMKXDC{padding-top:.25rem}.ftIldC{padding-right:1rem}.jOeduE{padding-bottom:.25rem}.iDuqPI{padding-left:1rem}.kUPESX{margin-left:.5rem}.eKlQYW{flex-shrink:1}.bLlOeF{flex-basis:50%}.hwgZgR:after{background-color:currentColor}.bcfNhz{background-color:var(--g-b)}.kRQsoY{border-top-left-radius:var(--r)}.jBvrhX{border-top-right-radius:var(--r)}.dgtTIu{border-bottom-right-radius:var(--r)}.eXJtsk{border-bottom-left-radius:var(--r)}.llUCyD{overflow-y:auto}.qlVwF::-webkit-scrollbar-thumb{background-color:#b5b5b5}.jOHNtp::-webkit-scrollbar-thumb{border-top-left-radius:var(--r)}.PvULj::-webkit-scrollbar-thumb{border-top-right-radius:var(--r)}.hTxdYE::-webkit-scrollbar-thumb{border-bottom-right-radius:var(--r)}.fUqTQL::-webkit-scrollbar-thumb{border-bottom-left-radius:var(--r)}.kVZHcH{padding-top:0}.cyerGB{margin-top:.5rem}.dSxtaa{margin-right:.5rem}.ctWdVF{border-top-left-radius:50%}.jkGfDR{border-top-right-radius:50%}.bSTogt{border-bottom-right-radius:50%}.hSDpeY{border-bottom-left-radius:50%}.cDxIqC:before{border-top-left-radius:50%}.jpWidM:before{border-top-right-radius:50%}.jzdNVF:before{border-bottom-right-radius:50%}.bPkdhG:before{border-bottom-left-radius:50%}.beJoMJ:after{border-top-left-radius:50%}.iJgiCW:after{border-top-right-radius:50%}.hqUHPA:after{border-bottom-right-radius:50%}.jWWlrr:after{border-bottom-left-radius:50%}.jnGacs{background-color:var(--g-l)}.cvPkWa{padding-bottom:1.25rem}.dUvWpK{overflow-x:hidden}.hRLVFh{overflow-y:hidden}.dLUwcr{text-decoration-line:underline}.kiDYix{flex-wrap:wrap}.hriXhD{flex-shrink:0}.jjryqL{margin-right:1rem}.jTjNVR{margin-top:0}.hNjeNG{margin-bottom:0}.kpCrIt{padding-top:1.25rem}.bMSzLf{padding-right:2rem}.iATxZH{padding-bottom:0}.iigETV{padding-left:2rem}.fClzDx{margin-top:.75rem}.iKck{margin-right:0}.hlBtvm{margin-bottom:.75rem}.bmFLeF{margin-left:0}.dwawJR{padding-right:0}.jQenOz{padding-left:0}.icKiSN{padding-top:1.5rem}.fZMRmg{padding-bottom:1.5rem}.cUXNmd{margin-top:1rem}.biWxPv{margin-bottom:1rem}.bbUXPo{text-decoration-line:none}.dmKgnC{padding-top:.5rem}.cVJMrm{padding-right:.5rem}.dPFrWx{padding-bottom:.5rem}.JxWnH{padding-left:.5rem}.dAseSU:after{border-top-width:4px}.gFfWNi:after{border-right-width:4px}.hQijyr:after{border-bottom-width:4px}.cKXpgz:after{border-left-width:4px}.jxivWg:after{border-top-color:transparent}.eoMfVT:after{border-bottom-color:transparent}.iOXMHb:after{border-left-color:transparent}.dbfKrc:after{border-top-width:2px}.jAobFs{border-top-style:none}.dQbyJV{border-right-style:none}.oTbqa{border-bottom-style:none}.gwsGKP{border-left-style:none}.SeaTL:before{border-top-width:2px}.gjJuRC:before{border-right-width:0}.iWYpgm:before{border-bottom-width:0}.iHkzF:before{border-left-width:2px}.gUiFRX:before{border-top-width:0}.dixaxG:before{border-right-width:2px}.jmWgOv:before{border-bottom-width:2px}.bTanCN:before{border-left-width:0}.gMDOZu{border-top-width:1.125em}.cgEEZJ{border-right-width:1.125em}.gqWyNB{border-bottom-width:1.125em}.ktfQGr{border-left-width:1.125em}.lpnDDz:before{border-top-width:1em}.ebRqqn:before{border-right-width:1em}.bWKMJW:before{border-bottom-width:1em}.eQlDDM:before{border-left-width:1em}.kSnqYR:before{border-top-style:solid}.fgiDpI:before{border-right-style:solid}.eeAUEW:before{border-bottom-style:solid}.ecjlX:before{border-left-style:solid}.bnSwfb:before{border-right-color:transparent}.jMYtKl:after{border-top-width:1em}.blQfIT:after{border-right-width:1em}.lijgUQ:after{border-bottom-width:1em}.ccSWYO:after{border-left-width:1em}.eGyfkC:after{border-top-style:solid}.hhBXzE:after{border-right-style:solid}.iyXZtO:after{border-bottom-style:solid}.jZLyOQ:after{border-left-style:solid}.hZGkn:after{border-right-color:transparent}.FwRrA{border-top-style:solid}.cDIyHz{border-right-style:solid}.hpBjJb{border-bottom-style:solid}.ycSPk{border-left-style:solid}@media (min-width:769px){.dXUryZ{padding-top:0}.dGtUgz{padding-right:1rem}.cQUTzq{padding-bottom:0}.bjXFvo{padding-left:1rem}.jzScEz{padding-top:2.5rem}.hMoAFf{padding-right:3rem}.bccxkr{padding-bottom:4rem}.cgjdEA{padding-left:3rem}.jZOgvY{display:flex}.uUxpw{justify-content:space-between}}@media (max-width:768px){.cElyNr{flex-direction:column}.gwFLA_D{align-items:center}}.cdhcuu:hover{color:var(--c-a)}.fItHnb:hover{background-color:var(--g-n)}*,:after,:before{box-sizing:border-box}html{-moz-tab-size:4;-o-tab-size:4;tab-size:4;line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}code,pre{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}button{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button{text-transform:none}button{-webkit-appearance:button}:root{--g:#f2f5f8;--g-m:#fff;--g-b:#fff;--g-s:#f6f7f8;--g-p:#f6f8fa;--g-c:rgba(174,184,193,.2);--g-n:rgba(67,90,111,.06);--g-t:#fff;--g-l:#f5f5f5;--g-i:#fff;--g-r:hsla(200,5%,89%,.5);--c:#2f3d4e;--c-a:#0969da;--c-s:#57606a;--c-m:#6f767d;--h6:#57606b;--b:#d8dee4;--b-t:#d0d7de;--r:0.5rem;--s-y:0.5rem;--s-x:0.35rem;--w:1000px;--s:0 4px 10px rgba(0,2,4,.06),0 0 1px rgba(0,2,4,.11);--i:0}@media(max-width:768px){:root{--s-y:0.35rem;--s-x:0.28rem}}@media(prefers-color-scheme:dark){:root:not(.light){color-scheme:dark;--g:#121212;--g-m:#21262d;--g-b:#364151;--g-s:#2f3542;--g-p:#161b22;--g-c:hsla(215,8%,47%,.4);--g-n:#3e4b5e;--g-t:#2f3542;--g-l:#2c343c;--g-i:#3b3b3b;--g-r:rgba(51,61,77,.5);--c:#c9d1d9;--c-a:#58a6ff;--c-s:#8b949e;--c-m:hsla(0,0%,100%,.659);--h6:#8b949e;--b:#757575;--b-t:#5f5f5f;--s:none;--i:1}:root:not(.light) img{filter:brightness(.8)}}body{line-height:1.5;background:var(--g);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Source Han Sans SC,Noto Sans CJK SC,Microsoft YaHei,WenQuanYi Micro Hei,WenQuanYi Zen Hei,Helvetica Neue,Arial,sans-serif;color:var(--c);overflow-y:scroll}#__next{display:flex;flex-direction:column;justify-content:space-between;min-height:100vh}*{transition:background-color .25s ease-in-out}a{color:var(--c-a);text-decoration:none}#post_markdown__nRdJ1{line-height:1.5;word-wrap:break-word}#post_markdown__nRdJ1>:first-child{margin-top:0!important}#post_markdown__nRdJ1>:last-child{margin-bottom:0!important}#post_markdown__nRdJ1 a{color:var(--c-a);-webkit-text-decoration:underline transparent;text-decoration:underline transparent;text-underline-position:under;transition:-webkit-text-decoration-color 75ms ease-in-out;transition:text-decoration-color 75ms ease-in-out;transition:text-decoration-color 75ms ease-in-out,-webkit-text-decoration-color 75ms ease-in-out}#post_markdown__nRdJ1 a:active,#post_markdown__nRdJ1 a:hover{outline-width:0}#post_markdown__nRdJ1 a:hover{-webkit-text-decoration:underline var(--c-a);text-decoration:underline var(--c-a)}#post_markdown__nRdJ1 img{border-style:none;max-width:100%;box-sizing:content-box}#post_markdown__nRdJ1 h2,#post_markdown__nRdJ1 h3{margin-top:1.5rem;margin-bottom:1rem;font-weight:700;line-height:1.25}#post_markdown__nRdJ1 h2{font-size:1.5em}#post_markdown__nRdJ1 h3{font-size:1.25em}#post_markdown__nRdJ1 p{margin-top:0;margin-bottom:.625rem}#post_markdown__nRdJ1 ol,#post_markdown__nRdJ1 ul{margin-top:0;margin-bottom:0;padding-left:2em}#post_markdown__nRdJ1 li+li{margin-top:.25em}#post_markdown__nRdJ1 code{font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:.75em;margin:0;padding:.2em .4em;background-color:var(--g-c);border-radius:6px}#post_markdown__nRdJ1 pre{padding:1rem;overflow:auto;font-size:.85em;line-height:1.45;background-color:var(--g-p);border-radius:6px;word-wrap:normal}#post_markdown__nRdJ1 pre::-webkit-scrollbar{height:var(--s-x);width:var(--s-y)}#post_markdown__nRdJ1 pre::-webkit-scrollbar-thumb{background:#b5b5b5;border-radius:var(--r)}#post_markdown__nRdJ1 pre code{font-size:100%;display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background:transparent;border:0}#post_markdown__nRdJ1 ol,#post_markdown__nRdJ1 p,#post_markdown__nRdJ1 pre,#post_markdown__nRdJ1 ul{margin-top:0;margin-bottom:1rem}#post_markdown__nRdJ1 .hljs-attr,#post_markdown__nRdJ1 .hljs-literal,#post_markdown__nRdJ1 .hljs-meta,#post_markdown__nRdJ1 .hljs-number{color:#005cc5}#post_markdown__nRdJ1 .hljs-regexp,#post_markdown__nRdJ1 .hljs-string{color:#032f62}#post_markdown__nRdJ1 .hljs-built_in{color:#e36209}#post_markdown__nRdJ1 .hljs-comment{color:#6a737d}#post_markdown__nRdJ1 .hljs-bullet{color:#735c0f}</style><link rel="stylesheet" href="https://static.cdn.baoshuo.ren/blog/_next/static/css/3fc16492cd6995f6.css" data-n-g="" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="https://static.cdn.baoshuo.ren/blog/_next/static/css/3fc16492cd6995f6.css"></noscript><link rel="stylesheet" href="https://static.cdn.baoshuo.ren/blog/_next/static/css/1550b18fa9b2cc2d.css" data-n-g="" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="https://static.cdn.baoshuo.ren/blog/_next/static/css/1550b18fa9b2cc2d.css"></noscript><link rel="stylesheet" href="https://static.cdn.baoshuo.ren/blog/_next/static/css/49e3c9be9aebdd02.css" data-n-p="" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="https://static.cdn.baoshuo.ren/blog/_next/static/css/49e3c9be9aebdd02.css"></noscript><noscript data-n-css=""></noscript></head><body><div id="__next"><div class="eDssNQ imhmwA bOjOhu WhAZY cRUUAa gZmUMJ hJfaYF KqcXP "><div class="gdPTUr jBtqwC fxkyut " style="opacity:0;width:0%"><div class="bEvNbr ktTKqx gdPTUr fxkyut dJcTkO gOeSjL kaWzRu " style="left:-5.5%"></div></div></div><div><nav class="gSBWlu kJzccJ gCwvuy eAOGpx dPAasc eSaSrN cjScYX jqaXfP cElyNr gwFLA_D dXUryZ dGtUgz cQUTzq bjXFvo " role="navigation"><a class="gSBWlu bcjLCN hriXhD foGVKH gifdxR bpQkXn fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn bBVwIW " href="/"><svg id="Main" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="caItCN dSxtaa "><path d="M471,256A214.8122,214.8122,0,0,1,256,471a216.4337,216.4337,0,0,1-40.955-3.896A214.86,214.86,0,0,1,41,256,214.9809,214.9809,0,0,1,256,41a214.4584,214.4584,0,0,1,154.4137,65.4129q6.911,7.1214,13.146,14.8661c1.3337,1.6587,2.6413,3.3258,3.9229,5.0281A214.5854,214.5854,0,0,1,471,256Z" fill="#5897d1"></path><path d="M419.2572,204.2572A163.1145,163.1145,0,0,1,256,367.5136a164.3664,164.3664,0,0,1-31.0985-2.9579A163.271,163.271,0,1,1,419.2572,204.2572Z" fill="#9fc5e6"></path><path d="M418.8558,63.0971v44.65A10.5833,10.5833,0,0,1,408.2729,118.33H333.7074V52.5134h74.5655A10.584,10.584,0,0,1,418.8558,63.0971Z" fill="#ff668c"></path><path d="M329.7492,458.0118A215.2574,215.2574,0,0,1,60.2534,345.0537l67.6679-90.0019a30.79,30.79,0,0,1,49.2216,0l38.5328,51.2574Z" fill="#343a6e"></path><path d="M408.6937,77.1989a8.2229,8.2229,0,0,1-8.2229,8.223H371.8716a8.2271,8.2271,0,0,0,0,16.4542h9.8724a8.2271,8.2271,0,1,1,0,16.4542H333.7065V52.5134h46.87a8.2238,8.2238,0,0,1,8.2229,8.2313,8.2246,8.2246,0,0,0,8.2313,8.2229h3.44A8.23,8.23,0,0,1,408.6937,77.1989Z" fill="#ef487d"></path><path d="M328.6658,41.0008h0a7.2391,7.2391,0,0,0-7.2394,7.24V230.2126h14.4789V48.24A7.24,7.24,0,0,0,328.6658,41.0008Z" fill="#f9df73"></path><path d="M454.3619,339.0513q-2.87,6.8317-6.1872,13.4266A215.3468,215.3468,0,0,1,215.045,467.104a214.1378,214.1378,0,0,1-82.1653-34.83L299.2368,211.0171a36.8115,36.8115,0,0,1,58.8571,0Z" fill="#484b7f"></path><path d="M328.67,196.3173c-5.6429,0-11.285,4.8972-15.0584,14.699L215.045,467.104a213.7775,213.7775,0,0,1-82.1653-34.83L299.2461,211.0171A36.578,36.578,0,0,1,328.67,196.3173Z" fill="#343a6e"></path><path d="M448.1747,352.4779A215.3468,215.3468,0,0,1,215.045,467.104a213.4209,213.4209,0,0,1-59.4366-20.9382L264.82,337.7974c-17.0068,44.185,31.1885,55.6372,81.2087,37.2085C391.9237,358.0939,396.8116,340.0692,448.1747,352.4779Z" fill="#343a6e"></path><path d="M215.6766,306.31c-25.6245.886-50.9072,16.0419-67.0884,16.0419-25.0106,0-54.584-22.1845-20.6661-67.2992a30.79,30.79,0,0,1,49.2216,0Z" fill="#484b7f"></path></svg><span>宝硕博客</span></a><div class="gSBWlu jYEAGD dvivnl iVncgA fQhDyl qlVwF jOHNtp PvULj hTxdYE fUqTQL "><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/">首页</a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/archives/">归档</a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/categories/">分类</a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/tags/">标签</a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/friends/">友链</a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/about/">关于</a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/atom.xml"><i class="cpOcAb cjScYX hHGIsI jXmXEB bLHLvQ eLDTYY kAVdUc dUvWpK hRLVFh julXB dhOkuk kvHVCE gbJvTx eqcbDJ efWRhG ciQIPM iqzSxf cdfZWI zJreD iSSyDr jORRks beaHbQ fqXcHQ haKUHj dyMCpl cTiRpf kLOwRz fEOdlm iiCJgG feNfPp dAseSU gFfWNi hQijyr cKXpgz eGyfkC hhBXzE iyXZtO jZLyOQ jxivWg hZGkn eoMfVT iOXMHb qMJeO dUAgBC hVfwnH jtnuen iibzBM "></i></a><a class="gSBWlu bcjLCN hriXhD foGVKH fyuAJJ bbUXPo eQmaZO eIJBjz dZrGlq hcJOFn fItHnb " href="/search/"><i class="fygwnR cpOcAb kAVdUc jXmXEB hHGIsI cjScYX bLHLvQ eLDTYY julXB kvHVCE SeaTL dixaxG jmWgOv iHkzF kSnqYR fgiDpI eeAUEW ecjlX gbJvTx eqcbDJ efWRhG ciQIPM bLLutt kKTZiz jYPXoJ kUNXjX kBZpXt fqXcHQ dyMCpl dbfKrc eGyfkC kCTVgr cDbGzW eHPmEw dmfenB "></i></a><div class="dYbGIK eKlQYW ihNVbP "><button class="jsvbrX gdPTUr gSBWlu foGVKH IVbXa eQmaZO eIJBjz dZrGlq hcJOFn jAobFs dQbyJV oTbqa gwsGKP KqcXP fItHnb "><i class="cpOcAb kAVdUc jXmXEB hHGIsI cjScYX bLHLvQ eLDTYY julXB kvHVCE bQvqKh jLmWnd SeaTL dixaxG jmWgOv iHkzF kSnqYR fgiDpI eeAUEW ecjlX jVKJhP qOQRo ftrJDm dnkCBy jYPXoJ kKTZiz fqXcHQ dyMCpl iMyxuR hwgZgR eCTYLu fPEpYf fSuxSX diZuuN elJZFC eLXBUo ebtDcN bbRNPO "></i></button></div></div></nav><main><article class="gCwvuy kRQsoY jBvrhX dgtTIu eXJtsk dvivnl llUCyD dPAasc ipEZTh eRVtDl cUXNmd jdraHW biWxPv eqrBPF"><img class="cRUUAa jYagCu gWinOH " src="https://s1.baoshuo.ren/2022/05/13/lj2cs5QNP3rWkeq.png" alt="使用 GitHub Actions 自动申请与部署 SSL 证书"><header class="jTjNVR iKck hNjeNG bmFLeF dmKgnC bMSzLf iATxZH iigETV "><h1 class="fClzDx iKck hlBtvm bmFLeF cypeLb VFfNK ">使用 GitHub Actions 自动申请与部署 SSL 证书</h1><div class="dmKgnC dwawJR dPFrWx jQenOz dgIPcR "><time datetime="2022-05-15T08:47:00.000Z">2022-05-15</time><span class="jTjNVR iawFZL hNjeNG kswRdL gKQCBv "></span><a class="fyuAJJ bbUXPo cdhcuu " href="/categories/%E6%8A%80%E6%9C%AF%E5%90%91/">技术向</a><span class="jTjNVR iawFZL hNjeNG kswRdL gKQCBv "></span><span>约 3.1 千字</span></div></header><section class="jTjNVR iKck hNjeNG bmFLeF bKjKUN bMSzLf fZMRmg iigETV kKplrA " id="post_markdown__nRdJ1"><p>对于一个有很多服务器的人来说，在不同服务器上同步 SSL 证书是一件麻烦事。笔者尝试过很多种方式，最后在 <a href="https://men.ci" rel="external nofollow noreferrer">Menci</a> 的推荐下选定了使用 GitHub Actions 来自动申请、续期 SSL 证书，并自动推送到各个服务器上。</p><span id="more"></span><p>本博客的证书也是使用这种方式进行签发、部署的，可以点击浏览器地址栏上的按钮查看证书。</p><h2 id="申请证书">申请证书</h2><h3 id="前期准备">前期准备</h3><p>首先请在本地（或自己的服务器上）成功使用 <a href="https://acme.sh" rel="external nofollow noreferrer">acme.sh</a> 的 <a href="https://letsencrypt.org/docs/challenge-types/#dns-01-challenge" rel="external nofollow noreferrer">DNS-01</a> 验证方式成功申请一次证书，如果不会操作的话可以参考 <a href="https://u.sb/acme-sh-ssl/?utm_source=blog.baoshuo.ren&amp;utm_medium=actions-ssl-cert+tutorial" rel="external nofollow noreferrer">烧饼博客的教程</a> 来进行。这个过程包括：</p><ol><li>向 CA 注册 ACME 账户（如果使用 Let’s Encrypt 则会自动进行，详细步骤请参阅 <a href="https://github.com/acmesh-official/acme.sh/wiki/ZeroSSL.com-CA" rel="external nofollow noreferrer">acme.sh 的 Wiki</a>）。</li><li>通过环境变量指定 DNS 提供商的凭据，用于添加/删除 ACME DNS-01 认证所需的 TXT 记录。</li><li>确认证书申请可以成功，为后续调试排除可能的问题。</li></ol><p>第一次申请证书后，CA 的 ACME 账户凭据将被存储到 <code>~/.acme.sh/ca</code> 中，DNS 提供商的凭据将被存储到 <code>~/.acme.sh/account.conf</code> 中。将它们打包并使用 Base64 编码存储，以备在 GitHub Actions 中使用：</p><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> ~/.acme.sh
tar cz ca account.conf | <span class="hljs-built_in">base64</span> -w0</code></pre><p>将输出内容添加到 GitHub 仓库的 Secrets 中。注意不要复制输出中的多余信息。</p><h3 id="自动化">自动化</h3><p>如果没有特殊需求，可以使用 <a href="https://github.com/Menci/acme" rel="external nofollow noreferrer">Menci/acme</a> 来简单地申请证书：</p><pre><code class="hljs yaml"><span class="hljs-comment"># 全局环境变量</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-comment"># Checkout 到的目录</span>
  <span class="hljs-attr">CERTS_OUTPUT_BASE:</span> <span class="hljs-string">certs</span>
  <span class="hljs-comment"># 证书输出目录</span>
  <span class="hljs-attr">CERTS_OUTPUT_DIRECTORY:</span> <span class="hljs-string">example.com</span>
  <span class="hljs-comment"># 证书文件名</span>
  <span class="hljs-attr">FILE_FULLCHAIN:</span> <span class="hljs-string">fullchain.pem</span>
  <span class="hljs-comment"># 私钥文件名</span>
  <span class="hljs-attr">FILE_KEY:</span> <span class="hljs-string">privatekey.key</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">issue-ssl-certificate:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Issue</span> <span class="hljs-string">SSL</span> <span class="hljs-string">certificate</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">Menci/acme@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-comment"># 指定 acme.sh 的版本</span>
          <span class="hljs-attr">version:</span> <span class="hljs-number">3.0</span><span class="hljs-number">.2</span>

          <span class="hljs-comment"># 上方保存的以 Base64 编码存储的凭据</span>
          <span class="hljs-attr">account-tar:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ACME_SH_ACCOUNT_TAR</span> <span class="hljs-string">}}</span>

          <span class="hljs-comment"># 域名列表，以空格分隔</span>
          <span class="hljs-attr">domains:</span> <span class="hljs-string">example.com</span> <span class="hljs-string">example.net</span> <span class="hljs-string">example.org</span> <span class="hljs-string">example.edu</span>
          <span class="hljs-comment"># 是否申请通配符</span>
          <span class="hljs-attr">append-wildcard:</span> <span class="hljs-literal">true</span>

          <span class="hljs-comment"># 传递给 acme.sh 的额外参数</span>
          <span class="hljs-attr">arguments:</span> <span class="hljs-string">--dns</span> <span class="hljs-string">dns_cf</span> <span class="hljs-string">--challenge-alias</span> <span class="hljs-string">example.com</span>

          <span class="hljs-comment"># 导出的证书路径</span>
          <span class="hljs-attr">output-fullchain:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_FULLCHAIN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">output-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_KEY</span> <span class="hljs-string">}}</span></code></pre><p>如果需要高度自定义 <a href="http://acme.sh" rel="external nofollow noreferrer">acme.sh</a> 的参数，比如为不同的域名设置不同的 DNS 提供商，可以使用下面的方式手动编写命令来执行：</p><pre><code class="hljs yaml"><span class="hljs-comment"># 全局环境变量</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-comment"># Checkout 到的目录</span>
  <span class="hljs-attr">CERTS_OUTPUT_BASE:</span> <span class="hljs-string">certs</span>
  <span class="hljs-comment"># 证书输出目录</span>
  <span class="hljs-attr">CERTS_OUTPUT_DIRECTORY:</span> <span class="hljs-string">example.com</span>
  <span class="hljs-comment"># 证书文件名</span>
  <span class="hljs-attr">FILE_FULLCHAIN:</span> <span class="hljs-string">fullchain.pem</span>
  <span class="hljs-comment"># 私钥文件名</span>
  <span class="hljs-attr">FILE_KEY:</span> <span class="hljs-string">privatekey.key</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">issue-ssl-certificate:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Issue</span> <span class="hljs-string">SSL</span> <span class="hljs-string">certificate</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">ref:</span> <span class="hljs-string">master</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">output</span> <span class="hljs-string">branch</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">ref:</span> <span class="hljs-string">certs</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}</span>

      <span class="hljs-comment"># 安装 acme.sh</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">acme.sh</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">curl</span> <span class="hljs-string">-s</span> <span class="hljs-string">https://get.acme.sh</span> <span class="hljs-string">|</span> <span class="hljs-string">sh</span>

      <span class="hljs-comment"># 解压 acme.sh 配置信息</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Extract</span> <span class="hljs-string">account</span> <span class="hljs-string">files</span> <span class="hljs-string">for</span> <span class="hljs-string">acme.sh</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          echo "$ACME_SH_ACCOUNT_TAR" | base64 -d | tar -C ~/.acme.sh -xz</span>
<span class="hljs-string"></span>        <span class="hljs-attr">env:</span>
          <span class="hljs-comment"># Base64 编码的 acme.sh 配置信息</span>
          <span class="hljs-attr">ACME_SH_ACCOUNT_TAR:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ACME_SH_ACCOUNT_TAR</span> <span class="hljs-string">}}</span>

      <span class="hljs-comment"># 申请证书</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Issue</span> <span class="hljs-string">SSL</span> <span class="hljs-string">certificates</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          ~/.acme.sh/acme.sh --issue        \</span>
<span class="hljs-string">            -d "example.com"   --dns dns_cf \</span>
<span class="hljs-string">            -d "*.example.com" --dns dns_cf \</span>
<span class="hljs-string">            -d "example.net"   --dns dns_dp \</span>
<span class="hljs-string">            -d "*.example.net" --dns dns_dp \</span>
<span class="hljs-string">            --server letsencrypt</span>
<span class="hljs-string"></span>
      <span class="hljs-comment"># 导出证书</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">output</span> <span class="hljs-string">paths</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          ACME_SH_TEMP_DIR="$(mktemp -d)"</span>
<span class="hljs-string">          ACME_SH_TEMP_FILE_FULLCHAIN="$ACME_SH_TEMP_DIR/fullchain.pem"</span>
<span class="hljs-string">          ACME_SH_TEMP_FILE_KEY="$ACME_SH_TEMP_DIR/key.pem"</span>
<span class="hljs-string"></span>
          <span class="hljs-string">~/.acme.sh/acme.sh</span> <span class="hljs-string">--install-cert</span> <span class="hljs-string">-d</span> <span class="hljs-string">"$ACME_SH_FIRST_DOMAIN"</span> <span class="hljs-string">--fullchain-file</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_FULLCHAIN"</span> <span class="hljs-string">--key-file</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_KEY"</span>

          [[ <span class="hljs-string">-z</span> <span class="hljs-string">"$ACME_SH_OUTPUT_FULLCHAIN"</span> ]] <span class="hljs-string">||</span> <span class="hljs-string">(mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">"$(dirname "</span><span class="hljs-string">$ACME_SH_OUTPUT_FULLCHAIN")"</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">cp</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_FULLCHAIN"</span> <span class="hljs-string">"$ACME_SH_OUTPUT_FULLCHAIN"</span><span class="hljs-string">)</span>
          [[ <span class="hljs-string">-z</span> <span class="hljs-string">"$ACME_SH_OUTPUT_KEY"</span> ]] <span class="hljs-string">||</span> <span class="hljs-string">(mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">"$(dirname "</span><span class="hljs-string">$ACME_SH_OUTPUT_KEY")"</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">cp</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_KEY"</span> <span class="hljs-string">"$ACME_SH_OUTPUT_KEY"</span><span class="hljs-string">)</span>

          <span class="hljs-string">rm</span> <span class="hljs-string">-rf</span> <span class="hljs-string">"$ACME_SH_TEMP_DIR"</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-comment"># 修改此处的 example.com 为申请时填写的第一个域名</span>
          <span class="hljs-attr">ACME_SH_FIRST_DOMAIN:</span> <span class="hljs-string">example.com</span>
          <span class="hljs-attr">ACME_SH_OUTPUT_FULLCHAIN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_FULLCHAIN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">ACME_SH_OUTPUT_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_KEY</span> <span class="hljs-string">}}</span></code></pre><h3 id="上传证书至仓库">上传证书至仓库</h3><pre><code class="hljs yaml"><span class="hljs-comment"># 上传证书</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Push</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">    git config --global user.name "BaoshuoBot"</span>
<span class="hljs-string">    git config --global user.email "79077260+BaoshuoBot@users.noreply.github.com"</span>
<span class="hljs-string"></span>
    <span class="hljs-string">cd</span> <span class="hljs-string">"$CERTS_DIRECTORY"</span>

    <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">"$FILE_FULLCHAIN"</span> <span class="hljs-string">"$FILE_KEY"</span>
    <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">"Upload certificates on $(date '+%Y-%m-%d %H:%M:%S')"</span>
    <span class="hljs-string">git</span> <span class="hljs-string">push</span>
  <span class="hljs-attr">env:</span>
    <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span>
    <span class="hljs-attr">CERTS_DIRECTORY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}</span></code></pre><h2 id="部署证书">部署证书</h2><p>在申请证书的 Job 执行完成后，可以执行一系列其他的 Job 来将证书部署到各个服务器或云服务。</p><h3 id="服务器">服务器</h3><p>可以使用 <a href="https://github.com/easingthemes/ssh-deploy" rel="external nofollow noreferrer"><code>easingthemes/ssh-deploy</code></a> 来使用 rsync 将证书同步到服务器上。同步完成后再使用 <a href="https://github.com/appleboy/ssh-action" rel="external nofollow noreferrer"><code>appleboy/ssh-action</code></a> 远程执行命令重载 Nginx / Apache。</p><pre><code class="hljs yaml"><span class="hljs-comment"># 部署到服务器</span>
<span class="hljs-attr">deploy-to-server:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span>
  <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">needs:</span> <span class="hljs-string">issue-ssl-certificate</span>

  <span class="hljs-attr">strategy:</span>
    <span class="hljs-attr">matrix:</span>
      <span class="hljs-attr">host:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-number">174.136</span><span class="hljs-number">.239</span><span class="hljs-number">.1</span> <span class="hljs-comment"># Server 1</span>
        <span class="hljs-bullet">-</span> <span class="hljs-number">174.136</span><span class="hljs-number">.239</span><span class="hljs-number">.2</span> <span class="hljs-comment"># Server 2</span>
        <span class="hljs-comment"># ...</span>
        <span class="hljs-bullet">-</span> <span class="hljs-number">174.136</span><span class="hljs-number">.239</span><span class="hljs-number">.254</span> <span class="hljs-comment"># Server N</span>

  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">ref:</span> <span class="hljs-string">certs</span>

    <span class="hljs-comment"># 上传证书</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">server</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">easingthemes/ssh-deploy@v2.1.5</span>
      <span class="hljs-attr">env:</span>
        <span class="hljs-attr">SSH_PRIVATE_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SSH_PRIVATE_KEY</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">ARGS:</span> <span class="hljs-string">'-avz --delete'</span>
        <span class="hljs-attr">REMOTE_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.host</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">REMOTE_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.REMOTE_USER</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">SOURCE:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/</span>
        <span class="hljs-attr">TARGET:</span> <span class="hljs-string">/path/to/ssl/certs/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/</span>

    <span class="hljs-comment"># 重载 Nginx</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Force-reload</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@v0.1.4</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.host</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.REMOTE_USER</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SSH_PRIVATE_KEY</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">script:</span> <span class="hljs-string">|</span>
          <span class="hljs-string">sudo</span> <span class="hljs-string">/opt/hooks/reload-nginx.sh</span></code></pre><p>需要注意的是，重载 Nginx / Apache 的命令需要 root 权限才能执行，可以采用只允许部署用户以 root 权限执行重载脚本的方式来避免出现安全问题。</p><p>在 <code>/opt/hooks</code> 目录下新建一个文件 <code>reload-nginx.sh</code>，内容如下：</p><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span>
sudo systemctl force-reload nginx</code></pre><p>然后新建一个名为 <code>actions-cert</code> 的用户，然后在 <code>/etc/sudoers</code> 文件中添加以下内容：</p><pre><code class="hljs arcade">actions-cert <span class="hljs-built_in">ALL</span>=(<span class="hljs-built_in">ALL</span>) NOPASSWD: <span class="hljs-regexp">/opt/</span>hooks/reload-nginx.sh</code></pre><p>这个配置可以使 <code>actions-cert</code> 用户免密码以 root 用户的权限执行 <code>/opt/hooks/reload-nginx.sh</code>。</p><p>最后使用 <code>chmod 755 /opt/hooks/reload-nginx.sh</code> 命令将 <code>reload-nginx.sh</code> 文件设置为可执行，同时禁止非所有者对其进行写入操作。</p><p>如果服务器位于 NAT 后，或者禁止了 SSH 连接，还有两个方法可以将证书部署到内网服务器上：</p><ol><li>将证书先部署到有部署条件的服务器上，然后再在内网服务器上使用 rsync 从部署好的服务器上拉取证书。</li><li>将证书上传到 <a href="https://azure.microsoft.com/en-us/services/key-vault/" rel="external nofollow noreferrer">Azure Key Vault</a> 等托管服务中，再在服务器上按照 <a href="https://blog.men.ci/ssl-with-github-actions/#%E6%9C%8D%E5%8A%A1%E5%99%A8" rel="external nofollow noreferrer">Menci 的文章</a> 中的教程拉取即可。</li></ol><h3 id="阿里云">阿里云</h3><p>阿里云的 <a href="https://www.aliyun.com/product/cas" rel="external nofollow noreferrer">SSL 证书服务</a> 支持上传自定义证书，该证书可以用于 <a href="https://www.aliyun.com/product/cdn" rel="external nofollow noreferrer">阿里云 CDN</a>。阿里云暂未提供将证书部署至 OSS 的 API，建议 OSS 用户使用 CDN 回源 OSS 来代替。</p><p>使用 <a href="https://github.com/Menci/deploy-certificate-to-aliyun" rel="external nofollow noreferrer">Menci/deploy-certificate-to-aliyun</a> 将证书部署到阿里云：</p><pre><code class="hljs yaml"><span class="hljs-comment"># 部署到阿里云</span>
<span class="hljs-attr">deploy-to-aliyun:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">Aliyun</span>
  <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">needs:</span> <span class="hljs-string">issue-ssl-certificate</span>

  <span class="hljs-attr">steps:</span>
    <span class="hljs-comment"># 拉取证书存储分支</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">ref:</span> <span class="hljs-string">certs</span>

    <span class="hljs-comment"># 上传证书</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">aliyun</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">Menci/deploy-certificate-to-aliyun@beta-v1</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">access-key-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ALIYUN_ACCESS_KEY_ID</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">access-key-secret:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ALIYUN_ACCESS_KEY_SECRET</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">fullchain-file:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_FULLCHAIN</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">key-file:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_KEY</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">certificate-name:</span> <span class="hljs-string">example.com</span>
        <span class="hljs-attr">cdn-domains:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          example.com</span>
<span class="hljs-string">          example.net</span></code></pre><p>其中 <code>certificate-name</code> 指定上传的证书在证书服务中的名称（将自动替换旧版本），<code>cdn-domains</code> 指定需要将该证书部署到的 CDN 域名列表（用空白字符隔开）。</p><p>建议使用子账户 Access Key，为其赋予以下权限（并按需使用资源组隔离）：</p><ul><li>AliyunYundunCertFullAccess</li><li>AliyunCDNFullAccess</li><li>AliyunPCDNFullAccess</li><li>AliyunSCDNFullAccess</li><li>AliyunDCDNFullAccess</li></ul><h3 id="腾讯云">腾讯云</h3><p>使用 <a href="https://github.com/renbaoshuo/deploy-certificate-to-tencentcloud" rel="external nofollow noreferrer">renbaoshuo/deploy-certificate-to-tencentcloud</a> 将证书部署至腾讯云 CDN：</p><pre><code class="hljs yaml"><span class="hljs-attr">deploy-to-qcloud-cdn:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">Tencent</span> <span class="hljs-string">Cloud</span> <span class="hljs-string">CDN</span>
  <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">needs:</span> <span class="hljs-string">issue-ssl-certificate</span>

  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">out</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-comment"># If you just commited and pushed your newly issued certificate to this repo in a previous job,</span>
        <span class="hljs-comment"># use `ref` to make sure checking out the newest commit in this job</span>
        <span class="hljs-attr">ref:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">}}</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">renbaoshuo/deploy-certificate-to-tencentcloud@v1</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-comment"># Use Access Key</span>
        <span class="hljs-attr">secret-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.QCLOUD_SECRET_ID</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">secret-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.QCLOUD_SECRET_KEY</span> <span class="hljs-string">}}</span>

        <span class="hljs-comment"># Specify PEM fullchain file</span>
        <span class="hljs-attr">fullchain-file:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_FULLCHAIN</span> <span class="hljs-string">}}</span>
        <span class="hljs-comment"># Specify PEM private key file</span>
        <span class="hljs-attr">key-file:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_KEY</span> <span class="hljs-string">}}</span>

        <span class="hljs-comment"># Deploy to CDN</span>
        <span class="hljs-attr">cdn-domains:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          cdn1.example.com</span>
<span class="hljs-string">          cdn2.example.com</span></code></pre><p>其中 <code>cdn-domains</code> 指定需要将该证书部署到的 CDN 域名列表（用空白字符隔开）。</p><p>建议使用子账户 API 密钥，为其赋予以下权限（并按需使用资源组隔离）：</p><ul><li>QcloudCDNFullAccess</li></ul><h3 id="自建-goedge-cdn">自建 GoEdge CDN</h3><p>使用 <a href="https://github.com/renbaoshuo/deploy-certificate-to-goedge" rel="external nofollow noreferrer"><code>renbaoshuo/deploy-certificate-to-goedge</code></a> 将证书部署至自建的 GoEdge CDN：</p><pre><code class="hljs yaml"><span class="hljs-attr">deploy-to-goedge-cdn:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">GoEdge</span> <span class="hljs-string">CDN</span>
  <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">out</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-comment"># If you just commited and pushed your newly issued certificate to this repo in a previous job,</span>
        <span class="hljs-comment"># use `ref` to make sure checking out the newest commit in this job</span>
        <span class="hljs-attr">ref:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">}}</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">renbaoshuo/deploy-certificate-to-goedge@beta-v1</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-comment"># GoEdge API endpoint</span>
        <span class="hljs-attr">api-endpoint:</span> <span class="hljs-string">https://cdn.api.baoshuo.dev</span>

        <span class="hljs-comment"># Use Access Key</span>
        <span class="hljs-attr">access-key-type:</span> <span class="hljs-string">user</span>
        <span class="hljs-attr">access-key-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GOEDGE_ACCESS_KEY_ID</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">access-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GOEDGE_ACCESS_KEY</span> <span class="hljs-string">}}</span>

        <span class="hljs-comment"># GoEdge certificate ID</span>
        <span class="hljs-attr">cert-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GOEDGE_CERT_ID</span> <span class="hljs-string">}}</span>

        <span class="hljs-comment"># Specify PEM fullchain file</span>
        <span class="hljs-attr">fullchain-file:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.FILE_FULLCHAIN</span> <span class="hljs-string">}}</span>
        <span class="hljs-comment"># Specify PEM private key file</span>
        <span class="hljs-attr">key-file:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.FILE_KEY</span> <span class="hljs-string">}}</span></code></pre><p><em>注：在部署前需要手动上传一次证书以便获取证书 ID。证书 ID 可以在「证书文件下载」处的 URL 参数中找到。</em></p><h2 id="完整例子">完整例子</h2><p>这个 Action 完成了以下操作：</p><ol><li>申请证书，并上传到仓库的 <code>certs</code> 分支。</li><li>在申请证书后将 <code>certs</code> 分支中的证书部署到服务器上。</li></ol><pre><code class="hljs yaml"><span class="hljs-comment"># 名称</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Issue</span> <span class="hljs-string">SSL</span> <span class="hljs-string">Certificates</span>

<span class="hljs-comment"># 触发条件</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-comment"># 手动运行</span>
  <span class="hljs-attr">workflow_dispatch:</span>
  <span class="hljs-comment"># 定时运行</span>
  <span class="hljs-attr">schedule:</span>
    <span class="hljs-comment"># 每两个月运行一次</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">'0 0 1 */2 *'</span>

<span class="hljs-comment"># 全局环境变量</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-comment"># Checkout 到的目录</span>
  <span class="hljs-attr">CERTS_OUTPUT_BASE:</span> <span class="hljs-string">certs</span>
  <span class="hljs-comment"># 证书输出目录</span>
  <span class="hljs-attr">CERTS_OUTPUT_DIRECTORY:</span> <span class="hljs-string">example.com</span>
  <span class="hljs-comment"># 证书文件名</span>
  <span class="hljs-attr">FILE_FULLCHAIN:</span> <span class="hljs-string">fullchain.pem</span>
  <span class="hljs-comment"># 私钥文件名</span>
  <span class="hljs-attr">FILE_KEY:</span> <span class="hljs-string">privatekey.key</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">issue-ssl-certificate:</span>
    <span class="hljs-comment"># 申请证书并 push 到 certs 分支</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Issue</span> <span class="hljs-string">SSL</span> <span class="hljs-string">certificate</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">ref:</span> <span class="hljs-string">master</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">output</span> <span class="hljs-string">branch</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">ref:</span> <span class="hljs-string">certs</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}</span>

      <span class="hljs-comment"># 安装 acme.sh</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">acme.sh</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">curl</span> <span class="hljs-string">-s</span> <span class="hljs-string">https://get.acme.sh</span> <span class="hljs-string">|</span> <span class="hljs-string">sh</span>

      <span class="hljs-comment"># 解压 acme.sh 配置信息</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Extract</span> <span class="hljs-string">account</span> <span class="hljs-string">files</span> <span class="hljs-string">for</span> <span class="hljs-string">acme.sh</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          echo "$ACME_SH_ACCOUNT_TAR" | base64 -d | tar -C ~/.acme.sh -xz</span>
<span class="hljs-string"></span>        <span class="hljs-attr">env:</span>
          <span class="hljs-comment"># Base64 编码的 acme.sh 配置信息</span>
          <span class="hljs-attr">ACME_SH_ACCOUNT_TAR:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ACME_SH_ACCOUNT_TAR</span> <span class="hljs-string">}}</span>

      <span class="hljs-comment"># 申请证书</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Issue</span> <span class="hljs-string">SSL</span> <span class="hljs-string">certificates</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          ~/.acme.sh/acme.sh --issue            \</span>
<span class="hljs-string">            -d "example.com" -d "*.example.com" \</span>
<span class="hljs-string">            --dns dns_cf --server letsencrypt</span>
<span class="hljs-string"></span>
      <span class="hljs-comment"># 导出证书</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">output</span> <span class="hljs-string">paths</span>
        <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          ACME_SH_TEMP_DIR="$(mktemp -d)"</span>
<span class="hljs-string">          ACME_SH_TEMP_FILE_FULLCHAIN="$ACME_SH_TEMP_DIR/fullchain.pem"</span>
<span class="hljs-string">          ACME_SH_TEMP_FILE_KEY="$ACME_SH_TEMP_DIR/key.pem"</span>
<span class="hljs-string"></span>
          <span class="hljs-comment"># 不要忘记修改这里的 -d 参数值为上方的第一个域名</span>
          <span class="hljs-string">~/.acme.sh/acme.sh</span> <span class="hljs-string">--install-cert</span> <span class="hljs-string">-d</span> <span class="hljs-string">"example.com"</span> <span class="hljs-string">--fullchain-file</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_FULLCHAIN"</span> <span class="hljs-string">--key-file</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_KEY"</span>

          [[ <span class="hljs-string">-z</span> <span class="hljs-string">"$ACME_SH_OUTPUT_FULLCHAIN"</span> ]] <span class="hljs-string">||</span> <span class="hljs-string">(mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">"$(dirname "</span><span class="hljs-string">$ACME_SH_OUTPUT_FULLCHAIN")"</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">cp</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_FULLCHAIN"</span> <span class="hljs-string">"$ACME_SH_OUTPUT_FULLCHAIN"</span><span class="hljs-string">)</span>
          [[ <span class="hljs-string">-z</span> <span class="hljs-string">"$ACME_SH_OUTPUT_KEY"</span> ]] <span class="hljs-string">||</span> <span class="hljs-string">(mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">"$(dirname "</span><span class="hljs-string">$ACME_SH_OUTPUT_KEY")"</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">cp</span> <span class="hljs-string">"$ACME_SH_TEMP_FILE_KEY"</span> <span class="hljs-string">"$ACME_SH_OUTPUT_KEY"</span><span class="hljs-string">)</span>

          <span class="hljs-string">rm</span> <span class="hljs-string">-rf</span> <span class="hljs-string">"$ACME_SH_TEMP_DIR"</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">ACME_SH_OUTPUT_FULLCHAIN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_FULLCHAIN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">ACME_SH_OUTPUT_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.FILE_KEY</span> <span class="hljs-string">}}</span>

      <span class="hljs-comment"># 上传证书</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Push</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>
<span class="hljs-string">          git config --global user.name "BaoshuoBot"</span>
<span class="hljs-string">          git config --global user.email "79077260+BaoshuoBot@users.noreply.github.com"</span>
<span class="hljs-string"></span>
          <span class="hljs-string">cd</span> <span class="hljs-string">"$CERTS_DIRECTORY"</span>

          <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">"$FILE_FULLCHAIN"</span> <span class="hljs-string">"$FILE_KEY"</span>
          <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">"Upload certificates on $(date '+%Y-%m-%d %H:%M:%S')"</span>
          <span class="hljs-string">git</span> <span class="hljs-string">push</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span>
          <span class="hljs-attr">CERTS_DIRECTORY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_BASE</span> <span class="hljs-string">}}/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}</span>

  <span class="hljs-comment"># 部署证书到服务器</span>
  <span class="hljs-attr">deploy-to-server:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">issue-ssl-certificate</span>

    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">host:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">174.136</span><span class="hljs-number">.239</span><span class="hljs-number">.1</span> <span class="hljs-comment"># Server 1</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">174.136</span><span class="hljs-number">.239</span><span class="hljs-number">.2</span> <span class="hljs-comment"># Server 2</span>
          <span class="hljs-comment"># ...</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">174.136</span><span class="hljs-number">.239</span><span class="hljs-number">.254</span> <span class="hljs-comment"># Server N</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">ref:</span> <span class="hljs-string">certs</span>

      <span class="hljs-comment"># 上传证书</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">certificate</span> <span class="hljs-string">to</span> <span class="hljs-string">server</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">easingthemes/ssh-deploy@v2.1.5</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SSH_PRIVATE_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SSH_PRIVATE_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">ARGS:</span> <span class="hljs-string">'-avz --delete'</span>
          <span class="hljs-attr">REMOTE_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.host</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">REMOTE_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.REMOTE_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">SOURCE:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/</span>
          <span class="hljs-attr">TARGET:</span> <span class="hljs-string">/path/to/ssl/certs/${{</span> <span class="hljs-string">env.CERTS_OUTPUT_DIRECTORY</span> <span class="hljs-string">}}/</span>

      <span class="hljs-comment"># 重载 Nginx</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Force-reload</span> <span class="hljs-string">nginx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@v0.1.4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.host</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.REMOTE_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SSH_PRIVATE_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|</span>
            <span class="hljs-string">sudo</span> <span class="hljs-string">/opt/hooks/reload-nginx.sh</span></code></pre><h2 id="杂项">杂项</h2><p>部分情况下，GitHub Actions 中的 <code>GITHUB_TOKEN</code> 只有 Read repository contents permission，而本文中的 Actions 要求这个 Token 具有 Read and write permissions，那么需要在仓库的 Settings &gt; Actions &gt; General 页面的底部赋予其写入权限，如图所示：</p><p><img src="https://s1.baoshuo.ren/2022/05/15/WA5tTau3mnBLIqZ.png" alt="" loading="lazy"></p><p>设置好后点击 Save 按钮即可。</p><h2 id="参考资料">参考资料</h2><ol><li><a href="https://blog.men.ci/ssl-with-github-actions/" rel="external nofollow noreferrer">使用 GitHub Actions 自动申请与部署 ACME SSL 证书</a>，Menci，2022 年 5 月 11 日。对原文章内容的使用已经过作者同意。</li><li><a href="https://u.sb/acme-sh-ssl/" rel="external nofollow noreferrer">使用 acme.sh 配置自动续签 SSL 证书</a>，烧饼博客，2022 年 2 月 3 日。</li></ol><p>文章头图由 <a href="https://men.ci" rel="external nofollow noreferrer">Menci</a> 制作，使用已经过授权，在此表示感谢。</p></section><div class="cjScYX jnGacs kpCrIt bMSzLf cvPkWa iigETV dUvWpK hRLVFh "><div class="bpQkXn ">使用 GitHub Actions 自动申请与部署 SSL 证书</div><div><a class="kpaoc dLUwcr gcQrEv cdhcuu " href="/post/actions-ssl-cert/">https://blog.baoshuo.ren/post/actions-ssl-cert/</a></div><div class="gSBWlu kiDYix cUXNmd "><div class="gSBWlu iMkoWi hriXhD jjryqL biWxPv "><div class="chVqDG ">本文作者</div><div><a class="fyuAJJ bbUXPo cdhcuu " href="https://baoshuo.ren" target="_blank">宝硕</a></div></div><div class="gSBWlu iMkoWi hriXhD jjryqL biWxPv "><div class="chVqDG ">发布于</div><time datetime="2022-05-15T08:47:00.000Z">2022-05-15</time></div><div class="gSBWlu iMkoWi hriXhD jjryqL biWxPv "><div class="chVqDG ">更新于</div><time>2022-12-18</time></div><div class="gSBWlu iMkoWi hriXhD jjryqL biWxPv "><div class="chVqDG ">版权协议</div><div><a class="fyuAJJ bbUXPo cdhcuu " href="https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode.zh-Hans" target="_blank" rel="license noopener noreferrer">CC BY-NC-SA 4.0</a></div></div></div><div class="chVqDG ">转载或引用本文时请遵守许可协议，注明出处、不得用于商业用途！</div><i class="cpOcAb bEvNbr eLDTYY iRjWhb QcCvg jdKAzd krZeLX gjJDYK dZDNG gMDOZu cgEEZJ gqWyNB ktfQGr FwRrA cDIyHz hpBjJb ycSPk ctWdVF jkGfDR bSTogt hSDpeY julXB kvHVCE lpnDDz ebRqqn bWKMJW eQlDDM kSnqYR fgiDpI eeAUEW ecjlX cDxIqC jpWidM jzdNVF bPkdhG bnSwfb fQfkux dPenaT NpaJd jgAayQ fqXcHQ dyMCpl jMYtKl blQfIT lijgUQ ccSWYO eGyfkC hhBXzE iyXZtO jZLyOQ beJoMJ iJgiCW hqUHPA jWWlrr hZGkn chpxwD beuMzX dbtvqd jPcnDC "></i></div><div class="kroOag icKiSN bMSzLf fZMRmg iigETV "><a class="kpaoc bbUXPo dSxtaa cdhcuu " href="/tags/SSL/"># <!-- -->SSL</a><a class="kpaoc bbUXPo dSxtaa cdhcuu " href="/tags/GitHub-Actions/"># <!-- -->GitHub Actions</a><a class="kpaoc bbUXPo dSxtaa cdhcuu " href="/tags/ACME/"># <!-- -->ACME</a><a class="kpaoc bbUXPo dSxtaa cdhcuu " href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"># <!-- -->阿里云</a></div></article><div class="gCwvuy kRQsoY jBvrhX dgtTIu eXJtsk dvivnl llUCyD dPAasc icKiSN bMSzLf fZMRmg iigETV ipEZTh eRVtDl cUXNmd jdraHW biWxPv eqrBPF kooHYa kroOag"><div>喜欢这篇文章？为什么不考虑打赏一下作者呢？</div><a class="cyerGB moyUB lexxaO ebVilo kyhYEz jIkFRm gpptow bbUXPo kMKXDC ftIldC jOeduE iDuqPI cpOcAb eAOGpx " href="https://afdian.net/@baoshuo" target="_blank" rel="noopener noreferrer">爱发电</a></div><div class="gSBWlu ipEZTh eRVtDl cUXNmd jdraHW biWxPv eqrBPF gvwkfp bRNbBj"><div class="gSBWlu dQPgRK eKlQYW bLlOeF fPWmiY hmKFEM "><a class="gSBWlu foGVKH dgIPcR kVZHcH cVJMrm iATxZH JxWnH " href="/post/atomic-css-in-js/"><i class="dSxtaa bLHLvQ eLDTYY cjScYX cpOcAb jXmXEB hHGIsI julXB kvHVCE jbzBdl SeaTL gjJuRC iWYpgm iHkzF kSnqYR fgiDpI eeAUEW ecjlX fIXfpL ergVCo cqyuit hCTuXM "></i>拥抱 Atomic CSS-in-JS</a></div><div class="gSBWlu dQPgRK eKlQYW bLlOeF fXzCvR klEWBS "><a class="gSBWlu foGVKH dgIPcR kVZHcH cVJMrm iATxZH JxWnH " href="/post/uninstall-samsung-extra-dual-app/">强制卸载三星应用分身中的残留应用<i class="kUPESX bLHLvQ eLDTYY cjScYX cpOcAb jXmXEB hHGIsI julXB kvHVCE jbzBdl gUiFRX dixaxG jmWgOv bTanCN kSnqYR fgiDpI eeAUEW ecjlX fIXfpL ergVCo cqyuit hCTuXM "></i></a></div></div><div></div></main></div><div class="imhmwA sKExc bjOGUo eSaSrN "><div class="fyuAJJ kQBRAp bcfNhz edKxdA osxXp foquGP lhTVEC kRQsoY jBvrhX dgtTIu eXJtsk cyerGB egGyMq jsvbrX dPAasc "><i class="cpOcAb cjScYX hHGIsI jXmXEB bLHLvQ eLDTYY dhOkuk julXB hCTuXM cqyuit kvHVCE SeaTL kSnqYR jFCJJY iqzSxf bQvqKh "></i></div><a class="fyuAJJ kQBRAp bcfNhz edKxdA osxXp foquGP lhTVEC kRQsoY jBvrhX dgtTIu eXJtsk cyerGB egGyMq jsvbrX dPAasc " href="#"><i class="cpOcAb cjScYX hHGIsI jXmXEB bLHLvQ eLDTYY dhOkuk julXB hCTuXM cqyuit kvHVCE kSnqYR fgiDpI eeAUEW ecjlX SeaTL gjJuRC iWYpgm iHkzF ergVCo jbBqfU fIXfpL "></i></a></div><footer class="eGElBa ftIldC eBrwtd iDuqPI kpaoc gCwvuy kooHYa eAOGpx dPAasc kKplrA jzScEz hMoAFf bccxkr cgjdEA "><div class="kQBRAp kroOag jZOgvY uUxpw "><div>Copyright © 2019 - <!-- -->2022<!-- --> <a class="fyuAJJ jSOKOm cdhcuu kOZsAO " href="/">宝硕博客</a><span class="jTjNVR iawFZL hNjeNG kswRdL gKQCBv "></span><a class="fyuAJJ jSOKOm cdhcuu kOZsAO " href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferer nofollow">冀ICP备15024669号-3</a></div><div>Powered by<!-- --> <a class="laXLGQ jSOKOm cdhcuu " href="https://nextjs.org" target="_blank" rel="noopener noreferer nofollow">Next.js</a> &amp; <a class="laXLGQ jSOKOm cdhcuu " href="https://hexo.io" target="_blank" rel="noopener noreferer nofollow">Hexo</a><span class="jTjNVR iawFZL hNjeNG kswRdL gKQCBv "></span>Theme by<!-- --> <a class="laXLGQ jSOKOm cdhcuu " href="https://baoshuo.ren" target="_blank">Baoshuo</a></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"使用 GitHub Actions 自动申请与部署 SSL 证书 - 宝硕博客","post":{"title":"使用 GitHub Actions 自动申请与部署 SSL 证书","excerpt":"对于一个有很多服务器的人来说，在不同服务器上同步 SSL 证书是一件麻烦事。笔者尝试过很多种方式，最后在 Menci 的推荐下选定了使用 GitHub Actions 来自动申请、续期 SSL 证书，并自动推送到各个服务器上。","content":[["$","p",{},["对于一个有很多服务器的人来说，在不同服务器上同步 SSL 证书是一件麻烦事。笔者尝试过很多种方式，最后在 ",["$","a",{"href":"https://men.ci","rel":"external nofollow noreferrer"},["Menci"]]," 的推荐下选定了使用 GitHub Actions 来自动申请、续期 SSL 证书，并自动推送到各个服务器上。"]],["$","span",{"id":"more"},[]],["$","p",{},["本博客的证书也是使用这种方式进行签发、部署的，可以点击浏览器地址栏上的按钮查看证书。"]],["$","h2",{"id":"申请证书"},["申请证书"]],["$","h3",{"id":"前期准备"},["前期准备"]],["$","p",{},["首先请在本地（或自己的服务器上）成功使用 ",["$","a",{"href":"https://acme.sh","rel":"external nofollow noreferrer"},["acme.sh"]]," 的 ",["$","a",{"href":"https://letsencrypt.org/docs/challenge-types/#dns-01-challenge","rel":"external nofollow noreferrer"},["DNS-01"]]," 验证方式成功申请一次证书，如果不会操作的话可以参考 ",["$","a",{"href":"https://u.sb/acme-sh-ssl/?utm_source=blog.baoshuo.ren\u0026utm_medium=actions-ssl-cert+tutorial","rel":"external nofollow noreferrer"},["烧饼博客的教程"]]," 来进行。这个过程包括："]],["$","ol",{},[["$","li",{},["向 CA 注册 ACME 账户（如果使用 Let’s Encrypt 则会自动进行，详细步骤请参阅 ",["$","a",{"href":"https://github.com/acmesh-official/acme.sh/wiki/ZeroSSL.com-CA","rel":"external nofollow noreferrer"},["acme.sh 的 Wiki"]],"）。"]],["$","li",{},["通过环境变量指定 DNS 提供商的凭据，用于添加/删除 ACME DNS-01 认证所需的 TXT 记录。"]],["$","li",{},["确认证书申请可以成功，为后续调试排除可能的问题。"]]]],["$","p",{},["第一次申请证书后，CA 的 ACME 账户凭据将被存储到 ",["$","code",{},["~/.acme.sh/ca"]]," 中，DNS 提供商的凭据将被存储到 ",["$","code",{},["~/.acme.sh/account.conf"]]," 中。将它们打包并使用 Base64 编码存储，以备在 GitHub Actions 中使用："]],["$","pre",{},[["$","code",{"class":"hljs sh"},[["$","span",{"class":"hljs-built_in"},["cd"]]," ~/.acme.sh\ntar cz ca account.conf | ",["$","span",{"class":"hljs-built_in"},["base64"]]," -w0"]]]],["$","p",{},["将输出内容添加到 GitHub 仓库的 Secrets 中。注意不要复制输出中的多余信息。"]],["$","h3",{"id":"自动化"},["自动化"]],["$","p",{},["如果没有特殊需求，可以使用 ",["$","a",{"href":"https://github.com/Menci/acme","rel":"external nofollow noreferrer"},["Menci/acme"]]," 来简单地申请证书："]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-comment"},["# 全局环境变量"]],"\n",["$","span",{"class":"hljs-attr"},["env:"]],"\n  ",["$","span",{"class":"hljs-comment"},["# Checkout 到的目录"]],"\n  ",["$","span",{"class":"hljs-attr"},["CERTS_OUTPUT_BASE:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 证书输出目录"]],"\n  ",["$","span",{"class":"hljs-attr"},["CERTS_OUTPUT_DIRECTORY:"]]," ",["$","span",{"class":"hljs-string"},["example.com"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 证书文件名"]],"\n  ",["$","span",{"class":"hljs-attr"},["FILE_FULLCHAIN:"]]," ",["$","span",{"class":"hljs-string"},["fullchain.pem"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 私钥文件名"]],"\n  ",["$","span",{"class":"hljs-attr"},["FILE_KEY:"]]," ",["$","span",{"class":"hljs-string"},["privatekey.key"]],"\n\n",["$","span",{"class":"hljs-attr"},["jobs:"]],"\n  ",["$","span",{"class":"hljs-attr"},["issue-ssl-certificate:"]],"\n    ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Issue"]]," ",["$","span",{"class":"hljs-string"},["SSL"]]," ",["$","span",{"class":"hljs-string"},["certificate"]],"\n    ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n    ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["Menci/acme@v2"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-comment"},["# 指定 acme.sh 的版本"]],"\n          ",["$","span",{"class":"hljs-attr"},["version:"]]," ",["$","span",{"class":"hljs-number"},["3.0"]],["$","span",{"class":"hljs-number"},[".2"]],"\n\n          ",["$","span",{"class":"hljs-comment"},["# 上方保存的以 Base64 编码存储的凭据"]],"\n          ",["$","span",{"class":"hljs-attr"},["account-tar:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.ACME_SH_ACCOUNT_TAR"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n          ",["$","span",{"class":"hljs-comment"},["# 域名列表，以空格分隔"]],"\n          ",["$","span",{"class":"hljs-attr"},["domains:"]]," ",["$","span",{"class":"hljs-string"},["example.com"]]," ",["$","span",{"class":"hljs-string"},["example.net"]]," ",["$","span",{"class":"hljs-string"},["example.org"]]," ",["$","span",{"class":"hljs-string"},["example.edu"]],"\n          ",["$","span",{"class":"hljs-comment"},["# 是否申请通配符"]],"\n          ",["$","span",{"class":"hljs-attr"},["append-wildcard:"]]," ",["$","span",{"class":"hljs-literal"},["true"]],"\n\n          ",["$","span",{"class":"hljs-comment"},["# 传递给 acme.sh 的额外参数"]],"\n          ",["$","span",{"class":"hljs-attr"},["arguments:"]]," ",["$","span",{"class":"hljs-string"},["--dns"]]," ",["$","span",{"class":"hljs-string"},["dns_cf"]]," ",["$","span",{"class":"hljs-string"},["--challenge-alias"]]," ",["$","span",{"class":"hljs-string"},["example.com"]],"\n\n          ",["$","span",{"class":"hljs-comment"},["# 导出的证书路径"]],"\n          ",["$","span",{"class":"hljs-attr"},["output-fullchain:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_FULLCHAIN"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["output-key:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]]]]]],["$","p",{},["如果需要高度自定义 ",["$","a",{"href":"http://acme.sh","rel":"external nofollow noreferrer"},["acme.sh"]]," 的参数，比如为不同的域名设置不同的 DNS 提供商，可以使用下面的方式手动编写命令来执行："]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-comment"},["# 全局环境变量"]],"\n",["$","span",{"class":"hljs-attr"},["env:"]],"\n  ",["$","span",{"class":"hljs-comment"},["# Checkout 到的目录"]],"\n  ",["$","span",{"class":"hljs-attr"},["CERTS_OUTPUT_BASE:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 证书输出目录"]],"\n  ",["$","span",{"class":"hljs-attr"},["CERTS_OUTPUT_DIRECTORY:"]]," ",["$","span",{"class":"hljs-string"},["example.com"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 证书文件名"]],"\n  ",["$","span",{"class":"hljs-attr"},["FILE_FULLCHAIN:"]]," ",["$","span",{"class":"hljs-string"},["fullchain.pem"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 私钥文件名"]],"\n  ",["$","span",{"class":"hljs-attr"},["FILE_KEY:"]]," ",["$","span",{"class":"hljs-string"},["privatekey.key"]],"\n\n",["$","span",{"class":"hljs-attr"},["jobs:"]],"\n  ",["$","span",{"class":"hljs-attr"},["issue-ssl-certificate:"]],"\n    ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Issue"]]," ",["$","span",{"class":"hljs-string"},["SSL"]]," ",["$","span",{"class":"hljs-string"},["certificate"]],"\n    ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n    ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["master"]],"\n\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]]," ",["$","span",{"class":"hljs-string"},["output"]]," ",["$","span",{"class":"hljs-string"},["branch"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n          ",["$","span",{"class":"hljs-attr"},["path:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 安装 acme.sh"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Install"]]," ",["$","span",{"class":"hljs-string"},["acme.sh"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["curl"]]," ",["$","span",{"class":"hljs-string"},["-s"]]," ",["$","span",{"class":"hljs-string"},["https://get.acme.sh"]]," ",["$","span",{"class":"hljs-string"},["|"]]," ",["$","span",{"class":"hljs-string"},["sh"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 解压 acme.sh 配置信息"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Extract"]]," ",["$","span",{"class":"hljs-string"},["account"]]," ",["$","span",{"class":"hljs-string"},["files"]]," ",["$","span",{"class":"hljs-string"},["for"]]," ",["$","span",{"class":"hljs-string"},["acme.sh"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          echo \"$ACME_SH_ACCOUNT_TAR\" | base64 -d | tar -C ~/.acme.sh -xz"]],"\n",["$","span",{"class":"hljs-string"},[]],"        ",["$","span",{"class":"hljs-attr"},["env:"]],"\n          ",["$","span",{"class":"hljs-comment"},["# Base64 编码的 acme.sh 配置信息"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_ACCOUNT_TAR:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.ACME_SH_ACCOUNT_TAR"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 申请证书"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Issue"]]," ",["$","span",{"class":"hljs-string"},["SSL"]]," ",["$","span",{"class":"hljs-string"},["certificates"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          ~/.acme.sh/acme.sh --issue        \\"]],"\n",["$","span",{"class":"hljs-string"},["            -d \"example.com\"   --dns dns_cf \\"]],"\n",["$","span",{"class":"hljs-string"},["            -d \"*.example.com\" --dns dns_cf \\"]],"\n",["$","span",{"class":"hljs-string"},["            -d \"example.net\"   --dns dns_dp \\"]],"\n",["$","span",{"class":"hljs-string"},["            -d \"*.example.net\" --dns dns_dp \\"]],"\n",["$","span",{"class":"hljs-string"},["            --server letsencrypt"]],"\n",["$","span",{"class":"hljs-string"},[]],"\n      ",["$","span",{"class":"hljs-comment"},["# 导出证书"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Copy"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["output"]]," ",["$","span",{"class":"hljs-string"},["paths"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          ACME_SH_TEMP_DIR=\"$(mktemp -d)\""]],"\n",["$","span",{"class":"hljs-string"},["          ACME_SH_TEMP_FILE_FULLCHAIN=\"$ACME_SH_TEMP_DIR/fullchain.pem\""]],"\n",["$","span",{"class":"hljs-string"},["          ACME_SH_TEMP_FILE_KEY=\"$ACME_SH_TEMP_DIR/key.pem\""]],"\n",["$","span",{"class":"hljs-string"},[]],"\n          ",["$","span",{"class":"hljs-string"},["~/.acme.sh/acme.sh"]]," ",["$","span",{"class":"hljs-string"},["--install-cert"]]," ",["$","span",{"class":"hljs-string"},["-d"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_FIRST_DOMAIN\""]]," ",["$","span",{"class":"hljs-string"},["--fullchain-file"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_FULLCHAIN\""]]," ",["$","span",{"class":"hljs-string"},["--key-file"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_KEY\""]],"\n\n          [[ ",["$","span",{"class":"hljs-string"},["-z"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_FULLCHAIN\""]]," ]] ",["$","span",{"class":"hljs-string"},["||"]]," ",["$","span",{"class":"hljs-string"},["(mkdir"]]," ",["$","span",{"class":"hljs-string"},["-p"]]," ",["$","span",{"class":"hljs-string"},["\"$(dirname \""]],["$","span",{"class":"hljs-string"},["$ACME_SH_OUTPUT_FULLCHAIN\")\""]]," ",["$","span",{"class":"hljs-string"},["\u0026\u0026"]]," ",["$","span",{"class":"hljs-string"},["cp"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_FULLCHAIN\""]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_FULLCHAIN\""]],["$","span",{"class":"hljs-string"},[")"]],"\n          [[ ",["$","span",{"class":"hljs-string"},["-z"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_KEY\""]]," ]] ",["$","span",{"class":"hljs-string"},["||"]]," ",["$","span",{"class":"hljs-string"},["(mkdir"]]," ",["$","span",{"class":"hljs-string"},["-p"]]," ",["$","span",{"class":"hljs-string"},["\"$(dirname \""]],["$","span",{"class":"hljs-string"},["$ACME_SH_OUTPUT_KEY\")\""]]," ",["$","span",{"class":"hljs-string"},["\u0026\u0026"]]," ",["$","span",{"class":"hljs-string"},["cp"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_KEY\""]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_KEY\""]],["$","span",{"class":"hljs-string"},[")"]],"\n\n          ",["$","span",{"class":"hljs-string"},["rm"]]," ",["$","span",{"class":"hljs-string"},["-rf"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_DIR\""]],"\n        ",["$","span",{"class":"hljs-attr"},["env:"]],"\n          ",["$","span",{"class":"hljs-comment"},["# 修改此处的 example.com 为申请时填写的第一个域名"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_FIRST_DOMAIN:"]]," ",["$","span",{"class":"hljs-string"},["example.com"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_OUTPUT_FULLCHAIN:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_FULLCHAIN"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_OUTPUT_KEY:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]]]]]],["$","h3",{"id":"上传证书至仓库"},["上传证书至仓库"]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-comment"},["# 上传证书"]],"\n",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Push"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["GitHub"]],"\n  ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["    git config --global user.name \"BaoshuoBot\""]],"\n",["$","span",{"class":"hljs-string"},["    git config --global user.email \"79077260+BaoshuoBot@users.noreply.github.com\""]],"\n",["$","span",{"class":"hljs-string"},[]],"\n    ",["$","span",{"class":"hljs-string"},["cd"]]," ",["$","span",{"class":"hljs-string"},["\"$CERTS_DIRECTORY\""]],"\n\n    ",["$","span",{"class":"hljs-string"},["git"]]," ",["$","span",{"class":"hljs-string"},["add"]]," ",["$","span",{"class":"hljs-string"},["\"$FILE_FULLCHAIN\""]]," ",["$","span",{"class":"hljs-string"},["\"$FILE_KEY\""]],"\n    ",["$","span",{"class":"hljs-string"},["git"]]," ",["$","span",{"class":"hljs-string"},["commit"]]," ",["$","span",{"class":"hljs-string"},["-m"]]," ",["$","span",{"class":"hljs-string"},["\"Upload certificates on $(date '+%Y-%m-%d %H:%M:%S')\""]],"\n    ",["$","span",{"class":"hljs-string"},["git"]]," ",["$","span",{"class":"hljs-string"},["push"]],"\n  ",["$","span",{"class":"hljs-attr"},["env:"]],"\n    ",["$","span",{"class":"hljs-attr"},["TZ:"]]," ",["$","span",{"class":"hljs-string"},["Asia/Shanghai"]],"\n    ",["$","span",{"class":"hljs-attr"},["CERTS_DIRECTORY:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}"]]]]]],["$","h2",{"id":"部署证书"},["部署证书"]],["$","p",{},["在申请证书的 Job 执行完成后，可以执行一系列其他的 Job 来将证书部署到各个服务器或云服务。"]],["$","h3",{"id":"服务器"},["服务器"]],["$","p",{},["可以使用 ",["$","a",{"href":"https://github.com/easingthemes/ssh-deploy","rel":"external nofollow noreferrer"},[["$","code",{},["easingthemes/ssh-deploy"]]]]," 来使用 rsync 将证书同步到服务器上。同步完成后再使用 ",["$","a",{"href":"https://github.com/appleboy/ssh-action","rel":"external nofollow noreferrer"},[["$","code",{},["appleboy/ssh-action"]]]]," 远程执行命令重载 Nginx / Apache。"]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-comment"},["# 部署到服务器"]],"\n",["$","span",{"class":"hljs-attr"},["deploy-to-server:"]],"\n  ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Deploy"]]," ",["$","span",{"class":"hljs-string"},["Certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["Server"]],"\n  ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n  ",["$","span",{"class":"hljs-attr"},["needs:"]]," ",["$","span",{"class":"hljs-string"},["issue-ssl-certificate"]],"\n\n  ",["$","span",{"class":"hljs-attr"},["strategy:"]],"\n    ",["$","span",{"class":"hljs-attr"},["matrix:"]],"\n      ",["$","span",{"class":"hljs-attr"},["host:"]],"\n        ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-number"},["174.136"]],["$","span",{"class":"hljs-number"},[".239"]],["$","span",{"class":"hljs-number"},[".1"]]," ",["$","span",{"class":"hljs-comment"},["# Server 1"]],"\n        ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-number"},["174.136"]],["$","span",{"class":"hljs-number"},[".239"]],["$","span",{"class":"hljs-number"},[".2"]]," ",["$","span",{"class":"hljs-comment"},["# Server 2"]],"\n        ",["$","span",{"class":"hljs-comment"},["# ..."]],"\n        ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-number"},["174.136"]],["$","span",{"class":"hljs-number"},[".239"]],["$","span",{"class":"hljs-number"},[".254"]]," ",["$","span",{"class":"hljs-comment"},["# Server N"]],"\n\n  ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n\n    ",["$","span",{"class":"hljs-comment"},["# 上传证书"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Upload"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["server"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["easingthemes/ssh-deploy@v2.1.5"]],"\n      ",["$","span",{"class":"hljs-attr"},["env:"]],"\n        ",["$","span",{"class":"hljs-attr"},["SSH_PRIVATE_KEY:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.SSH_PRIVATE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["ARGS:"]]," ",["$","span",{"class":"hljs-string"},["'-avz --delete'"]],"\n        ",["$","span",{"class":"hljs-attr"},["REMOTE_HOST:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["matrix.host"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["REMOTE_USER:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.REMOTE_USER"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["SOURCE:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/"]],"\n        ",["$","span",{"class":"hljs-attr"},["TARGET:"]]," ",["$","span",{"class":"hljs-string"},["/path/to/ssl/certs/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/"]],"\n\n    ",["$","span",{"class":"hljs-comment"},["# 重载 Nginx"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Force-reload"]]," ",["$","span",{"class":"hljs-string"},["nginx"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["appleboy/ssh-action@v0.1.4"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-attr"},["host:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["matrix.host"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["username:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.REMOTE_USER"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["key:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.SSH_PRIVATE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["script:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n          ",["$","span",{"class":"hljs-string"},["sudo"]]," ",["$","span",{"class":"hljs-string"},["/opt/hooks/reload-nginx.sh"]]]]]],["$","p",{},["需要注意的是，重载 Nginx / Apache 的命令需要 root 权限才能执行，可以采用只允许部署用户以 root 权限执行重载脚本的方式来避免出现安全问题。"]],["$","p",{},["在 ",["$","code",{},["/opt/hooks"]]," 目录下新建一个文件 ",["$","code",{},["reload-nginx.sh"]],"，内容如下："]],["$","pre",{},[["$","code",{"class":"hljs bash"},[["$","span",{"class":"hljs-meta"},["#!/bin/bash"]],"\nsudo systemctl force-reload nginx"]]]],["$","p",{},["然后新建一个名为 ",["$","code",{},["actions-cert"]]," 的用户，然后在 ",["$","code",{},["/etc/sudoers"]]," 文件中添加以下内容："]],["$","pre",{},[["$","code",{"class":"hljs arcade"},["actions-cert ",["$","span",{"class":"hljs-built_in"},["ALL"]],"=(",["$","span",{"class":"hljs-built_in"},["ALL"]],") NOPASSWD: ",["$","span",{"class":"hljs-regexp"},["/opt/"]],"hooks/reload-nginx.sh"]]]],["$","p",{},["这个配置可以使 ",["$","code",{},["actions-cert"]]," 用户免密码以 root 用户的权限执行 ",["$","code",{},["/opt/hooks/reload-nginx.sh"]],"。"]],["$","p",{},["最后使用 ",["$","code",{},["chmod 755 /opt/hooks/reload-nginx.sh"]]," 命令将 ",["$","code",{},["reload-nginx.sh"]]," 文件设置为可执行，同时禁止非所有者对其进行写入操作。"]],["$","p",{},["如果服务器位于 NAT 后，或者禁止了 SSH 连接，还有两个方法可以将证书部署到内网服务器上："]],["$","ol",{},[["$","li",{},["将证书先部署到有部署条件的服务器上，然后再在内网服务器上使用 rsync 从部署好的服务器上拉取证书。"]],["$","li",{},["将证书上传到 ",["$","a",{"href":"https://azure.microsoft.com/en-us/services/key-vault/","rel":"external nofollow noreferrer"},["Azure Key Vault"]]," 等托管服务中，再在服务器上按照 ",["$","a",{"href":"https://blog.men.ci/ssl-with-github-actions/#%E6%9C%8D%E5%8A%A1%E5%99%A8","rel":"external nofollow noreferrer"},["Menci 的文章"]]," 中的教程拉取即可。"]]]],["$","h3",{"id":"阿里云"},["阿里云"]],["$","p",{},["阿里云的 ",["$","a",{"href":"https://www.aliyun.com/product/cas","rel":"external nofollow noreferrer"},["SSL 证书服务"]]," 支持上传自定义证书，该证书可以用于 ",["$","a",{"href":"https://www.aliyun.com/product/cdn","rel":"external nofollow noreferrer"},["阿里云 CDN"]],"。阿里云暂未提供将证书部署至 OSS 的 API，建议 OSS 用户使用 CDN 回源 OSS 来代替。"]],["$","p",{},["使用 ",["$","a",{"href":"https://github.com/Menci/deploy-certificate-to-aliyun","rel":"external nofollow noreferrer"},["Menci/deploy-certificate-to-aliyun"]]," 将证书部署到阿里云："]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-comment"},["# 部署到阿里云"]],"\n",["$","span",{"class":"hljs-attr"},["deploy-to-aliyun:"]],"\n  ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Deploy"]]," ",["$","span",{"class":"hljs-string"},["Certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["Aliyun"]],"\n  ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n  ",["$","span",{"class":"hljs-attr"},["needs:"]]," ",["$","span",{"class":"hljs-string"},["issue-ssl-certificate"]],"\n\n  ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n    ",["$","span",{"class":"hljs-comment"},["# 拉取证书存储分支"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n\n    ",["$","span",{"class":"hljs-comment"},["# 上传证书"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Deploy"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["aliyun"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["Menci/deploy-certificate-to-aliyun@beta-v1"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-attr"},["access-key-id:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.ALIYUN_ACCESS_KEY_ID"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["access-key-secret:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.ALIYUN_ACCESS_KEY_SECRET"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["fullchain-file:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_FULLCHAIN"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["key-file:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["certificate-name:"]]," ",["$","span",{"class":"hljs-string"},["example.com"]],"\n        ",["$","span",{"class":"hljs-attr"},["cdn-domains:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          example.com"]],"\n",["$","span",{"class":"hljs-string"},["          example.net"]]]]]],["$","p",{},["其中 ",["$","code",{},["certificate-name"]]," 指定上传的证书在证书服务中的名称（将自动替换旧版本），",["$","code",{},["cdn-domains"]]," 指定需要将该证书部署到的 CDN 域名列表（用空白字符隔开）。"]],["$","p",{},["建议使用子账户 Access Key，为其赋予以下权限（并按需使用资源组隔离）："]],["$","ul",{},[["$","li",{},["AliyunYundunCertFullAccess"]],["$","li",{},["AliyunCDNFullAccess"]],["$","li",{},["AliyunPCDNFullAccess"]],["$","li",{},["AliyunSCDNFullAccess"]],["$","li",{},["AliyunDCDNFullAccess"]]]],["$","h3",{"id":"腾讯云"},["腾讯云"]],["$","p",{},["使用 ",["$","a",{"href":"https://github.com/renbaoshuo/deploy-certificate-to-tencentcloud","rel":"external nofollow noreferrer"},["renbaoshuo/deploy-certificate-to-tencentcloud"]]," 将证书部署至腾讯云 CDN："]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-attr"},["deploy-to-qcloud-cdn:"]],"\n  ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Deploy"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["Tencent"]]," ",["$","span",{"class":"hljs-string"},["Cloud"]]," ",["$","span",{"class":"hljs-string"},["CDN"]],"\n  ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n  ",["$","span",{"class":"hljs-attr"},["needs:"]]," ",["$","span",{"class":"hljs-string"},["issue-ssl-certificate"]],"\n\n  ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Check"]]," ",["$","span",{"class":"hljs-string"},["out"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-comment"},["# If you just commited and pushed your newly issued certificate to this repo in a previous job,"]],"\n        ",["$","span",{"class":"hljs-comment"},["# use `ref` to make sure checking out the newest commit in this job"]],"\n        ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["github.ref"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["renbaoshuo/deploy-certificate-to-tencentcloud@v1"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-comment"},["# Use Access Key"]],"\n        ",["$","span",{"class":"hljs-attr"},["secret-id:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.QCLOUD_SECRET_ID"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["secret-key:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.QCLOUD_SECRET_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n        ",["$","span",{"class":"hljs-comment"},["# Specify PEM fullchain file"]],"\n        ",["$","span",{"class":"hljs-attr"},["fullchain-file:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_FULLCHAIN"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-comment"},["# Specify PEM private key file"]],"\n        ",["$","span",{"class":"hljs-attr"},["key-file:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n        ",["$","span",{"class":"hljs-comment"},["# Deploy to CDN"]],"\n        ",["$","span",{"class":"hljs-attr"},["cdn-domains:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          cdn1.example.com"]],"\n",["$","span",{"class":"hljs-string"},["          cdn2.example.com"]]]]]],["$","p",{},["其中 ",["$","code",{},["cdn-domains"]]," 指定需要将该证书部署到的 CDN 域名列表（用空白字符隔开）。"]],["$","p",{},["建议使用子账户 API 密钥，为其赋予以下权限（并按需使用资源组隔离）："]],["$","ul",{},[["$","li",{},["QcloudCDNFullAccess"]]]],["$","h3",{"id":"自建-goedge-cdn"},["自建 GoEdge CDN"]],["$","p",{},["使用 ",["$","a",{"href":"https://github.com/renbaoshuo/deploy-certificate-to-goedge","rel":"external nofollow noreferrer"},[["$","code",{},["renbaoshuo/deploy-certificate-to-goedge"]]]]," 将证书部署至自建的 GoEdge CDN："]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-attr"},["deploy-to-goedge-cdn:"]],"\n  ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Deploy"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["GoEdge"]]," ",["$","span",{"class":"hljs-string"},["CDN"]],"\n  ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n  ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Check"]]," ",["$","span",{"class":"hljs-string"},["out"]],"\n      ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-comment"},["# If you just commited and pushed your newly issued certificate to this repo in a previous job,"]],"\n        ",["$","span",{"class":"hljs-comment"},["# use `ref` to make sure checking out the newest commit in this job"]],"\n        ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["github.ref"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["renbaoshuo/deploy-certificate-to-goedge@beta-v1"]],"\n      ",["$","span",{"class":"hljs-attr"},["with:"]],"\n        ",["$","span",{"class":"hljs-comment"},["# GoEdge API endpoint"]],"\n        ",["$","span",{"class":"hljs-attr"},["api-endpoint:"]]," ",["$","span",{"class":"hljs-string"},["https://cdn.api.baoshuo.dev"]],"\n\n        ",["$","span",{"class":"hljs-comment"},["# Use Access Key"]],"\n        ",["$","span",{"class":"hljs-attr"},["access-key-type:"]]," ",["$","span",{"class":"hljs-string"},["user"]],"\n        ",["$","span",{"class":"hljs-attr"},["access-key-id:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.GOEDGE_ACCESS_KEY_ID"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-attr"},["access-key:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.GOEDGE_ACCESS_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n        ",["$","span",{"class":"hljs-comment"},["# GoEdge certificate ID"]],"\n        ",["$","span",{"class":"hljs-attr"},["cert-id:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.GOEDGE_CERT_ID"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n        ",["$","span",{"class":"hljs-comment"},["# Specify PEM fullchain file"]],"\n        ",["$","span",{"class":"hljs-attr"},["fullchain-file:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_FULLCHAIN"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n        ",["$","span",{"class":"hljs-comment"},["# Specify PEM private key file"]],"\n        ",["$","span",{"class":"hljs-attr"},["key-file:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]]]]]],["$","p",{},[["$","em",{},["注：在部署前需要手动上传一次证书以便获取证书 ID。证书 ID 可以在「证书文件下载」处的 URL 参数中找到。"]]]],["$","h2",{"id":"完整例子"},["完整例子"]],["$","p",{},["这个 Action 完成了以下操作："]],["$","ol",{},[["$","li",{},["申请证书，并上传到仓库的 ",["$","code",{},["certs"]]," 分支。"]],["$","li",{},["在申请证书后将 ",["$","code",{},["certs"]]," 分支中的证书部署到服务器上。"]]]],["$","pre",{},[["$","code",{"class":"hljs yaml"},[["$","span",{"class":"hljs-comment"},["# 名称"]],"\n",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Issue"]]," ",["$","span",{"class":"hljs-string"},["SSL"]]," ",["$","span",{"class":"hljs-string"},["Certificates"]],"\n\n",["$","span",{"class":"hljs-comment"},["# 触发条件"]],"\n",["$","span",{"class":"hljs-attr"},["on:"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 手动运行"]],"\n  ",["$","span",{"class":"hljs-attr"},["workflow_dispatch:"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 定时运行"]],"\n  ",["$","span",{"class":"hljs-attr"},["schedule:"]],"\n    ",["$","span",{"class":"hljs-comment"},["# 每两个月运行一次"]],"\n    ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["cron:"]]," ",["$","span",{"class":"hljs-string"},["'0 0 1 */2 *'"]],"\n\n",["$","span",{"class":"hljs-comment"},["# 全局环境变量"]],"\n",["$","span",{"class":"hljs-attr"},["env:"]],"\n  ",["$","span",{"class":"hljs-comment"},["# Checkout 到的目录"]],"\n  ",["$","span",{"class":"hljs-attr"},["CERTS_OUTPUT_BASE:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 证书输出目录"]],"\n  ",["$","span",{"class":"hljs-attr"},["CERTS_OUTPUT_DIRECTORY:"]]," ",["$","span",{"class":"hljs-string"},["example.com"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 证书文件名"]],"\n  ",["$","span",{"class":"hljs-attr"},["FILE_FULLCHAIN:"]]," ",["$","span",{"class":"hljs-string"},["fullchain.pem"]],"\n  ",["$","span",{"class":"hljs-comment"},["# 私钥文件名"]],"\n  ",["$","span",{"class":"hljs-attr"},["FILE_KEY:"]]," ",["$","span",{"class":"hljs-string"},["privatekey.key"]],"\n\n",["$","span",{"class":"hljs-attr"},["jobs:"]],"\n  ",["$","span",{"class":"hljs-attr"},["issue-ssl-certificate:"]],"\n    ",["$","span",{"class":"hljs-comment"},["# 申请证书并 push 到 certs 分支"]],"\n    ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Issue"]]," ",["$","span",{"class":"hljs-string"},["SSL"]]," ",["$","span",{"class":"hljs-string"},["certificate"]],"\n    ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n    ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["master"]],"\n\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]]," ",["$","span",{"class":"hljs-string"},["output"]]," ",["$","span",{"class":"hljs-string"},["branch"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n          ",["$","span",{"class":"hljs-attr"},["path:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 安装 acme.sh"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Install"]]," ",["$","span",{"class":"hljs-string"},["acme.sh"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["curl"]]," ",["$","span",{"class":"hljs-string"},["-s"]]," ",["$","span",{"class":"hljs-string"},["https://get.acme.sh"]]," ",["$","span",{"class":"hljs-string"},["|"]]," ",["$","span",{"class":"hljs-string"},["sh"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 解压 acme.sh 配置信息"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Extract"]]," ",["$","span",{"class":"hljs-string"},["account"]]," ",["$","span",{"class":"hljs-string"},["files"]]," ",["$","span",{"class":"hljs-string"},["for"]]," ",["$","span",{"class":"hljs-string"},["acme.sh"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          echo \"$ACME_SH_ACCOUNT_TAR\" | base64 -d | tar -C ~/.acme.sh -xz"]],"\n",["$","span",{"class":"hljs-string"},[]],"        ",["$","span",{"class":"hljs-attr"},["env:"]],"\n          ",["$","span",{"class":"hljs-comment"},["# Base64 编码的 acme.sh 配置信息"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_ACCOUNT_TAR:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.ACME_SH_ACCOUNT_TAR"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 申请证书"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Issue"]]," ",["$","span",{"class":"hljs-string"},["SSL"]]," ",["$","span",{"class":"hljs-string"},["certificates"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          ~/.acme.sh/acme.sh --issue            \\"]],"\n",["$","span",{"class":"hljs-string"},["            -d \"example.com\" -d \"*.example.com\" \\"]],"\n",["$","span",{"class":"hljs-string"},["            --dns dns_cf --server letsencrypt"]],"\n",["$","span",{"class":"hljs-string"},[]],"\n      ",["$","span",{"class":"hljs-comment"},["# 导出证书"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Copy"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["output"]]," ",["$","span",{"class":"hljs-string"},["paths"]],"\n        ",["$","span",{"class":"hljs-attr"},["shell:"]]," ",["$","span",{"class":"hljs-string"},["bash"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          ACME_SH_TEMP_DIR=\"$(mktemp -d)\""]],"\n",["$","span",{"class":"hljs-string"},["          ACME_SH_TEMP_FILE_FULLCHAIN=\"$ACME_SH_TEMP_DIR/fullchain.pem\""]],"\n",["$","span",{"class":"hljs-string"},["          ACME_SH_TEMP_FILE_KEY=\"$ACME_SH_TEMP_DIR/key.pem\""]],"\n",["$","span",{"class":"hljs-string"},[]],"\n          ",["$","span",{"class":"hljs-comment"},["# 不要忘记修改这里的 -d 参数值为上方的第一个域名"]],"\n          ",["$","span",{"class":"hljs-string"},["~/.acme.sh/acme.sh"]]," ",["$","span",{"class":"hljs-string"},["--install-cert"]]," ",["$","span",{"class":"hljs-string"},["-d"]]," ",["$","span",{"class":"hljs-string"},["\"example.com\""]]," ",["$","span",{"class":"hljs-string"},["--fullchain-file"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_FULLCHAIN\""]]," ",["$","span",{"class":"hljs-string"},["--key-file"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_KEY\""]],"\n\n          [[ ",["$","span",{"class":"hljs-string"},["-z"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_FULLCHAIN\""]]," ]] ",["$","span",{"class":"hljs-string"},["||"]]," ",["$","span",{"class":"hljs-string"},["(mkdir"]]," ",["$","span",{"class":"hljs-string"},["-p"]]," ",["$","span",{"class":"hljs-string"},["\"$(dirname \""]],["$","span",{"class":"hljs-string"},["$ACME_SH_OUTPUT_FULLCHAIN\")\""]]," ",["$","span",{"class":"hljs-string"},["\u0026\u0026"]]," ",["$","span",{"class":"hljs-string"},["cp"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_FULLCHAIN\""]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_FULLCHAIN\""]],["$","span",{"class":"hljs-string"},[")"]],"\n          [[ ",["$","span",{"class":"hljs-string"},["-z"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_KEY\""]]," ]] ",["$","span",{"class":"hljs-string"},["||"]]," ",["$","span",{"class":"hljs-string"},["(mkdir"]]," ",["$","span",{"class":"hljs-string"},["-p"]]," ",["$","span",{"class":"hljs-string"},["\"$(dirname \""]],["$","span",{"class":"hljs-string"},["$ACME_SH_OUTPUT_KEY\")\""]]," ",["$","span",{"class":"hljs-string"},["\u0026\u0026"]]," ",["$","span",{"class":"hljs-string"},["cp"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_FILE_KEY\""]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_OUTPUT_KEY\""]],["$","span",{"class":"hljs-string"},[")"]],"\n\n          ",["$","span",{"class":"hljs-string"},["rm"]]," ",["$","span",{"class":"hljs-string"},["-rf"]]," ",["$","span",{"class":"hljs-string"},["\"$ACME_SH_TEMP_DIR\""]],"\n        ",["$","span",{"class":"hljs-attr"},["env:"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_OUTPUT_FULLCHAIN:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_FULLCHAIN"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["ACME_SH_OUTPUT_KEY:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.FILE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 上传证书"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Push"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["GitHub"]],"\n        ",["$","span",{"class":"hljs-attr"},["run:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n",["$","span",{"class":"hljs-string"},["          git config --global user.name \"BaoshuoBot\""]],"\n",["$","span",{"class":"hljs-string"},["          git config --global user.email \"79077260+BaoshuoBot@users.noreply.github.com\""]],"\n",["$","span",{"class":"hljs-string"},[]],"\n          ",["$","span",{"class":"hljs-string"},["cd"]]," ",["$","span",{"class":"hljs-string"},["\"$CERTS_DIRECTORY\""]],"\n\n          ",["$","span",{"class":"hljs-string"},["git"]]," ",["$","span",{"class":"hljs-string"},["add"]]," ",["$","span",{"class":"hljs-string"},["\"$FILE_FULLCHAIN\""]]," ",["$","span",{"class":"hljs-string"},["\"$FILE_KEY\""]],"\n          ",["$","span",{"class":"hljs-string"},["git"]]," ",["$","span",{"class":"hljs-string"},["commit"]]," ",["$","span",{"class":"hljs-string"},["-m"]]," ",["$","span",{"class":"hljs-string"},["\"Upload certificates on $(date '+%Y-%m-%d %H:%M:%S')\""]],"\n          ",["$","span",{"class":"hljs-string"},["git"]]," ",["$","span",{"class":"hljs-string"},["push"]],"\n        ",["$","span",{"class":"hljs-attr"},["env:"]],"\n          ",["$","span",{"class":"hljs-attr"},["TZ:"]]," ",["$","span",{"class":"hljs-string"},["Asia/Shanghai"]],"\n          ",["$","span",{"class":"hljs-attr"},["CERTS_DIRECTORY:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_BASE"]]," ",["$","span",{"class":"hljs-string"},["}}/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n\n  ",["$","span",{"class":"hljs-comment"},["# 部署证书到服务器"]],"\n  ",["$","span",{"class":"hljs-attr"},["deploy-to-server:"]],"\n    ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Deploy"]]," ",["$","span",{"class":"hljs-string"},["Certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["Server"]],"\n    ",["$","span",{"class":"hljs-attr"},["runs-on:"]]," ",["$","span",{"class":"hljs-string"},["ubuntu-latest"]],"\n    ",["$","span",{"class":"hljs-attr"},["needs:"]]," ",["$","span",{"class":"hljs-string"},["issue-ssl-certificate"]],"\n\n    ",["$","span",{"class":"hljs-attr"},["strategy:"]],"\n      ",["$","span",{"class":"hljs-attr"},["matrix:"]],"\n        ",["$","span",{"class":"hljs-attr"},["host:"]],"\n          ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-number"},["174.136"]],["$","span",{"class":"hljs-number"},[".239"]],["$","span",{"class":"hljs-number"},[".1"]]," ",["$","span",{"class":"hljs-comment"},["# Server 1"]],"\n          ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-number"},["174.136"]],["$","span",{"class":"hljs-number"},[".239"]],["$","span",{"class":"hljs-number"},[".2"]]," ",["$","span",{"class":"hljs-comment"},["# Server 2"]],"\n          ",["$","span",{"class":"hljs-comment"},["# ..."]],"\n          ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-number"},["174.136"]],["$","span",{"class":"hljs-number"},[".239"]],["$","span",{"class":"hljs-number"},[".254"]]," ",["$","span",{"class":"hljs-comment"},["# Server N"]],"\n\n    ",["$","span",{"class":"hljs-attr"},["steps:"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Checkout"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["actions/checkout@v2"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-attr"},["ref:"]]," ",["$","span",{"class":"hljs-string"},["certs"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 上传证书"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Upload"]]," ",["$","span",{"class":"hljs-string"},["certificate"]]," ",["$","span",{"class":"hljs-string"},["to"]]," ",["$","span",{"class":"hljs-string"},["server"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["easingthemes/ssh-deploy@v2.1.5"]],"\n        ",["$","span",{"class":"hljs-attr"},["env:"]],"\n          ",["$","span",{"class":"hljs-attr"},["SSH_PRIVATE_KEY:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.SSH_PRIVATE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["ARGS:"]]," ",["$","span",{"class":"hljs-string"},["'-avz --delete'"]],"\n          ",["$","span",{"class":"hljs-attr"},["REMOTE_HOST:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["matrix.host"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["REMOTE_USER:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.REMOTE_USER"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["SOURCE:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/"]],"\n          ",["$","span",{"class":"hljs-attr"},["TARGET:"]]," ",["$","span",{"class":"hljs-string"},["/path/to/ssl/certs/${{"]]," ",["$","span",{"class":"hljs-string"},["env.CERTS_OUTPUT_DIRECTORY"]]," ",["$","span",{"class":"hljs-string"},["}}/"]],"\n\n      ",["$","span",{"class":"hljs-comment"},["# 重载 Nginx"]],"\n      ",["$","span",{"class":"hljs-bullet"},["-"]]," ",["$","span",{"class":"hljs-attr"},["name:"]]," ",["$","span",{"class":"hljs-string"},["Force-reload"]]," ",["$","span",{"class":"hljs-string"},["nginx"]],"\n        ",["$","span",{"class":"hljs-attr"},["uses:"]]," ",["$","span",{"class":"hljs-string"},["appleboy/ssh-action@v0.1.4"]],"\n        ",["$","span",{"class":"hljs-attr"},["with:"]],"\n          ",["$","span",{"class":"hljs-attr"},["host:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["matrix.host"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["username:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.REMOTE_USER"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["key:"]]," ",["$","span",{"class":"hljs-string"},["${{"]]," ",["$","span",{"class":"hljs-string"},["secrets.SSH_PRIVATE_KEY"]]," ",["$","span",{"class":"hljs-string"},["}}"]],"\n          ",["$","span",{"class":"hljs-attr"},["script:"]]," ",["$","span",{"class":"hljs-string"},["|"]],"\n            ",["$","span",{"class":"hljs-string"},["sudo"]]," ",["$","span",{"class":"hljs-string"},["/opt/hooks/reload-nginx.sh"]]]]]],["$","h2",{"id":"杂项"},["杂项"]],["$","p",{},["部分情况下，GitHub Actions 中的 ",["$","code",{},["GITHUB_TOKEN"]]," 只有 Read repository contents permission，而本文中的 Actions 要求这个 Token 具有 Read and write permissions，那么需要在仓库的 Settings \u003e Actions \u003e General 页面的底部赋予其写入权限，如图所示："]],["$","p",{},[["$","img",{"src":"https://s1.baoshuo.ren/2022/05/15/WA5tTau3mnBLIqZ.png","alt":"","loading":"lazy"},[]]]],["$","p",{},["设置好后点击 Save 按钮即可。"]],["$","h2",{"id":"参考资料"},["参考资料"]],["$","ol",{},[["$","li",{},[["$","a",{"href":"https://blog.men.ci/ssl-with-github-actions/","rel":"external nofollow noreferrer"},["使用 GitHub Actions 自动申请与部署 ACME SSL 证书"]],"，Menci，2022 年 5 月 11 日。对原文章内容的使用已经过作者同意。"]],["$","li",{},[["$","a",{"href":"https://u.sb/acme-sh-ssl/","rel":"external nofollow noreferrer"},["使用 acme.sh 配置自动续签 SSL 证书"]],"，烧饼博客，2022 年 2 月 3 日。"]]]],["$","p",{},["文章头图由 ",["$","a",{"href":"https://men.ci","rel":"external nofollow noreferrer"},["Menci"]]," 制作，使用已经过授权，在此表示感谢。"]]],"thumb":"https://s1.baoshuo.ren/2022/05/13/lj2cs5QNP3rWkeq.png","date":"2022-05-15","updated":"2022-12-18","isoDate":"2022-05-15T08:47:00.000Z","isoUpdate":"2022-12-18T08:29:55.000Z","categories":[{"name":"技术向","url":"/categories/%E6%8A%80%E6%9C%AF%E5%90%91/"}],"tags":[{"name":"SSL","url":"/tags/SSL/"},{"name":"GitHub Actions","url":"/tags/GitHub-Actions/"},{"name":"ACME","url":"/tags/ACME/"},{"name":"阿里云","url":"/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"}],"license":null,"permalink":"https://blog.baoshuo.ren/post/actions-ssl-cert/","url":"/post/actions-ssl-cert/","prev":{"title":"拥抱 Atomic CSS-in-JS","url":"/post/atomic-css-in-js/"},"next":{"title":"强制卸载三星应用分身中的残留应用","url":"/post/uninstall-samsung-extra-dual-app/"},"toc":{"0":{"0":{"text":"前期准备","id":"前期准备"},"1":{"text":"自动化","id":"自动化"},"2":{"text":"上传证书至仓库","id":"上传证书至仓库"},"text":"申请证书","id":"申请证书"},"1":{"0":{"text":"服务器","id":"服务器"},"1":{"text":"阿里云","id":"阿里云"},"2":{"text":"腾讯云","id":"腾讯云"},"3":{"text":"自建 GoEdge CDN","id":"自建-goedge-cdn"},"text":"部署证书","id":"部署证书"},"2":{"text":"完整例子","id":"完整例子"},"3":{"text":"杂项","id":"杂项"},"4":{"text":"参考资料","id":"参考资料"}},"hasToc":true,"comments":true,"wordCount":"约 3.1 千字"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"actions-ssl-cert"},"buildId":"k90Ni_4Pr-FWD9VknAbFR","assetPrefix":"https://static.cdn.baoshuo.ren/blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>